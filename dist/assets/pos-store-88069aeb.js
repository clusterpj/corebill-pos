import{R as P,n as o,a9 as S,a5 as A,o as T}from"./index-9f2fee20.js";import{a as O,O as C,P as b,u as G,e as $}from"./cart-store-98b500d5.js";import{r as u,j as w}from"./vuetify-7130618d.js";const M=()=>{const e=u({categories:!1,products:!1,stores:!1,cashiers:!1,employees:!1,itemOperation:!1,holdInvoices:!1,conversion:!1,updating:!1}),n=u(null),i=u([]),v=u([]),g=u("all"),p=u(""),h=u(1),y=u(20),m=u(0),s=u([]),c=u([]),f=u([]),t=u([]),r=u(null),a=u(null),d=u(""),l=u(null),_=u(!1),I=u({template_id:1,print_settings:{print_pdf:!1,is_invoice_pos:1,is_pdf_pos:!0},avalara_bool:!1,banType:!0,invoice_pbx_modify:0,taxes:{},packages:[]});return{loading:e,error:n,categories:i,products:v,selectedCategory:g,searchQuery:p,currentPage:h,itemsPerPage:y,totalItems:m,stores:s,cashiers:c,employees:f,holdInvoices:t,activeOrderType:r,selectedTable:a,orderReference:d,customerInfo:l,isTableMode:_,holdInvoiceSettings:I}},F={async getAllSections(e="all"){var n;try{const i=await P.get("/v1/core-pos/sections",{params:{limit:e}});return o.debug("[SectionAPI] Fetched all sections:",i.data),((n=i.data)==null?void 0:n.sections)||[]}catch(i){throw S.handleApi(i,"[SectionAPI] getAllSections")}},async getSectionsForItem(e){var n;try{const i=await P.get(`/v1/core-pos/sections/getsections/${e}`);return o.debug(`[SectionAPI] Raw response for item ${e}:`,i.data),((n=i.data)==null?void 0:n.sections)||[]}catch(i){throw S.handleApi(i,`[SectionAPI] getSectionsForItem(${e})`)}},async getItemsForSection(e){var n;try{const i=await P.get(`/v1/core-pos/sections/getitems/${e}`);return o.debug(`[SectionAPI] Items for section ${e}:`,i.data),((n=i.data)==null?void 0:n.data)||[]}catch(i){throw S.handleApi(i,`[SectionAPI] getItemsForSection(${e})`)}}},D=(e,n,i)=>{const v=async()=>{if(!i.isConfigured){o.warn("Company configuration incomplete, skipping categories fetch");return}o.startGroup("POS Store: Fetch Categories"),e.loading.value.categories=!0,e.error.value=null;try{const s=await n.getItemCategories();s.success?(e.categories.value=Array.isArray(s.data)?s.data:[],o.info(`Loaded ${e.categories.value.length} categories`),e.categories.value.length>0?(o.info("Categories loaded, fetching products"),await g()):o.warn("No categories available")):(o.warn("Failed to load categories",s.error),e.categories.value=[])}catch(s){o.error("Failed to fetch categories",s),e.error.value=s.message||"Failed to load categories",e.categories.value=[]}finally{e.loading.value.categories=!1,o.endGroup()}},g=async()=>{var s;if(!i.isConfigured){o.warn("Company configuration incomplete, skipping products fetch");return}o.startGroup("POS Store: Fetch Products"),e.loading.value.products=!0,e.error.value=null;try{o.debug("[Products] Fetching all sections");const c=await F.getAllSections("all");o.debug("[Products] All sections:",c);const f={};c.forEach(d=>{f[d.id]=d});const t=e.selectedCategory.value==="all"?e.categories.value.map(d=>d.item_category_id):[e.selectedCategory.value],r={search:e.searchQuery.value,categories_id:t,avalara_bool:!1,is_pos:1,id:i.selectedStore,limit:e.itemsPerPage.value,page:e.currentPage.value,sku:e.searchQuery.value};o.debug("[Products] Fetch products params:",r);const a=await n.getItems(r);if((s=a.items)!=null&&s.data){const d=Array.isArray(a.items.data)?a.items.data:[];await Promise.all(d.map(async l=>{try{o.debug(`[Products] Fetching sections for product ${l.id}`);const _=await F.getSectionsForItem(l.id);if(o.debug(`[Products] Received sections for product ${l.id}:`,_),_&&_.length>0){const I=_[0];o.debug(`[Products] Using section for product ${l.id}:`,I),I&&I.id?(Object.assign(l,{section_id:I.id,section_type:"bar",section_name:I.name}),I.name.toUpperCase()==="BAR"?l.section_type="bar":I.name.toUpperCase()==="KITCHEN"&&(l.section_type="kitchen"),o.debug(`[Products] Updated product ${l.id} with section:`,{id:l.id,name:l.name,section:{id:l.section_id,type:l.section_type,name:l.section_name}})):(o.debug(`[Products] Invalid section data for product ${l.id}`),p(l))}else o.debug(`[Products] No sections found for product ${l.id}`),p(l)}catch(_){o.error(`[Products] Failed to fetch section for product ${l.id}:`,_),p(l)}})),e.sectionsMap=f,e.products.value=d,e.totalItems.value=a.itemTotalCount||0,o.info(`[Products] Loaded ${d.length} products with section information`)}else o.warn("No products data in response",a),e.products.value=[],e.totalItems.value=0}catch(c){o.error("Failed to fetch products",c),e.error.value=c.message||"Failed to load products",e.products.value=[],e.totalItems.value=0}finally{e.loading.value.products=!1,o.endGroup()}},p=s=>{Object.assign(s,{section_id:null,section_type:"other",section_name:"Default"}),o.debug(`[Products] Set default section for product ${s.id}`)};return{fetchCategories:v,fetchProducts:g,setCategory:async s=>{e.selectedCategory.value=s,e.currentPage.value=1,await g()},createItem:async s=>{o.startGroup("POS Store: Create Item"),e.loading.value.itemOperation=!0,e.error.value=null;try{const c=await n.createItem(s);return o.info("Item created successfully:",c),await g(),c}catch(c){throw o.error("Failed to create item:",c),e.error.value=c.message,c}finally{e.loading.value.itemOperation=!1,o.endGroup()}},updateItem:async(s,c)=>{o.startGroup("POS Store: Update Item"),e.loading.value.itemOperation=!0,e.error.value=null;try{const f=await n.updateItem(s,c);return o.info("Item updated successfully:",f),await g(),f}catch(f){throw o.error("Failed to update item:",f),e.error.value=f.message,f}finally{e.loading.value.itemOperation=!1,o.endGroup()}}}},H="core_pos_hold_invoices",E=(e,n,i)=>{e.currentHoldInvoiceId=null,e.currentHoldInvoiceDescription=null;const v=()=>{try{const t=localStorage.getItem(H);t&&(e.holdInvoices.value=JSON.parse(t),o.info("Initialized hold invoices from localStorage:",e.holdInvoices.value.length))}catch(t){o.error("Failed to initialize hold invoices from localStorage:",t)}},g=()=>{try{localStorage.setItem(H,JSON.stringify(e.holdInvoices.value)),o.debug("Persisted hold invoices to localStorage")}catch(t){o.error("Failed to persist hold invoices to localStorage:",t)}},p=t=>{const a=["items","total","sub_total","due_amount","user_id","store_id","cash_register_id","type","paid_status"].filter(d=>!t[d]);if(a.length)throw new Error(`Missing required fields: ${a.join(", ")}`);if(!Array.isArray(t.items)||!t.items.length)throw new Error("Items array is required and must not be empty");if(t.items.forEach((d,l)=>{if(!d.price||!d.quantity)throw new Error(`Invalid item at index ${l}: missing price or quantity`)}),!Object.values(C).includes(t.type))throw new Error(`Invalid order type: ${t.type}. Must be one of: ${Object.values(C).join(", ")}`);if(!Object.values(O).includes(t.paid_status))throw new Error(`Invalid paid status: ${t.paid_status}. Must be either PAID or UNPAID`)},h=t=>{const{holdInvoiceSettings:r}=e,a=new Date,d=new Date(a.getTime()+7*24*60*60*1e3);return{...t,...r.value.print_settings,avalara_bool:r.value.avalara_bool,invoice_template_id:r.value.template_id,banType:r.value.banType,invoice_pbx_modify:r.value.invoice_pbx_modify,taxes:r.value.taxes,packages:r.value.packages,invoice_date:a.toISOString().split("T")[0],due_date:d.toISOString().split("T")[0],items:t.items.map(l=>({...l,price:b.ensureCents(l.price),total:b.ensureCents(l.total),unit_name:l.unit_name||"N/A",discount_type:"fixed",discount:"0.00",discount_val:0,sub_total:b.ensureCents(l.total)}))}},y=async t=>{o.startGroup("Orders Module: Hold Order"),e.loading.value.holdInvoices=!0,e.error.value=null;try{p(t);const r=h(t);o.debug("Holding order with data:",r);const a=await n.holdInvoice.create(r);if(a.success)return await c(),o.info("Order held successfully:",a.data),{success:!0,data:a.data};throw new Error(a.message||"Failed to hold order")}catch(r){return o.error("Failed to hold order:",r),e.error.value=r.message,{success:!1,error:r.message}}finally{e.loading.value.holdInvoices=!1,o.endGroup()}},m=async(t,r)=>{o.startGroup("Orders Module: Update Hold Invoice"),e.loading.value.holdInvoices=!0,e.error.value=null;try{if(!t)throw new Error("Order description is required for update");p(r);const a=h(r);o.debug("Updating hold invoice with data:",a);const d=await n.holdInvoice.update(t,{...a,print_pdf:!1,is_invoice_pos:1,is_pdf_pos:!0,send_email:!1,save_as_draft:!1,not_charge_automatically:!1,package_bool:!1,invoice_number:"-",discount_per_item:"NO",tip_type:null,tip:0,tip_val:0,tables_selected:[],is_hold_invoice:!0});if(d.success)return await c(),o.info("Hold invoice updated successfully:",d.data),{success:!0,data:d.data};throw new Error(d.message||"Failed to update hold invoice")}catch(a){return o.error("Failed to update hold invoice:",a),e.error.value=a.message,{success:!1,error:a.message}}finally{e.loading.value.holdInvoices=!1,o.endGroup()}},s=async(t,r)=>{o.startGroup("Orders Module: Update Hold Invoice Paid Status"),e.loading.value.holdInvoices=!0,e.error.value=null;try{if(!t)throw new Error("Invoice ID is required");if(!Object.values(O).includes(r))throw new Error(`Invalid paid status: ${r}. Must be either PAID or UNPAID`);const a=await n.holdInvoice.updatePaidStatus(t,r);if(a.success)return await c(),o.info("Hold invoice paid status updated successfully:",{id:t,paidStatus:r}),{success:!0,data:a.data};throw new Error(a.message||"Failed to update hold invoice paid status")}catch(a){return o.error("Failed to update hold invoice paid status:",a),e.error.value=a.message,{success:!1,error:a.message}}finally{e.loading.value.holdInvoices=!1,o.endGroup()}},c=async()=>{var t;o.startGroup("Orders Module: Fetch Hold Invoices"),e.loading.value.holdInvoices=!0,e.error.value=null;try{const r=await n.holdInvoice.getAll();if(r.success&&((t=r.data)!=null&&t.hold_invoices))return e.holdInvoices.value=r.data.hold_invoices.data||[],g(),o.info("Hold invoices fetched successfully:",e.holdInvoices.value.length),{success:!0,data:e.holdInvoices.value};throw new Error(r.message||"Failed to fetch hold invoices")}catch(r){return o.error("Failed to fetch hold invoices:",r),e.error.value=r.message,{success:!1,error:r.message}}finally{e.loading.value.holdInvoices=!1,o.endGroup()}},f=async t=>{o.startGroup("Orders Module: Delete Hold Invoice"),e.loading.value.holdInvoices=!0,e.error.value=null;try{const r=await n.holdInvoice.delete(t);if(r.success)return await c(),o.info("Hold invoice deleted successfully:",t),{success:!0};throw new Error(r.message||"Failed to delete hold invoice")}catch(r){return o.error("Failed to delete hold invoice:",r),e.error.value=r.message,{success:!1,error:r.message}}finally{e.loading.value.holdInvoices=!1,o.endGroup()}};return v(),{holdOrder:y,updateHoldInvoice:m,updateHoldInvoicePaidStatus:s,fetchHoldInvoices:c,deleteHoldInvoice:f,setHoldInvoiceId(t){e.currentHoldInvoiceId=t},setHoldInvoiceDescription(t){e.currentHoldInvoiceDescription=t},clearHoldInvoice(){e.currentHoldInvoiceId=null,e.currentHoldInvoiceDescription=null}}},R=(e,n,i)=>{const v=w(()=>n.items.length>0),g=w(()=>v.value&&e.activeOrderType.value),p=w(()=>[{id:"all",name:"All Categories",value:"all"},...(e.categories.value||[]).map(m=>({id:m.item_category_id,name:m.name,value:m.item_category_id}))]),h=w(()=>i.isConfigured),y=w(()=>i.selectedCustomer?i.selectedStore?i.selectedCashier?"":"Please select a cash register":"Please select a store":"Please select a customer");return{hasActiveOrder:v,canPlaceOrder:g,categoriesForDisplay:p,systemReady:h,setupMessage:y}},U=(e,n)=>({setOrderType:s=>{e.activeOrderType.value=s},setTableSelection:s=>{e.selectedTable.value=s},setOrderReference:s=>{e.orderReference.value=s},setCustomerInfo:s=>{e.customerInfo.value=s},toggleTableMode:s=>{e.isTableMode.value=s},resetOrder:()=>{n.clearCart(),e.activeOrderType.value=null,e.selectedTable.value=null,e.orderReference.value="",e.customerInfo.value=null},resetState:()=>{e.categories.value=[],e.products.value=[],e.selectedCategory.value="all",e.searchQuery.value="",e.currentPage.value=1,e.totalItems.value=0,e.error.value=null,e.holdInvoices.value=[]}}),z=A("pos",()=>{const e=G(),n=T(),i=$(),v=M(),g=D(v,i,n),p=E(v,i),h=R(v,e,n),y=U(v,e);return{...v,...h,initialize:async()=>{o.startGroup("POS Store: Initialize");try{await n.initializeStore(),await g.fetchCategories(),await p.fetchHoldInvoices(),o.info("POS Store initialized successfully")}catch(s){throw o.error("Failed to initialize POS store",s),s}finally{o.endGroup()}},...y,...g,...p}});export{z as u};
//# sourceMappingURL=pos-store-88069aeb.js.map
