import{_ as Te,q as St,m as Q,M as Ra,H as vt,p as ut,j as Se,v as bt,e as Pe,z as ft,h as ke,w as st,x as Ne,y as ze,P as Rt,n as s,Q as ct,R as Ue,S as La,g as le,T as Je,U as Xe,G as lt,N as wa,t as Ia,F as zt,C as Pa,B as qa,E as ta,W as $t,X as Ma,Y as ja,l as at,c as de,d as ae,V as ot,o as rt,L as Pt,Z as ea,$ as aa,K as Ga,a0 as Ha,a1 as Ba,a2 as Yt,a3 as Ka,i as Ya,A as oa,r as Nt,a4 as sa,a5 as Ca,s as da,a6 as Oa,b as Qa,a7 as Wa,u as Ja,a as Xa,O as Za,a8 as eo}from"./index-9f2fee20.js";import{P as se,u as He,o as Qt,a as mt,O as Ae,p as yt,b as tt,d as kt}from"./cart-store-98b500d5.js";import{w as we,j as te,L as $,bg as ee,F as e,N as t,X as xe,bk as Ye,M as re,bm as je,bj as l,bh as A,r as D,u as F,be as S,bl as ve,a as Et,H as wt,aL as Sa,c4 as to,c5 as ao,a5 as pt,c6 as oo,bi as Ct,ak as ra,ao as so,T as Lt,bU as xa,d as ht,c1 as ro,c2 as lo}from"./vuetify-7130618d.js";import{u as gt}from"./pos-store-88069aeb.js";class no{static async openCustomerDisplay(){try{let o=0,r=0,i=1024,d=768;if(window.screen&&typeof window.screen.getScreens=="function"){const m=(await window.screen.getScreens())[1];m&&(o=m.availLeft||m.left||0,r=m.availTop||m.top||0,i=m.availWidth||m.width||1024,d=m.availHeight||m.height||768)}else window.screen&&(i=window.screen.width,d=window.screen.height,o=i);const b=window.open("/customer-display","customerDisplay",`width=${i},height=${d},left=${o},top=${r},menubar=no,toolbar=no,location=no,status=no,fullscreen=yes`);return b&&(b.moveTo(o,r),b.resizeTo(i,d)),b}catch(o){return console.error("Error opening customer display:",o),window.open("/customer-display","customerDisplay","menubar=no,toolbar=no,location=no,status=no,fullscreen=yes")}}}const io={class:"d-flex align-center w-100 gap-2"},uo={class:"quantity-badge"},co={class:"item-info flex-grow-1 min-width-0"},mo={class:"item-name text-body-2 font-weight-medium text-truncate"},po={class:"item-price text-caption text-grey-darken-1"},fo={class:"d-flex align-center gap-1"},vo={class:"item-total text-body-2 font-weight-medium"},yo={class:"action-buttons d-flex"},go={__name:"CartItemList",props:{items:{type:Array,required:!0}},emits:["edit","remove","updateQuantity"],setup(a,{emit:o}){const r=a,i=o;console.log("CartItemList - Initial cart state:",{itemCount:r.items.length,items:r.items.map(m=>({id:m.id,name:m.name,price:m.price,quantity:m.quantity,total:m.price*m.quantity}))}),we(()=>r.items,(m,I)=>{console.log("CartItemList - Cart items changed:",{oldCount:(I==null?void 0:I.length)||0,newCount:m.length,items:m.map(c=>({id:c.id,name:c.name,price:c.price,formatted_price:se.format(c.price),quantity:c.quantity,total:c.price*c.quantity,formatted_total:se.format(c.price*c.quantity)}))})},{deep:!0});const d=m=>(console.log("CartItemList - Formatting price:",{inputCents:m,isDollarAmount:se.isInDollars(m)}),se.format(m));te(()=>{const m=r.items.reduce((I,c)=>{const u=c.price*c.quantity;return console.log("CartItemList - Calculating item total:",{itemId:c.id,price:c.price,quantity:c.quantity,itemTotal:u}),I+u},0);return console.log("CartItemList - Cart total calculated:",{itemCount:r.items.length,total:m,formattedTotal:se.format(m)}),m});const b=(m,I,c)=>{console.log("CartItemList - Updating quantity:",{itemId:m,index:c,oldQuantity:r.items[c].quantity,newQuantity:I,price:r.items[c].price,oldTotal:r.items[c].price*r.items[c].quantity,newTotal:r.items[c].price*I}),i("updateQuantity",m,I,c)},f=(m,I)=>{console.log("CartItemList - Removing item:",{itemId:m,index:I,item:r.items[I]}),i("remove",m,I)};return(m,I)=>($(),ee("div",{class:je(["cart-items",m.$attrs.class])},[e(Ra,{class:"cart-list pa-0",density:"compact"},{default:t(()=>[($(!0),ee(xe,null,Ye(a.items,(c,u)=>($(),re(St,{key:u,class:je(["cart-item py-1",{"border-b":u!==a.items.length-1}])},{default:t(()=>[l("div",io,[l("div",uo,A(c.quantity),1),l("div",co,[l("div",mo,A(c.name),1),l("div",po,A(d(c.price))+" each ",1)]),l("div",fo,[l("span",vo,A(d(c.price*c.quantity)),1),l("div",yo,[e(Q,{icon:"mdi-minus",size:"small",variant:"tonal",density:"comfortable",color:"primary",disabled:c.quantity<=1,onClick:g=>b(c.id,Math.max(0,c.quantity-1),u),class:"touch-btn"},null,8,["disabled","onClick"]),e(Q,{icon:"mdi-plus",size:"small",variant:"tonal",density:"comfortable",color:"primary",onClick:g=>b(c.id,c.quantity+1,u),class:"touch-btn"},null,8,["onClick"]),e(Q,{icon:"mdi-delete",size:"small",variant:"tonal",density:"comfortable",color:"error",onClick:g=>f(c.id,u),class:"touch-btn"},null,8,["onClick"])])])])]),_:2},1032,["class"]))),128))]),_:1})],2))}},_o=Te(go,[["__scopeId","data-v-06c2a156"]]);function bo(){const a=He(),o=D(a.$state.discountType),r=D(a.$state.discountValue);return we(()=>a.$state.discountType,d=>{o.value=d}),we(()=>a.$state.discountValue,d=>{r.value=d}),{discountType:o,discountValue:r,updateDiscount:()=>{const d=o.value==="$"?"fixed":o.value,b=Number(r.value)||0;a.setDiscount(d,b)}}}const ho={class:"order-summary"},wo={class:"summary-row"},Io={class:"amount"},Po={class:"discount-section"},Co={class:"discount-header"},Oo={class:"discount-controls"},So={key:0,class:"summary-row discount-amount"},xo={class:"amount success-text"},Do={class:"summary-row"},Vo={class:"label"},To={class:"amount"},$o={class:"summary-row total"},ko={class:"amount"},No={__name:"CartSummary",props:{subtotal:Number,discountAmount:Number,taxRate:Number,taxAmount:Number,total:Number},setup(a){const{discountType:o,discountValue:r,updateDiscount:i}=bo(),d=b=>Number(b/100).toFixed(2);return(b,f)=>($(),ee("div",ho,[l("div",wo,[f[2]||(f[2]=l("span",{class:"label"},"Subtotal",-1)),l("span",Io,"$"+A(d(a.subtotal)),1)]),l("div",Po,[l("div",Co,[f[4]||(f[4]=l("span",{class:"label"},"Discount",-1)),F(r)>0?($(),re(vt,{key:0,color:"success",size:"small",variant:"flat",class:"discount-badge"},{default:t(()=>f[3]||(f[3]=[S(" Applied ")])),_:1})):ve("",!0)]),l("div",Oo,[e(ut,{modelValue:F(o),"onUpdate:modelValue":[f[0]||(f[0]=m=>Et(o)?o.value=m:null),F(i)],items:[{title:"Percentage",value:"%"},{title:"Fixed",value:"fixed"}],"item-title":"title","item-value":"value",density:"compact","hide-details":"",variant:"outlined",class:"discount-type-select"},{selection:t(({item:m})=>[S(A(m.value==="%"?"%":"$"),1)]),_:1},8,["modelValue","onUpdate:modelValue"]),e(Se,{modelValue:F(r),"onUpdate:modelValue":[f[1]||(f[1]=m=>Et(r)?r.value=m:null),F(i)],prefix:F(o)==="fixed"?"$":"",suffix:F(o)==="%"?"%":"",density:"compact","hide-details":"",type:"number",variant:"outlined",class:"discount-value-input"},null,8,["modelValue","prefix","suffix","onUpdate:modelValue"])])]),a.discountAmount>0?($(),ee("div",So,[f[5]||(f[5]=l("span",{class:"label"},"Discount Applied",-1)),l("span",xo,"-$"+A(d(a.discountAmount)),1)])):ve("",!0),l("div",Do,[l("span",Vo,"Tax ("+A((a.taxRate*100).toFixed(1))+"%)",1),l("span",To,"$"+A(d(a.taxAmount)),1)]),e(bt,{class:"my-4"}),l("div",$o,[f[6]||(f[6]=l("span",{class:"label"},"Total",-1)),l("span",ko,"$"+A(d(a.total)),1)])]))}},Eo=Te(No,[["__scopeId","data-v-67e25db4"]]),Ao={class:"mb-4"},Fo={class:"d-flex align-center gap-2"},Uo={__name:"EditItemDialog",props:{modelValue:{type:Boolean,required:!0},item:{type:Object,default:null},index:{type:Number,default:null}},emits:["update:modelValue"],setup(a,{emit:o}){const r=a,i=o,d=He(),b=D(1),f=te({get:()=>r.modelValue,set:u=>i("update:modelValue",u)}),m=te(()=>r.item&&b.value>0&&b.value<r.item.quantity),I=()=>{m.value&&(d.splitItem(r.index,Number(b.value)),c())},c=()=>{f.value=!1,b.value=1};return(u,g)=>($(),re(ze,{modelValue:f.value,"onUpdate:modelValue":g[1]||(g[1]=_=>f.value=_),"max-width":"500"},{default:t(()=>[e(Pe,null,{default:t(()=>[e(ft,{class:"d-flex justify-space-between align-center"},{default:t(()=>{var _;return[S(A((_=a.item)==null?void 0:_.name)+" ",1),e(vt,null,{default:t(()=>{var V;return[S("Qty: "+A(((V=a.item)==null?void 0:V.quantity)||0),1)]}),_:1})]}),_:1}),e(ke,null,{default:t(()=>{var _;return[l("div",Ao,[g[3]||(g[3]=l("div",{class:"text-subtitle-2 mb-2"},"Split Item",-1)),l("div",Fo,[e(Se,{modelValue:b.value,"onUpdate:modelValue":g[0]||(g[0]=V=>b.value=V),type:"number",label:"Quantity to split",min:1,max:((_=a.item)==null?void 0:_.quantity)-1,density:"compact","hide-details":"",style:{"max-width":"120px"}},null,8,["modelValue","max"]),e(Q,{color:"primary",variant:"outlined",disabled:!m.value,onClick:I},{default:t(()=>g[2]||(g[2]=[S(" Split ")])),_:1},8,["disabled"])])])]}),_:1}),e(st,null,{default:t(()=>[e(Ne),e(Q,{color:"grey",variant:"text",onClick:c},{default:t(()=>g[4]||(g[4]=[S(" Cancel ")])),_:1}),e(Q,{color:"primary",onClick:c},{default:t(()=>g[5]||(g[5]=[S(" Save ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Me=[];for(let a=0;a<256;++a)Me.push((a+256).toString(16).slice(1));function zo(a,o=0){return(Me[a[o+0]]+Me[a[o+1]]+Me[a[o+2]]+Me[a[o+3]]+"-"+Me[a[o+4]]+Me[a[o+5]]+"-"+Me[a[o+6]]+Me[a[o+7]]+"-"+Me[a[o+8]]+Me[a[o+9]]+"-"+Me[a[o+10]]+Me[a[o+11]]+Me[a[o+12]]+Me[a[o+13]]+Me[a[o+14]]+Me[a[o+15]]).toLowerCase()}let Wt;const Ro=new Uint8Array(16);function Lo(){if(!Wt){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Wt=crypto.getRandomValues.bind(crypto)}return Wt(Ro)}const qo=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ua={randomUUID:qo};function Mo(a,o,r){if(ua.randomUUID&&!o&&!a)return ua.randomUUID();a=a||{};const i=a.random||(a.rng||Lo)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,o){r=r||0;for(let d=0;d<16;++d)o[r+d]=i[d];return o}return zo(i)}const ca=a=>{if(!a||!a.id)throw new Error("Invalid hold order data");if(a.status==="inactive")throw new Error("Hold order is not active");if(!a.hold_items||!a.hold_items.length)throw new Error("Hold order has no items");if(a.paid_status||(a.paid_status=Rt.UNPAID,s.debug("Setting default paid_status:",a.paid_status)),a.type||(a.type=ct.DINE_IN,s.debug("Setting default type:",a.type)),a.paid_status&&!Object.values(Rt).includes(a.paid_status))throw new Error("Invalid paid status. Must be either PAID or UNPAID");if(a.type&&!Object.values(ct).includes(a.type))throw new Error("Invalid order type. Must be one of: DINE IN, TO-GO, DELIVERY, PICKUP");if(a.hold_items.reduce((r,i)=>r+Number(i.price)*Number(i.quantity),0)!==a.total)throw new Error("Hold order total mismatch")},Vt=a=>{var o;return a&&((o=a.hold_invoices)!=null&&o.data?(a.hold_invoices.data=a.hold_invoices.data.map(r=>({...r,paid_status:r.paid_status||Rt.UNPAID,type:r.type||ct.DINE_IN})),a):a.id?{...a,paid_status:a.paid_status||Rt.UNPAID,type:a.type||ct.DINE_IN}:a)},jo=()=>`pos_${Date.now()}_${Mo()}`,et=a=>{var r;const o={success:!1,message:a.message,errors:{}};if(a.response){switch(a.response.status){case 400:o.message="Invalid request parameters";break;case 401:o.message="Authentication required";break;case 404:o.message="Resource not found";break;case 422:o.message="Validation failed",o.errors=a.response.data.errors||{};break;case 500:o.message="Internal server error";break;default:o.message="An unexpected error occurred"}o.statusCode=a.response.status}throw s.error("API Error:",{message:o.message,status:(r=a.response)==null?void 0:r.status,errors:o.errors,originalError:a.message}),o},Go={async getCompanySettings(){s.startGroup("POS Operations: Get Company Settings");try{const a=["invoice_auto_generate","invoice_issuance_period","payment_auto_generate","allow_invoice_form_pos","allow_partial_pay","pdf_format_pos"];s.debug("Requesting company settings with params:",{settings:a});const o=await Ue.get("company/settings",{params:{"settings[]":a}});return s.debug("Company settings response:",o.data),s.info("Company settings fetched successfully"),{success:!0,data:o.data}}catch(a){return et(a)}finally{s.endGroup()}},async getNextNumber(a){s.startGroup(`POS Operations: Get Next ${a} Number`);try{s.debug(`Requesting next ${a} number`);const o=await Ue.get("next-number",{params:{key:a}});if(!o.data.nextNumber||!o.data.prefix)throw new Error("Invalid next number response");return s.debug(`Next ${a} number response:`,o.data),s.info(`Next ${a} number fetched successfully`),{nextNumber:o.data.nextNumber,prefix:o.data.prefix}}catch(o){return et(o)}finally{s.endGroup()}},async getTables(a){var o,r;s.startGroup("POS Operations: Get Tables");try{if(!a)throw new Error("Cash register ID is required");s.debug("Requesting tables for cash register:",a);const i=localStorage.getItem("companyId"),d=`${La("pos.tables")}/${a}`,b={headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json",Accept:"application/json",company:i}};s.debug("Tables request config:",{endpoint:d,config:b});const f=await Ue.get(d,b);if(!f.data)throw new Error("Invalid response structure");const m=Array.isArray(f.data)?f.data:f.data.data&&Array.isArray(f.data.data)?f.data.data:[];return s.debug("Tables response processed:",{rawResponse:f.data,processedTables:m,tableCount:m.length}),{success:!0,data:m.map(I=>({id:I.id,name:I.name||`Table ${I.id}`,is_occupied:!!I.is_occupied,quantity:I.quantity||0,items:I.items||0}))}}catch(i){return s.error("Failed to fetch tables",{error:i.message,response:(o=i.response)==null?void 0:o.data,status:(r=i.response)==null?void 0:r.status,cashRegisterId:a}),{success:!1,error:i.message,data:[]}}finally{s.endGroup()}}},Ho={async getHoldInvoices(){var a;s.startGroup("POS Operations: Get Hold Invoices");try{s.debug("Requesting hold invoices");const o=await Qt.holdInvoice.getAll();if(!o.data)throw new Error("Invalid hold invoices response");const r=Vt(o.data);return(a=r.hold_invoices)!=null&&a.data&&r.hold_invoices.data.forEach(i=>{try{ca(i)}catch(d){s.warn(`Invalid hold order ${i.id}:`,d.message)}}),s.debug("Hold invoices response:",r),s.info("Hold invoices fetched successfully"),{success:!0,...r}}catch(o){return et(o)}finally{s.endGroup()}},async getHoldInvoice(a){var o,r;s.startGroup("POS Operations: Get Hold Invoice");try{if(!a)throw s.error("Invalid hold invoice ID:",a),new Error("Hold invoice ID is required");s.debug("Requesting hold invoice:",a);const i=await Qt.holdInvoice.getById(a);if(!(i!=null&&i.data))throw s.error("Empty response from hold invoice API:",i),new Error("Empty response from hold invoice API");const d=((o=i.data)==null?void 0:o.data)||((r=i.data)==null?void 0:r.hold_invoice)||i.data;if(!d||!d.id&&!d.hold_invoice_id)throw s.error("Invalid hold invoice response structure:",i.data),new Error("Invalid hold invoice response structure");const b=Vt(d);if(!b.id&&!b.hold_invoice_id)throw s.error("Missing required ID fields after transform:",b),new Error("Missing required invoice ID fields");return s.debug("Hold invoice response:",b),s.info("Hold invoice fetched successfully"),b}catch(i){return et(i)}finally{s.endGroup()}},async updateHoldInvoice(a,o){s.startGroup("POS Operations: Update Hold Invoice");try{s.debug("Updating hold invoice:",{id:a,data:o});const r={...o,paid_status:o.paid_status||mt.UNPAID,type:o.type||Ae.DINE_IN,is_hold_invoice:!0};if(r.paid_status&&!Object.values(mt).includes(r.paid_status))throw new Error("Invalid paid_status. Must be either PAID or UNPAID");if(r.type&&!Object.values(Ae).includes(r.type))throw new Error("Invalid type. Must be one of: DINE IN, TO-GO, DELIVERY, PICKUP");const i=await Qt.holdInvoice.update(a,r);return s.debug("Hold invoice update response:",i),s.info("Hold invoice updated successfully:",{invoiceId:a,total:r.total,paid_status:r.paid_status,type:r.type}),{success:!0,data:Vt(i.data)}}catch(r){return et(r)}finally{s.endGroup()}},async createInvoice(a){var o,r;s.startGroup("POS Operations: Create Invoice");try{s.debug("Creating invoice with data:",a);const i={...a,paid_status:a.paid_status||mt.UNPAID,type:a.type||Ae.DINE_IN};if(i.paid_status&&!Object.values(mt).includes(i.paid_status))throw new Error("Invalid paid_status. Must be either PAID or UNPAID");if(i.type&&!Object.values(Ae).includes(i.type))throw new Error("Invalid type. Must be one of: DINE IN, TO-GO, DELIVERY, PICKUP");if(i.hold_invoice_id&&!i.is_prepared_data){const b=await this.getHoldInvoice(i.hold_invoice_id);if(!b)throw new Error("Failed to fetch hold invoice");ca(b)}const d=await Ue.post("invoices",i);return s.debug("Invoice creation response:",d.data),s.info("Invoice created successfully:",{invoiceId:(o=d.data.invoice)==null?void 0:o.id,total:(r=d.data.invoice)==null?void 0:r.total,paid_status:i.paid_status,type:i.type}),{success:!0,...Vt(d.data)}}catch(i){return et(i)}finally{s.endGroup()}},async getInvoice(a){var o;s.startGroup("POS Operations: Get Invoice");try{s.debug("Requesting invoice:",a);const r=await Ue.get(`invoices/${a}`);if(!((o=r.data)!=null&&o.invoice))throw new Error("Invalid invoice response");return s.debug("Invoice response:",r.data),s.info("Invoice fetched successfully"),{success:!0,...Vt(r.data.invoice)}}catch(r){return et(r)}finally{s.endGroup()}}},Bo={async getPaymentMethods(){var a;s.startGroup("POS Operations: Get Payment Methods");try{s.debug("Requesting payment methods");const o=await Ue.post("payments/multiple/get-payment-methods");if(!((a=o.data)!=null&&a.payment_methods))throw new Error("Invalid payment methods response");return s.debug("Payment methods response:",o.data),s.info("Payment methods fetched successfully"),{success:!0,data:o.data.payment_methods}}catch(o){return et(o)}finally{s.endGroup()}},async createPayment(a){var o,r;s.startGroup("POS Operations: Create Payment");try{s.debug("Creating payment with data:",a);const i=jo();s.debug("Generated idempotency key:",i);const d=await Ue.post("payments/multiple/create",a,{headers:{"Idempotency-Key":i}});return s.debug("Payment creation response:",d.data),s.info("Payment created successfully:",{paymentId:(o=d.data.payment)==null?void 0:o.id,amount:(r=d.data.payment)==null?void 0:r.amount}),{success:!0,...d.data}}catch(i){return et(i)}finally{s.endGroup()}}},Ko={async getOrders(){s.startGroup("POS Operations: Get Orders");try{s.debug("Requesting orders");const a=await Ue.get("orders");if(!a.data)throw new Error("Invalid orders response");return s.debug("Orders response:",a.data),s.info("Orders fetched successfully"),{success:!0,data:Array.isArray(a.data)?a.data:a.data.data||[]}}catch(a){return et(a)}finally{s.endGroup()}},async getOrderById(a){s.startGroup("POS Operations: Get Order By ID");try{s.debug("Requesting order:",a);const o=await Ue.get(`orders/${a}`);if(!o.data)throw new Error("Invalid order response");return s.debug("Order response:",o.data),s.info("Order fetched successfully"),{success:!0,data:o.data}}catch(o){return et(o)}finally{s.endGroup()}},async updateOrderStatus(a,o){s.startGroup("POS Operations: Update Order Status");try{s.debug("Updating order status:",{orderId:a,statusData:o});const r=await Ue.patch(`orders/${a}/status`,o);return s.debug("Order status update response:",r.data),s.info("Order status updated successfully:",{orderId:a,newStatus:o.status}),{success:!0,data:r.data}}catch(r){return et(r)}finally{s.endGroup()}}},Da={...Go,...Ho,...Bo,...Ko},Va=()=>Da,Ft=Da,Ge=Ae;function xt(){var T;s.info("[useOrderType] Initializing order type composable");const a=He(),o=gt(),r=D(null),i=D({name:"",phone:"",instructions:""}),d=D(""),b=D(!1),f=D(null);if(a.type&&(s.debug("[useOrderType] Initializing from cart store type:",a.type),r.value=a.type),a.notes)try{s.debug("[useOrderType] Parsing cart store notes");const h=JSON.parse(a.notes);h.customerNotes&&(d.value=h.customerNotes,s.debug("[useOrderType] Customer notes initialized:",d.value)),(T=h.orderInfo)!=null&&T.customer&&(i.value={...i.value,...h.orderInfo.customer},s.debug("[useOrderType] Customer info initialized:",i.value))}catch(h){s.warn("[useOrderType] Failed to initialize from cart notes:",h)}we(d,h=>{try{s.debug("[useOrderType] Customer notes changed:",h);const N={customerNotes:h,orderInfo:{customer:i.value},timestamp:new Date().toISOString()};a.setNotes(JSON.stringify(N))}catch(N){s.error("[useOrderType] Failed to sync notes with cart store:",N)}});const m=te(()=>{if(!r.value)return s.debug("[useOrderType] Validation failed: No order type set"),!1;const{name:h,phone:N,address:M}=i.value;switch(r.value){case Ge.DINE_IN:return s.debug("[useOrderType] Validating DINE_IN order"),!0;case Ge.TO_GO:return s.debug("[useOrderType] Validating TO_GO order:",{name:h,phone:N}),h.trim()&&N.trim();case Ge.DELIVERY:return s.debug("[useOrderType] Validating DELIVERY order:",{name:h,phone:N,address:M}),h.trim()&&N.trim()&&M.trim();case Ge.PICKUP:return s.debug("[useOrderType] Validating PICKUP order:",{name:h,phone:N}),h.trim()&&N.trim();default:return s.warn("[useOrderType] Invalid order type:",r.value),!1}}),I=te(()=>r.value&&r.value!==Ge.DINE_IN),c=te(()=>{const h=!a.isEmpty&&o.systemReady;return s.debug("[useOrderType] Can create order:",{canCreate:h,cartEmpty:a.isEmpty,systemReady:o.systemReady}),h}),u=te(()=>{try{if(a.type)return s.debug("[useOrderType] Order type found in cart store:",a.type),r.value=a.type,a.type;if(a.holdInvoiceId){s.debug("[useOrderType] Determining type from held invoice:",a.holdInvoiceName);const h=a.holdInvoiceName||"";for(const N of Object.values(Ge))if(h.startsWith(N))return s.debug("[useOrderType] Type determined from invoice name:",N),r.value=N,a.setType(N),N}return a.holdInvoiceId?(s.debug("[useOrderType] No type found for held order, defaulting to TO_GO"),r.value=Ge.TO_GO,a.setType(Ge.TO_GO),Ge.TO_GO):(s.debug("[useOrderType] No order type found"),r.value||null)}catch(h){return s.error("[useOrderType] Error determining current order type:",h),r.value||null}}),g=(h,N="")=>{s.debug("[useOrderType] Updating customer notes:",{customer:h,notes:N});const M={orderInfo:{customer:{...h}},customerNotes:N};a.setNotes(JSON.stringify(M))};return{orderType:r,customerInfo:i,customerNotes:d,loading:b,error:f,isValid:m,requiresCustomerInfo:I,canCreateOrder:c,currentOrderType:u,setOrderType:h=>{if(s.info("[useOrderType] Setting order type:",h),!Object.values(Ge).includes(h))throw s.error("[useOrderType] Invalid order type:",h),new Error("Invalid order type");r.value=h,a.setType(h),i.value={name:"",phone:"",address:"",pickupTime:"",instructions:""},f.value=null;const N={orderInfo:{customer:{...i.value}},customerNotes:""};a.setNotes(JSON.stringify(N)),d.value="",s.debug("[useOrderType] Order type set, state reset")},setCustomerInfo:h=>{s.debug("[useOrderType] Setting customer info:",h),i.value={...i.value,...h},g(i.value,d.value)},setCustomerNotes:h=>{s.debug("[useOrderType] Setting customer notes:",h),d.value=h,g(i.value,h)},processOrder:async(h={})=>{if(s.info("[useOrderType] Starting order processing",{orderType:r.value,customerInfo:i.value,isValid:m.value,canCreateOrder:c.value}),!m.value)throw s.warn("[useOrderType] Invalid order information"),new Error("Invalid order information");if(!c.value)throw s.warn("[useOrderType] Cannot create order",{cartEmpty:a.isEmpty,systemReady:o.systemReady}),new Error("Cannot create order: Cart is empty or system is not ready");b.value=!0,f.value=null;try{if(g(i.value,d.value),r.value===Ge.DINE_IN)return s.info("[useOrderType] Processing DINE_IN order"),{success:!0};if(r.value===Ge.TO_GO){if(!h.storeId||!h.cashierId)throw new Error("Store and cashier IDs are required for TO-GO orders");h.customerInfo&&(i.value={name:h.customerInfo.name,phone:h.customerInfo.phone,instructions:h.customerInfo.instructions});const X=h.orderName||`${r.value}_${i.value.name}`;s.info("[useOrderType] Processing TO_GO order:",{orderName:X,storeId:h.storeId,cashierId:h.cashierId,customerInfo:i.value});const v=a.prepareHoldInvoiceData(h.storeId,h.cashierId,X),p={customer:{name:i.value.name,phone:i.value.phone,instructions:i.value.instructions}};v.notes=JSON.stringify({orderInfo:p}),v.is_prepared_data=!0,v.is_invoice_pos=1,v.is_hold_invoice=!0,s.debug("[useOrderType] TO_GO hold order data prepared:",v);const R=await o.holdOrder(v);return s.info("[useOrderType] TO_GO order created successfully:",R.data),{success:!0,data:R.data}}const N=a.prepareHoldInvoiceData(o.selectedStore,o.selectedCashier,`${r.value}_${i.value.name}`);s.debug("[useOrderType] Processing regular order:",N);const M=await o.holdOrder(N);if(!(M!=null&&M.success))throw s.error("[useOrderType] Failed to process order:",M),new Error((M==null?void 0:M.message)||"Failed to process order");return s.info("[useOrderType] Order processed successfully:",M),{success:!0,data:M.data||M}}catch(N){throw s.error("[useOrderType] Order processing failed:",{error:N,orderType:r.value,customerInfo:i.value}),f.value=N.message||"Failed to process order",N}finally{b.value=!1,s.debug("[useOrderType] Order processing completed")}},reset:()=>{s.debug("[useOrderType] Resetting state"),r.value=null,a.setType(null),i.value={name:"",phone:"",address:"",pickupTime:"",instructions:""},d.value="",f.value=null},ORDER_TYPES:Ge}}const Yo={class:"order-notes px-4 py-2"},Qo={__name:"OrderNotes",setup(a){const o=He(),{customerNotes:r,setCustomerNotes:i}=xt(),d=D(""),b=m=>{try{const I={customerNotes:m,timestamp:new Date().toISOString()};o.setNotes(JSON.stringify(I)),s.debug("Notes saved to cart store:",{notes:m})}catch(I){s.error("Failed to save notes to cart:",I)}},f=m=>{i(m),b(m)};return wt(()=>{try{if(o.notes){const m=yt(o.notes);m&&(d.value=m,i(m),s.debug("Notes initialized from cart store:",{notes:m}))}}catch(m){s.error("Failed to initialize notes:",m)}}),we(()=>r.value,m=>{m!==d.value&&(d.value=m,b(m),s.debug("Notes updated from customer notes:",{newNotes:m}))}),we(()=>o.notes,m=>{try{const I=yt(m);I!==d.value&&(d.value=I,s.debug("Notes updated from cart store:",{notes:I}))}catch(I){s.error("Failed to parse cart store notes:",I)}}),(m,I)=>($(),ee("div",Yo,[e(Se,{modelValue:d.value,"onUpdate:modelValue":[I[0]||(I[0]=c=>d.value=c),f],label:"Order Notes",placeholder:"Add notes for this order...",variant:"outlined",density:"comfortable","hide-details":"",clearable:""},{"prepend-inner":t(()=>[e(le,{size:"small",color:"grey"},{default:t(()=>I[1]||(I[1]=[S("mdi-note-text-outline")])),_:1})]),_:1},8,["modelValue"])]))}},Wo=Te(Qo,[["__scopeId","data-v-af3d3769"]]);function Jo(){const a=He(),o=gt(),r=D(!1);return{cartStore:a,updating:r,clearOrder:()=>{var m,I;try{s.debug("Clearing order, current state:",{items:(m=a.items)==null?void 0:m.length,total:a.total}),a.clearCart()}catch(c){s.error("Error clearing order:",c),(I=window.toastr)==null||I.error("Failed to clear order")}},updateQuantity:(m,I,c)=>{a.updateItemQuantity(m,I,c)},removeItem:(m,I)=>{a.removeItem(m,I)},updateOrder:async()=>{var m,I,c;try{const u=a.holdOrderDescription;if(s.debug("Attempting to update order:",{description:u,hasDescription:!!u,cartState:{items:(m=a.items)==null?void 0:m.length,total:a.total,holdInvoiceId:a.holdInvoiceId}}),!u)throw new Error("No order description found");r.value=!0;const g=a.prepareHoldInvoiceData(o.selectedStore,o.selectedCashier,u),_=await o.updateHoldInvoice(u,g);if(_.success)(I=window.toastr)==null||I.success("Order updated successfully"),a.setHoldInvoiceId(null),a.clearCart();else throw new Error(_.message||"Failed to update order")}catch(u){s.error("Failed to update order:",u),(c=window.toastr)==null||c.error(u.message||"Failed to update order")}finally{r.value=!1}}}}const Xo={class:"pos-cart-container",style:{"max-width":"none"}},Zo={key:0,class:"px-4 py-2 bg-warning-lighten-4"},es={class:"d-flex align-center"},ts={class:"text-warning text-body-2 font-weight-medium"},as={key:0,class:"empty-state pa-8 text-center"},os={__name:"PosCart",setup(a){const{cartStore:o,updating:r,clearOrder:i,updateQuantity:d,removeItem:b,updateOrder:f,splitItem:m}=Jo(),I=async()=>{var V,y;try{if(!o.items||o.items.length===0){(V=window.toastr)==null||V.error("Cannot update invoice: Cart is empty");return}const n=o.currentInvoice||{},C={...o.currentInvoice,contact_id:n.contact_id||n.customer_id,company_id:n.company_id,first_name:n.first_name,last_name:n.last_name,email:n.email,phone:n.phone};C.company_id||(console.warn("No company_id found in original invoice"),C.company_id=o.currentCompanyId),C.contact_id||console.warn("No contact_id found in original invoice"),await o.updateInvoice(C),i()}catch(n){console.error("Failed to update invoice:",n),(y=window.toastr)==null||y.error("Failed to update invoice: "+(n.message||"Unknown error"))}},c=D(!1),u=D(null),g=D(null),_=(V,y)=>{u.value={...V},g.value=y,c.value=!0};return(V,y)=>($(),ee("div",Xo,[e(Pe,{class:"cart-header",flat:""},{default:t(()=>[e(Je,{density:"comfortable",color:"primary",class:"rounded-t-lg"},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>[S(A(F(o).isEditingInvoice?"Edit Invoice":"Current Order"),1)]),_:1}),e(Ne),F(o).canUpdateInvoice?($(),re(Q,{key:0,color:"white",variant:"text",loading:F(r),onClick:I,"prepend-icon":"mdi-content-save",class:"text-none"},{default:t(()=>y[3]||(y[3]=[S(" Update Invoice ")])),_:1},8,["loading"])):F(o).isHoldOrder?($(),re(Q,{key:1,color:"white",variant:"text",loading:F(r),onClick:F(f),"prepend-icon":"mdi-content-save",class:"text-none"},{default:t(()=>y[4]||(y[4]=[S(" Update ")])),_:1},8,["loading","onClick"])):ve("",!0),e(Q,{color:"white",variant:"text",disabled:F(o).isEmpty,onClick:F(i),"prepend-icon":"mdi-delete-outline",class:"text-none ml-2"},{default:t(()=>y[5]||(y[5]=[S(" Clear ")])),_:1},8,["disabled","onClick"])]),_:1}),F(o).isHoldOrder?($(),ee("div",Zo,[l("div",es,[e(le,{icon:"mdi-clock-outline",color:"warning",class:"mr-2"}),l("span",ts," Held Order: "+A(F(o).holdOrderDescription||"No Description"),1)])])):ve("",!0)]),_:1}),e(Pe,{class:je(["cart-scrollable-content mx-2 mt-2",{"empty-cart":F(o).isEmpty}]),variant:"flat"},{default:t(()=>[F(o).isEmpty?($(),ee("div",as,[e(le,{icon:"mdi-cart-outline",size:"64",color:"grey-lighten-1",class:"mb-4"}),y[6]||(y[6]=l("h3",{class:"text-h6 font-weight-medium text-grey-darken-1"},"Cart is Empty",-1)),y[7]||(y[7]=l("p",{class:"text-body-2 text-grey-darken-1 mt-2"}," Add items from the product list to get started. ",-1))])):($(),re(_o,{key:1,items:F(o).items,onEdit:_,onRemove:F(b),onUpdateQuantity:F(d),class:"cart-items-list"},null,8,["items","onRemove","onUpdateQuantity"]))]),_:1},8,["class"]),F(o).isEmpty?ve("",!0):($(),re(Pe,{key:0,class:"mx-2 mt-2",variant:"flat"},{default:t(()=>[e(Wo)]),_:1})),e(Pe,{class:"cart-summary-wrapper mx-2 mt-2 mb-2",elevation:"2",rounded:"lg"},{default:t(()=>[e(ke,{class:"pa-4"},{default:t(()=>[e(Eo,{subtotal:F(o).subtotal,"discount-amount":F(o).discountAmount,"tax-rate":F(o).taxRate,"tax-amount":F(o).taxAmount,total:F(o).total},null,8,["subtotal","discount-amount","tax-rate","tax-amount","total"])]),_:1})]),_:1}),e(Uo,{modelValue:c.value,"onUpdate:modelValue":y[2]||(y[2]=n=>c.value=n),item:u.value,index:g.value,"max-width":"500",transition:"dialog-bottom-transition",persistent:""},{default:t(()=>[e(Pe,null,{default:t(()=>[e(ft,{class:"text-h6 pa-4"},{default:t(()=>[y[8]||(y[8]=S(" Edit Item ")),e(Q,{icon:"mdi-close",variant:"text",size:"small",onClick:y[0]||(y[0]=n=>c.value=!1),class:"float-right"})]),_:1}),e(ke,{class:"pa-4"}),e(st,{class:"pa-4"},{default:t(()=>[e(Ne),e(Q,{color:"grey-darken-1",variant:"text",onClick:y[1]||(y[1]=n=>c.value=!1),class:"text-none"},{default:t(()=>y[9]||(y[9]=[S(" Cancel ")])),_:1}),e(Q,{color:"primary",onClick:V.saveChanges,class:"text-none",loading:V.saving},{default:t(()=>y[10]||(y[10]=[S(" Save Changes ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue","item","index"]),e(wa,{"model-value":F(o).loading,class:"align-center justify-center"},{default:t(()=>[e(lt,{size:"64",color:"primary",indeterminate:""})]),_:1},8,["model-value"])]))}},ss=Te(os,[["__scopeId","data-v-fb1db8bc"]]);const rs={class:"search-wrapper"},ls={__name:"ProductSearch",emits:["search","quickAdd"],setup(a,{emit:o}){const r=D(""),i=D(!1),{mobile:d}=Sa(),b=te(()=>d.value),f=o,m={NUMERIC:/^\d{4,}$/,ALPHANUMERIC:/^[A-Z]\d{3,}$/,DASHED:/^[A-Z0-9]+-[A-Z0-9]+$/};let I,c="",u;const g=n=>{if(!n||n.length<4)return!1;const C=n.toUpperCase();return Object.values(m).some(T=>T.test(C))},_=n=>{if(!n){V();return}i.value=!0,clearTimeout(I),clearTimeout(u),c=n,g(n)?(s.debug("Potential SKU detected:",{value:n}),u=setTimeout(()=>{s.info("Processing SKU:",{sku:c}),f("quickAdd",c),V()},1e3)):I=setTimeout(()=>{s.debug("Processing search:",{query:n}),f("search",n),i.value=!1},300)},V=()=>{r.value="",c="",clearTimeout(I),clearTimeout(u),f("search",""),i.value=!1},y=()=>{const n=r.value.trim();n&&(clearTimeout(u),g(n)?(s.info("Manual SKU entry:",{sku:n}),f("quickAdd",n)):(s.info("Manual search entry:",{query:n}),f("search",n)),V())};return(n,C)=>($(),ee("div",rs,[e(Ia,null,{default:t(()=>[e(Se,{modelValue:r.value,"onUpdate:modelValue":[C[0]||(C[0]=T=>r.value=T),_],placeholder:b.value?"Search...":"Search products...",label:b.value?null:"Search Products",density:"comfortable",variant:"outlined","hide-details":"",class:je(["search-field",{"is-mobile":b.value}]),"bg-color":"white",loading:i.value,clearable:"","onClick:clear":V,onKeyup:to(y,["enter"])},{"prepend-inner":t(()=>[e(le,{color:"primary",class:je({"search-icon-animated":i.value})},{default:t(()=>C[1]||(C[1]=[S(" mdi-magnify ")])),_:1},8,["class"])]),_:1},8,["modelValue","placeholder","label","class","loading"])]),_:1})]))}},ns=Te(ls,[["__scopeId","data-v-b1e13e44"]]);const is={class:"category-tabs-wrapper"},ds={__name:"CategoryTabs",props:{categories:{type:Array,required:!0}},emits:["change"],setup(a){const o=D("all");return(r,i)=>($(),ee("div",is,[e(Pa,{modelValue:o.value,"onUpdate:modelValue":[i[0]||(i[0]=d=>o.value=d),i[1]||(i[1]=d=>r.$emit("change",o.value))],density:"comfortable","show-arrows":"","slider-color":"primary","selected-class":"v-tab--selected",class:"category-tabs","bg-color":"white"},{default:t(()=>[($(!0),ee(xe,null,Ye(a.categories,d=>($(),re(zt,{key:d.id,value:d.id,class:"category-tab",ripple:!1},{default:t(()=>[d.icon?($(),re(le,{key:0,start:"",icon:d.icon,size:"18",class:"me-1"},null,8,["icon"])):ve("",!0),S(" "+A(d.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]))}},us=Te(ds,[["__scopeId","data-v-ad292143"]]);const cs={class:"product-grid-container"},ms={class:"product-grid-scroll"},ps={class:"product-grid ma-0"},fs={class:"d-flex align-center justify-center fill-height"},vs={class:"product-info"},ys={class:"product-title px-3 pt-3"},gs={class:"d-flex align-center justify-space-between px-3 pb-3"},_s={class:"text-primary price-text"},bs={key:1,class:"d-flex align-center pa-3"},hs={class:"flex-grow-1"},ws={class:"product-title mb-1"},Is={class:"text-primary price-text"},Ps={key:0,class:"pagination-wrapper"},Cs={__name:"ProductGrid",props:{products:{type:Array,required:!0},gridSettings:{type:Object,required:!0}},emits:["select"],setup(a,{emit:o}){ao(V=>({b88c3364:a.gridSettings.columns,c19bd192:V.getCardHeight}));const r=a,i=o,d=D(1),b=te(()=>r.gridSettings.rows===-1?r.products.length:r.gridSettings.rows*r.gridSettings.columns),f=te(()=>{const V=(d.value-1)*b.value,y=V+b.value;return r.products.slice(V,y)}),m=te(()=>r.gridSettings.rows===-1?1:Math.ceil(r.products.length/b.value));we(()=>r.products,()=>{d.value=1},{immediate:!0});const I=V=>{d.value=V,s.debug("ProductGrid - Page changed:",{page:V,totalItems:r.products.length})},c=V=>{s.debug("ProductGrid - Product selected:",{id:V.id,name:V.name,price:V.price}),i("select",V)},u=V=>se.format(V),g=V=>V.image_url||"/placeholder-product.png",_=te(()=>{switch(r.gridSettings.layout){case"compact":return 120;case"comfortable":return 160;default:return 140}});return(V,y)=>($(),ee("div",cs,[l("div",ms,[l("div",ps,[($(!0),ee(xe,null,Ye(f.value,n=>($(),ee("div",{key:n.id,class:"product-grid-item"},[e(Pe,{elevation:"0",class:je(["product-card",[a.gridSettings.layout,"rounded-lg"]]),onClick:C=>c(n)},{default:t(()=>[a.gridSettings.layout!=="list"?($(),ee(xe,{key:0},[e(qa,{src:g(n),height:_.value,cover:"",class:"bg-grey-lighten-2"},{placeholder:t(()=>[l("div",fs,[e(lt,{color:"grey-lighten-4",indeterminate:"",size:"20"})])]),_:2},1032,["src","height"]),l("div",vs,[l("div",ys,A(n.name),1),l("div",gs,[l("span",_s,A(u(n.sale_price||n.price)),1),e(Q,{density:"comfortable",variant:"tonal",color:"primary",size:"small",icon:"mdi-plus",class:"add-btn"})])])],64)):($(),ee("div",bs,[l("div",hs,[l("div",ws,A(n.name),1),l("div",Is,A(u(n.sale_price||n.price)),1)]),e(Q,{density:"comfortable",variant:"tonal",color:"primary",size:"small",icon:"mdi-plus",class:"add-btn ms-2"})]))]),_:2},1032,["class","onClick"])]))),128))])]),r.gridSettings.rows!==-1?($(),ee("div",Ps,[e(ta,{modelValue:d.value,"onUpdate:modelValue":[y[0]||(y[0]=n=>d.value=n),I],length:m.value,"total-visible":7,density:"compact"},null,8,["modelValue","length"])])):ve("",!0)]))}},Os=Te(Cs,[["__scopeId","data-v-1da473db"]]);const Ss={class:"grid-settings pa-4"},xs={class:"d-flex align-center"},Ds={__name:"GridSettings",props:{modelValue:{type:Object,required:!0}},emits:["update:modelValue"],setup(a,{emit:o}){const r=a,i=o;Sa();const d={layout:"comfortable",columns:4,rows:-1},b=D(r.modelValue.layout),f=D(r.modelValue.columns),m=D(r.modelValue.rows||d.rows),I=[{title:"2 Items",value:2},{title:"4 Items",value:4},{title:"6 Items",value:6},{title:"8 Items",value:8}],c=[{title:"2 Rows",value:2},{title:"3 Rows",value:3},{title:"4 Rows",value:4},{title:"Show All",value:-1}];we(()=>r.modelValue,y=>{b.value=y.layout,f.value=y.columns,m.value=y.rows||d.rows},{deep:!0});const u=y=>{const n={...r.modelValue,layout:y};y==="list"?n.columns=2:n.columns=4,n.rows=-1,i("update:modelValue",n)},g=y=>{i("update:modelValue",{...r.modelValue,columns:y})},_=y=>{i("update:modelValue",{...r.modelValue,rows:y})},V=()=>{i("update:modelValue",{...d})};return(y,n)=>($(),ee("div",Ss,[e(Pe,{flat:"",class:"mb-6"},{default:t(()=>[e(ke,{class:"text-body-1"},{default:t(()=>n[3]||(n[3]=[S(" Customize how products are displayed in your POS grid. Adjust the layout, number of items per row, and number of rows to optimize for your screen size and workflow. ")])),_:1})]),_:1}),e(ja,null,{default:t(()=>[l("div",xs,[e($t,{location:"top",text:"Set how many product cards appear in each row of the grid"},{activator:t(({props:C})=>[e(ut,pt(C,{modelValue:f.value,"onUpdate:modelValue":[n[0]||(n[0]=T=>f.value=T),g],items:I,label:"Items per row",density:"compact","hide-details":"",variant:"outlined",class:"grid-select elevation-1","bg-color":"white","menu-props":{maxHeight:200}}),{"prepend-inner":t(()=>[e(le,{size:"small",color:"primary"},{default:t(()=>n[4]||(n[4]=[S("mdi-view-grid-outline")])),_:1})]),_:2},1040,["modelValue"])]),_:1}),e($t,{location:"top",text:"Set how many rows of products to display before pagination"},{activator:t(({props:C})=>[e(ut,pt(C,{modelValue:m.value,"onUpdate:modelValue":[n[1]||(n[1]=T=>m.value=T),_],items:c,label:"Rows",density:"compact","hide-details":"",variant:"outlined",class:"grid-select me-3 mb-2 elevation-1","bg-color":"white","menu-props":{maxHeight:200}}),{"prepend-inner":t(()=>[e(le,{size:"small",color:"primary"},{default:t(()=>n[5]||(n[5]=[S("mdi-view-sequential")])),_:1})]),_:2},1040,["modelValue"])]),_:1}),e($t,{location:"top",text:"Choose how products are displayed: Large (spacious), Compact (smaller cards), or List view"},{activator:t(({props:C})=>[e(Ma,pt(C,{modelValue:b.value,"onUpdate:modelValue":[n[2]||(n[2]=T=>b.value=T),u],mandatory:"",density:"compact",rounded:"lg",class:"grid-toggle mb-2 elevation-1"}),{default:t(()=>[e(Q,{value:"comfortable",size:"small","prepend-icon":"mdi-view-grid",class:"grid-btn",ripple:!1},{default:t(()=>[n[7]||(n[7]=l("span",{class:"d-none d-sm-inline"},"Large",-1)),e(le,{class:"d-sm-none"},{default:t(()=>n[6]||(n[6]=[S("mdi-view-grid")])),_:1})]),_:1}),e(Q,{value:"compact",size:"small","prepend-icon":"mdi-view-grid-compact",class:"grid-btn",ripple:!1},{default:t(()=>[n[9]||(n[9]=l("span",{class:"d-none d-sm-inline"},"Compact",-1)),e(le,{class:"d-sm-none"},{default:t(()=>n[8]||(n[8]=[S("mdi-view-grid-compact")])),_:1})]),_:1}),e(Q,{value:"list",size:"small","prepend-icon":"mdi-view-list",class:"grid-btn",ripple:!1},{default:t(()=>[n[11]||(n[11]=l("span",{class:"d-none d-sm-inline"},"List",-1)),e(le,{class:"d-sm-none"},{default:t(()=>n[10]||(n[10]=[S("mdi-view-list")])),_:1})]),_:1})]),_:2},1040,["modelValue"])]),_:1}),e($t,{location:"top",text:"Reset to default settings"},{activator:t(({props:C})=>[e(Q,pt(C,{icon:"mdi-refresh",variant:"text",size:"small",color:"grey-darken-1",class:"ms-1",onClick:V}),null,16)]),_:1})])]),_:1})]))}},Vs=Te(Ds,[["__scopeId","data-v-f6d314ad"]]);const Ts={class:"pos-products-container"},$s={class:"products-header"},ks={class:"search-field"},Ns={class:"products-scroll-container"},Es={key:0,class:"products-loading-state"},As={__name:"PosProducts",setup(a){const o=D(!1),r=gt(),i=He(),d=D(JSON.parse(localStorage.getItem("gridSettings"))||{layout:"comfortable",columns:4,rows:3}),b=u=>{d.value=u,localStorage.setItem("gridSettings",JSON.stringify(u)),o.value=!1};we(d,u=>{localStorage.setItem("gridSettings",JSON.stringify(u))},{deep:!0}),wt(async()=>{s.startGroup("POS Products Component: Mount");try{await r.initialize()}catch(u){s.error("Error during initialization",u)}finally{s.endGroup()}});const f=async u=>{s.startGroup("POS Products: Search");try{r.searchQuery=u,await r.fetchProducts()}catch(g){s.error("Search failed",g)}finally{s.endGroup()}},m=async u=>{s.startGroup("POS Products: Category Change");try{await r.setCategory(u)}catch(g){s.error("Category change failed",g)}finally{s.endGroup()}},I=u=>{if(u.stock<=0)return;s.debug("[PosProducts] Product selected:",{id:u.id,name:u.name,price:u.price,section:{id:u.section_id,type:u.section_type,name:u.section_name},rawProduct:u});const g={...u,section_id:u.section_id,section_type:u.section_type||"other",section_name:u.section_name||"Default"};s.info("[PosProducts] Adding product to cart:",{id:g.id,name:g.name,price:g.price,section:{id:g.section_id,type:g.section_type,name:g.section_name}}),i.addItem(g,1)},c=async u=>{var g,_;s.startGroup("POS Products: Quick Add by Search");try{const V=r.products.find(n=>{var C;return((C=n.sku)==null?void 0:C.toLowerCase())===u.toLowerCase()});if(V){I(V);return}const y=r.products.find(n=>n.name.toLowerCase().includes(u.toLowerCase()));if(y)I(y);else{const n=await posApi.getItems({sku:u,is_pos:1,id:companyStore.selectedStore,limit:1});(_=(g=n.items)==null?void 0:g.data)!=null&&_[0]?I(n.items.data[0]):s.warn("No matching product found for quick add",{searchTerm:u})}}catch(V){s.error("Quick add failed",V)}finally{s.endGroup()}};return(u,g)=>($(),ee("div",Ts,[F(r).systemReady?($(),ee(xe,{key:1},[l("div",$s,[e(ot,{fluid:"",class:"pa-4"},{default:t(()=>[e(de,{"no-gutters":"",align:"center",class:"mb-4 flex-column flex-sm-row"},{default:t(()=>[e(ae,{cols:"12",sm:"7",md:"8",lg:"9",class:"pe-sm-4 mb-3 mb-sm-0"},{default:t(()=>[l("div",ks,[e(ns,{loading:F(r).loading.products,onSearch:f,onQuickAdd:c},null,8,["loading"])])]),_:1}),e(ae,{cols:"12",sm:"5",md:"4",lg:"3",class:"d-flex justify-end align-center"},{default:t(()=>[e(Q,{"prepend-icon":"mdi-cog",variant:"outlined",color:"primary",size:"small",class:"grid-settings-btn",onClick:g[0]||(g[0]=_=>o.value=!0)},{default:t(()=>g[4]||(g[4]=[S(" Grid Settings ")])),_:1}),e(ze,{modelValue:o.value,"onUpdate:modelValue":g[3]||(g[3]=_=>o.value=_),"max-width":"800",transition:"dialog-bottom-transition"},{default:t(()=>[e(Pe,null,{default:t(()=>[e(ft,{class:"d-flex justify-space-between align-center pa-4 bg-primary text-white"},{default:t(()=>[g[5]||(g[5]=l("span",{class:"text-h6"},"Grid Display Settings",-1)),e(Q,{icon:"mdi-close",variant:"text",size:"small",onClick:g[1]||(g[1]=_=>o.value=!1)})]),_:1}),e(ke,{class:"pa-6"},{default:t(()=>[e(Vs,{modelValue:d.value,"onUpdate:modelValue":[g[2]||(g[2]=_=>d.value=_),b]},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(de,{"no-gutters":""},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(us,{categories:F(r).categoriesForDisplay,onChange:m},null,8,["categories"])]),_:1})]),_:1})]),_:1})]),e(ot,{fluid:"",class:"products-content pa-0",style:{"max-width":"none"}},{default:t(()=>[l("div",Ns,[F(r).loading.products?($(),ee("div",Es,[e(lt,{indeterminate:"",color:"primary",size:"32"})])):F(r).products.length>0?($(),re(Os,{key:1,products:F(r).products,"grid-settings":d.value,onSelect:I,class:"products-grid"},null,8,["products","grid-settings"])):($(),re(at,{key:2,type:"info",variant:"tonal",class:"mx-4 products-empty-state"},{prepend:t(()=>[e(le,{icon:"mdi-information"})]),default:t(()=>[g[6]||(g[6]=S(" No items found "))]),_:1}))])]),_:1})],64)):($(),re(at,{key:0,type:"warning",class:"ma-2"},{default:t(()=>[S(A(F(r).setupMessage),1)]),_:1}))]))}},Fs=Te(As,[["__scopeId","data-v-0eec065f"]]);function qt(){const a=D(!1),o=D([]),r=D(null),i=D(null),d=Va(),b=async()=>{try{const _=await d.getCompanySettings();return i.value=_,_}catch(_){throw r.value=_.message,s.error("Failed to fetch company settings:",_),_}},f=async()=>{a.value=!0,r.value=null;try{const _=await d.getPaymentMethods();if(_.success&&_.data)o.value=_.data;else throw new Error("Failed to fetch payment methods");return _.data}catch(_){throw r.value=_.message,s.error("Failed to fetch payment methods:",_),_}finally{a.value=!1}},m=async(_,V)=>{console.log("Creating payment for invoice:",_.invoice.due_amount),a.value=!0,r.value=null;try{i.value||await b();const y=await d.getNextNumber("payment");if(!(y!=null&&y.nextNumber)||!(y!=null&&y.prefix))throw new Error("Failed to get next payment number");for(const h of V){const N=o.value.find(M=>M.id===h.method_id);if((N==null?void 0:N.only_cash)===1&&!h.received)throw new Error(`Received amount is required for ${N.name}`);(N==null?void 0:N.IsPaymentFeeActive)==="YES"&&(h.fees=u(h.method_id,h.amount))}console.log("Payments:",V);const n=V.reduce((h,N)=>h+N.amount,0);if(console.log("Total payment:",n),console.log("Invoice total:",_.total),n!==_.invoice.due_amount)throw new Error("Full payment is required.");const C={amount:n,invoice_id:_.invoice.id,is_multiple:1,payment_date:new Date().toISOString().split("T")[0],paymentNumAttribute:y.nextNumber,paymentPrefix:y.prefix,payment_number:`${y.prefix}-${y.nextNumber}`,payment_methods:V.map(h=>{const N=g(h.method_id);return{id:h.method_id,name:N.name,amount:h.amount,received:h.received||0,returned:h.returned||0,valid:!0}}),status:{value:"Approved",text:"Approved"},user_id:_.invoice.user_id,notes:`Payment for invoice ${_.invoice.invoice_number}`},T=await d.createPayment(C);if(!(T!=null&&T.success))throw new Error("Failed to create payment");return T.payment}catch(y){throw r.value=y.message,s.error("Failed to create payment:",y),y}finally{a.value=!1}},I=_=>{const V=o.value.find(y=>y.id===_);return(V==null?void 0:V.only_cash)===1},c=_=>{const V=o.value.find(y=>y.id===_);return(V==null?void 0:V.pos_money)||[]},u=(_,V)=>{const y=o.value.find(T=>T.id===_);if(!(y!=null&&y.registrationdatafees))return 0;const n=y.registrationdatafees;let C=0;if(n.type==="FIXED")C=Math.round(n.value*100);else if(n.type==="PERCENTAGE")C=Math.round(V*n.value/100);else if(n.type==="FIXED_PLUS_PERCENTAGE"){const T=Math.round(n.value.fixed*100),h=Math.round(V*n.value.percentage/100);C=T+h}return C},g=_=>o.value.find(V=>V.id===_);return{loading:a,error:r,paymentMethods:o,settings:i,fetchSettings:b,fetchPaymentMethods:f,createPayment:m,getDenominations:c,calculateFees:u,getPaymentMethod:g,isCashOnly:I}}function Mt(){const a=D(!1),o=D(null),r=Va(),i=gt(),d=rt(),{holdInvoices:b}=Pt(i),{selectedCashier:f,currentCashRegister:m}=Pt(d),I=y=>{var n;return(n=b.value)!=null&&n.length?b.value.find(C=>{var T,h;return C.paid_status===mt.UNPAID?((T=C.tables_selected)==null?void 0:T.some(N=>N.table_id===y))||((h=C.hold_tables)==null?void 0:h.some(N=>N.table_id===y)):!1}):null},c=y=>{var T,h;const n=I(y);if(!n)return null;const C=((T=n.tables_selected)==null?void 0:T.find(N=>N.table_id===y))||((h=n.hold_tables)==null?void 0:h.find(N=>N.table_id===y));return s.info(`Table ${y} info:`,{tableInfo:C}),{quantity:(C==null?void 0:C.quantity)||0,invoiceId:n.id}},u=async()=>{a.value=!0,o.value=null;try{const y=f.value||localStorage.getItem("selectedCashier");if(!y)throw new Error("No cashier selected");!f.value&&y&&await d.setSelectedCashier(Number(y));const n=await r.getTables(y);if(!n.success)throw new Error("Failed to fetch tables");return n.data.map(T=>{const h=g(T.id),N=h?c(T.id):null;return{...T,is_occupied:h,quantity:N?N.quantity:0,invoiceId:N?N.invoiceId:null}})}catch(y){throw o.value=y.message,s.error("Failed to get tables:",y),y}finally{a.value=!1}},g=y=>{var n;return(n=b.value)!=null&&n.length?b.value.some(C=>{var T,h;if(C.paid_status===mt.UNPAID){if(((T=C.tables_selected)==null?void 0:T.length)>0&&C.tables_selected.some(M=>M.table_id===y))return!0;if(((h=C.hold_tables)==null?void 0:h.length)>0)return C.hold_tables.some(N=>N.table_id===y)}return!1}):!1},_=(y,n)=>{var C;(C=b.value)!=null&&C.length&&b.value.forEach(T=>{var h,N;((h=T.tables_selected)==null?void 0:h.length)>0&&T.tables_selected.forEach(M=>{M.table_id===y&&(M.in_use=n?1:0)}),((N=T.hold_tables)==null?void 0:N.length)>0&&T.hold_tables.forEach(M=>{M.table_id===y&&(M.in_use=n?1:0)})})};return{loading:a,error:o,getTables:u,isTableOccupied:g,setTableOccupancy:_,releaseTablesAfterPayment:async y=>{if(!(!y||!y.length)){a.value=!0,o.value=null;try{s.info("Releasing tables after payment:",y),y.forEach(C=>{_(C.table_id||C.id,!1)}),await i.fetchHoldInvoices();const n=y.filter(C=>g(C.table_id||C.id));n.length>0&&s.warn("Some tables still appear occupied:",n),s.info("Tables released successfully")}catch(n){throw o.value=n.message,s.error("Failed to release tables:",n),n}finally{a.value=!1}}},selectedCashier:f,currentCashRegister:m}}const ma=a=>a.toISOString().split("T")[0],Us=a=>new Date(a).toLocaleDateString(),zs=a=>se.format(a),Rs=a=>se.toCents(a),Ls=a=>a.type&&Object.values(ct).includes(a.type)?a.type:ct.DINE_IN,qs=a=>({[ct.DINE_IN]:"primary",[ct.TO_GO]:"success",[ct.DELIVERY]:"warning",[ct.PICKUP]:"info"})[a]||"grey",Jt="core_pos_order_history";function Ms(){const a=gt(),o=He(),{holdInvoices:r,holdInvoiceSettings:i}=Pt(a),{fetchPaymentMethods:d}=qt(),{releaseTablesAfterPayment:b}=Mt(),f=D(!1),m=D(null),I=D(null),c=D(null),u=D(""),g=D("ALL"),_=D("ALL"),V=D(!1),y=D(null),n=D(null),C=D([]),T=()=>{var P;try{const K=localStorage.getItem(Jt);if(K){const j=JSON.parse(K);Array.isArray(j)?(C.value=j,s.info("Initialized order history from localStorage:",{count:C.value.length,firstItem:(P=C.value[0])==null?void 0:P.id})):(s.warn("Stored history is not an array, initializing empty array"),C.value=[])}else C.value=[],s.info("No stored history found, initialized empty array")}catch(K){s.error("Failed to initialize order history from localStorage:",K),C.value=[]}},h=()=>{var P,K;try{return C.value=[],localStorage.removeItem(Jt),s.info("Order history cleared successfully"),(P=window.toastr)==null||P.success("Order history cleared successfully"),!0}catch(j){return s.error("Failed to clear order history:",j),(K=window.toastr)==null||K.error("Failed to clear order history"),!1}},N=[{title:"All Orders",value:"ALL"},{title:"Dine In",value:Ae.DINE_IN},{title:"To Go",value:Ae.TO_GO},{title:"Delivery",value:Ae.DELIVERY},{title:"Pickup",value:Ae.PICKUP}],M=async P=>{var K,j,w,ne,ce;console.log("Payment completion handler called with result:",P);try{if(s.info("Payment completed successfully:",P),!((K=n.value)!=null&&K.id))throw new Error("Original hold invoice not found");const oe={...n.value,paid_status:"PAID",paid_at:new Date().toISOString(),payment_details:P,tables_selected:n.value.tables_selected||[],hold_tables:n.value.hold_tables||[]};C.value.unshift(oe);try{localStorage.setItem(Jt,JSON.stringify(C.value)),s.debug("Order history updated in localStorage")}catch(U){s.error("Failed to persist order history:",U)}if(!await x(n.value.id))throw new Error("Failed to delete original order");return(j=oe.tables_selected)!=null&&j.length&&await b(oe.tables_selected),(w=oe.hold_tables)!=null&&w.length&&await b(oe.hold_tables),(ne=window.toastr)==null||ne.success("Payment processed successfully"),y.value=null,n.value=null,V.value=!1,!0}catch(oe){return console.error("Failed to complete payment process:",oe),s.error("Failed to complete payment process:",oe),(ce=window.toastr)==null||ce.error("Failed to complete payment process"),!1}},X=async P=>{var K;try{if(!(P!=null&&P.id))throw new Error("Invalid invoice: missing ID");return c.value=P.id,n.value=P,console.log("Fetching payment methods"),await d(),console.log("Setting up payment dialog"),y.value={invoice:P,invoicePrefix:P.invoice_prefix||"INV",nextInvoiceNumber:P.id},V.value=!0,{success:!0}}catch(j){return console.error("Failed to prepare for payment:",j),s.error("Failed to prepare for payment:",j),(K=window.toastr)==null||K.error(j.message||"Failed to prepare for payment"),{success:!1,error:j.message}}finally{c.value=null}},v=P=>{if(!(P!=null&&P.id))throw new Error("Invalid invoice: missing ID");if(!Array.isArray(P.hold_items))throw new Error("Invalid invoice: missing items array");if(!P.type)throw new Error("Invalid invoice: missing order type");return!0},p=P=>{if(!P.item_id||!P.name)throw new Error(`Invalid item data: missing required fields for item ${P.name||"unknown"}`);if(typeof P.price>"u"||P.price===null)throw new Error(`Invalid item data: missing price for item ${P.name}`);if(!P.quantity)throw new Error(`Invalid item data: missing quantity for item ${P.name}`);return!0},R=async P=>{var K;s.startGroup("Processing cart properties");try{if(P.discount_type&&P.discount&&(s.debug("Setting discount:",{type:P.discount_type,amount:P.discount}),await o.setDiscount(P.discount_type,Number(P.discount))),P.tip_type&&P.tip&&(s.debug("Setting tip:",{type:P.tip_type,amount:P.tip}),await o.setTip(P.tip_type,Number(P.tip))),s.debug("Setting order type:",P.type),await o.setType(P.type),P.notes){s.debug("Processing order notes");try{const j=JSON.parse(P.notes),w=yt(P.notes),ne={orderInfo:{customer:((K=j.orderInfo)==null?void 0:K.customer)||j.customer||{}},customerNotes:w};await o.setNotes(JSON.stringify(ne))}catch(j){s.warn("Failed to parse notes, using raw value:",j),await o.setNotes(P.notes)}}if(s.debug("Setting reference information:",{id:P.id,description:P.description}),typeof o.setHoldInvoiceId!="function")throw new Error("setHoldInvoiceId is not defined in cart store");if(typeof o.setHoldOrderDescription!="function")throw new Error("setHoldOrderDescription is not defined in cart store");await o.setHoldInvoiceId(P.id),await o.setHoldOrderDescription(P.description),s.debug("Cart properties processed successfully")}catch(j){throw s.error("Failed to process cart properties:",j),j}finally{s.endGroup()}},me=async P=>{var j,w,ne,ce,oe;m.value=P.id,s.startGroup("Loading held order");const K=ue=>{const U=Number(ue);if(s.debug("Normalizing price:",{original:ue,asNumber:U,hasDecimals:U%1!==0,isLargeNumber:U>1e3}),Number.isNaN(U))return s.warn("Invalid price value:",ue),0;if(U>100&&Number.isInteger(U)){const L=U/100;return s.debug("Normalized large integer price:",{original:U,normalized:L,formatted:se.format(L)}),L}return U%1!==0?(s.debug("Price already has decimals, keeping as is:",{price:U,formatted:se.format(U)}),U):(s.debug("Small integer price, keeping as is:",{price:U,formatted:se.format(U)}),U)};try{v(P),s.debug("Loading order details:",{id:P.id,description:P.description,type:P.type,itemCount:(j=P.hold_items)==null?void 0:j.length}),await o.clearCart(),s.debug("Cart cleared successfully"),s.debug(`Processing ${P.hold_items.length} items`);for(const ue of P.hold_items){p(ue);const U=K(ue.price);s.debug("Processing item price:",{itemName:ue.name,originalPrice:ue.price,normalizedPrice:U,formattedPrice:se.format(U)});const L={id:ue.item_id,name:ue.name,description:ue.description,price:U,unit_name:ue.unit_name,fromHeldOrder:!0};s.debug("Adding item to cart:",{productId:L.id,name:L.name,quantity:ue.quantity,price:L.price,formattedPrice:se.format(L.price)});try{await o.addItem(L,Number(ue.quantity))}catch(_e){throw new Error(`Failed to add item ${L.name} to cart: ${_e.message}`)}}return await R(P),s.info("Order loaded successfully:",{id:P.id,description:P.description,type:P.type,itemCount:P.hold_items.length,cartState:{items:(w=o.items)==null?void 0:w.length,total:o.total,holdInvoiceId:o.holdInvoiceId}}),!0}catch(ue){return s.error("Failed to load order:",{error:ue.message,errorStack:ue.stack,invoice:{id:P==null?void 0:P.id,type:P==null?void 0:P.type,itemCount:(ne=P==null?void 0:P.hold_items)==null?void 0:ne.length},cartStore:{methods:Object.keys(o),state:{items:(ce=o.items)==null?void 0:ce.length,total:o.total,holdInvoiceId:o.holdInvoiceId}}}),(oe=window.toastr)==null||oe.error(ue.message||"Failed to load order"),!1}finally{m.value=null,s.endGroup()}},x=async P=>{var K,j;try{if(!P)throw new Error("Invalid invoice ID");I.value=P,s.debug("Deleting hold invoice:",P);const w=await a.deleteHoldInvoice(P);if(!w.success)throw new Error(w.message||"Failed to delete order");return(K=window.toastr)==null||K.success("Order deleted successfully"),!0}catch(w){return s.error("Failed to delete order:",w),(j=window.toastr)==null||j.error(w.message||"Failed to delete order"),!1}finally{I.value=null}},H=async()=>{var P;try{f.value=!0,await a.fetchHoldInvoices()}catch(K){s.error("Failed to fetch hold invoices:",K),(P=window.toastr)==null||P.error("Failed to fetch hold invoices")}finally{f.value=!1}};return wt(()=>{T()}),{loading:f,loadingOrder:m,deletingOrder:I,convertingOrder:c,search:u,selectedType:g,selectedStatus:_,orderTypes:N,holdInvoices:r,orderHistory:C,filteredInvoices:te(()=>r.value),showPaymentDialog:V,currentInvoice:y,getOrderType:Ls,getOrderTypeColor:qs,formatDate:Us,formatCurrency:zs,convertToInvoice:X,loadOrder:me,deleteOrder:x,fetchHoldInvoices:H,handlePaymentComplete:M,clearOrderHistory:h}}function js(){const a=D(!1),o=D([]),r=D(null),i=D({total:0,currentPage:1,lastPage:1});return{loading:a,invoices:o,error:r,pagination:i,fetchInvoices:async({customerId:b="",status:f="",fromDate:m="",toDate:I="",invoiceNumber:c="",customcode:u="",unit:g="",orderByField:_="invoice_number",orderBy:V="desc",limit:y="all",page:n=1}={})=>{var C,T,h,N,M,X,v;a.value=!0,r.value=null;try{s.debug("Fetching invoices with params:",{customerId:b,status:f,fromDate:m,toDate:I,invoiceNumber:c,customcode:u,unit:g,orderByField:_,orderBy:V,limit:y,page:n});const p=await Ue.get("invoices",{params:{is_invoice_pos:1,customer_id:b,status:f,from_date:m,to_date:I,invoice_number:c,customcode:u,unit:g,orderByField:_,orderBy:V,v2:!0,page:n}});s.debug("Raw API response:",{status:p==null?void 0:p.status,hasData:!!(p!=null&&p.data),dataStructure:{hasInvoices:!!((C=p==null?void 0:p.data)!=null&&C.invoices),hasInvoicesData:!!((h=(T=p==null?void 0:p.data)==null?void 0:T.invoices)!=null&&h.data),invoicesDataType:typeof((M=(N=p==null?void 0:p.data)==null?void 0:N.invoices)==null?void 0:M.data)}});const{data:R,total:me,current_page:x,last_page:H}=((X=p==null?void 0:p.data)==null?void 0:X.invoices)||{};return s.debug("Extracted API response data:",{total:me,currentPage:x,lastPage:H,dataCount:R==null?void 0:R.length,sample:R!=null&&R[0]?{id:R[0].id,invoice_number:R[0].invoice_number,status:R[0].status,paid_status:R[0].paid_status}:null}),i.value={total:me||0,currentPage:x||1,lastPage:H||1},o.value=(R||[]).map(P=>({...P,invoice_number:P.invoice_number||"-",status:P.status||"PENDING",paid_status:P.paid_status||"UNPAID",total:Number(P.total||0),customer:P.customer||{name:"Walk-in Customer"}})),s.info("Invoices fetched successfully:",{total:o.value.length,firstInvoice:(v=o.value[0])==null?void 0:v.id}),{success:!0,data:o.value}}catch(p){const R=et(p);return r.value=R.message,s.error("Failed to fetch invoices:",{error:R,params}),{success:!1,message:R.message||"Failed to fetch invoices",errors:R.errors||{}}}finally{a.value=!1}}}}const Gs={class:"held-orders-table"},Hs={class:"filters-container"},Bs={class:"filters-row"},Ks={class:"search-field"},Ys={class:"filter-controls"},Qs={class:"table-container"},Ws={key:0,class:"text-center actions-col"},Js={class:"text-center"},Xs={class:"text-right"},Zs={key:0,class:"text-center"},er={class:"actions-wrapper"},tr={key:0,class:"pagination-wrapper"},ar={__name:"HeldOrdersTable",props:{invoices:{type:Array,required:!0},loadingOrder:{type:[String,Number],default:null},convertingOrder:{type:[String,Number],default:null},deletingOrder:{type:[String,Number],default:null},getOrderType:{type:Function,required:!0},getOrderTypeColor:{type:Function,required:!0},formatDate:{type:Function,required:!0},formatCurrency:{type:Function,required:!0},hideActions:{type:Boolean,default:!1},showPagination:{type:Boolean,default:!1},page:{type:Number,default:1},totalPages:{type:Number,default:1}},emits:["load","convert","delete","update:page","refresh"],setup(a,{emit:o}){const r=D(""),i=D("all"),d=[{title:"All",value:"all"},{title:"Dine In",value:"dine_in"},{title:"To Go",value:"to_go"},{title:"Delivery",value:"delivery"},{title:"Pickup",value:"pickup"}],b=D("all"),f=[{title:"All",value:"all"},{title:"Draft",value:"DRAFT"},{title:"Sent",value:"SENT"},{title:"Completed",value:"COMPLETED"},{title:"Cancelled",value:"CANCELLED"}],m=D("all"),I=[{title:"All",value:"all"},{title:"Paid",value:"PAID"},{title:"Unpaid",value:"UNPAID"},{title:"Partially Paid",value:"PARTIALLY_PAID"}],c=a,u=(y,n)=>{var C;console.log(`[HeldOrdersTable] ${y}:`,{id:n.id,type:c.getOrderType(n),description:n.description,itemCount:((C=n.hold_items)==null?void 0:C.length)||0,total:n.total,formattedTotal:c.formatCurrency(n.total/100)})};D(!1),D(!1),D(null);const g=y=>{const n=yt(y.notes);return n&&n.trim().length>0},_=y=>{const n=yt(y.notes);return n?`${y.description}

Notes: ${n}`:y.description},V=y=>{switch(y){case"PAID":return"success";case"UNPAID":return"warning";default:return"info"}};return we(()=>c.loadingOrder,(y,n)=>{if(y){const C=c.invoices.find(T=>T.id===y);C&&u("Loading order",C)}}),we(()=>c.convertingOrder,(y,n)=>{if(y){const C=c.invoices.find(T=>T.id===y);C&&u("Converting order",C)}}),(y,n)=>($(),ee("div",Gs,[l("div",Hs,[l("div",Bs,[l("div",Ks,[e(Se,{modelValue:r.value,"onUpdate:modelValue":n[0]||(n[0]=C=>r.value=C),"prepend-inner-icon":"mdi-magnify",label:"Search orders",variant:"outlined",density:"compact","hide-details":"",class:"search-input"},null,8,["modelValue"])]),l("div",Ys,[e(ut,{modelValue:i.value,"onUpdate:modelValue":n[1]||(n[1]=C=>i.value=C),items:d,label:"Type",variant:"outlined",density:"compact","hide-details":"",class:"filter-select","prepend-inner-icon":"mdi-filter"},null,8,["modelValue"]),e(ut,{modelValue:b.value,"onUpdate:modelValue":n[2]||(n[2]=C=>b.value=C),items:f,label:"Status",variant:"outlined",density:"compact","hide-details":"",class:"filter-select","prepend-inner-icon":"mdi-check-circle-outline"},null,8,["modelValue"]),e(ut,{modelValue:m.value,"onUpdate:modelValue":n[3]||(n[3]=C=>m.value=C),items:I,label:"Payment",variant:"outlined",density:"compact","hide-details":"",class:"filter-select","prepend-inner-icon":"mdi-cash"},null,8,["modelValue"])])])]),l("div",Qs,[e(ea,{"fixed-header":"",class:"orders-table"},{default:t(()=>[l("thead",null,[l("tr",null,[n[5]||(n[5]=l("th",{class:"text-left order-type-col"},"Order Type",-1)),n[6]||(n[6]=l("th",{class:"text-left description-col"},"Description",-1)),n[7]||(n[7]=l("th",{class:"text-left created-col"},"Created",-1)),n[8]||(n[8]=l("th",{class:"text-center items-col"},"Items",-1)),n[9]||(n[9]=l("th",{class:"text-right total-col"},"Total",-1)),n[10]||(n[10]=l("th",{class:"text-left status-col"},"Status",-1)),a.hideActions?ve("",!0):($(),ee("th",Ws,"Actions"))])]),l("tbody",null,[($(!0),ee(xe,null,Ye(a.invoices,C=>{var T;return $(),ee("tr",{key:C.id},[l("td",null,[e(vt,{color:a.getOrderTypeColor(a.getOrderType(C)),size:"small",class:"order-type-chip",variant:"flat"},{default:t(()=>[S(A(a.getOrderType(C)),1)]),_:2},1032,["color"])]),l("td",{class:"text-truncate",style:oo({maxWidth:y.$vuetify.display.mobile?"150px":"200px"})},[e($t,{text:_(C),location:"top","open-delay":"300"},{activator:t(({props:h})=>[l("span",pt({ref_for:!0},h,{class:"cursor-help"}),[S(A(C.description)+" ",1),g(C)?($(),re(le,{key:0,size:"x-small",color:"grey-darken-1",class:"ml-1"},{default:t(()=>n[11]||(n[11]=[S(" mdi-note-text-outline ")])),_:1})):ve("",!0)],16)]),_:2},1032,["text"])],4),l("td",null,A(a.formatDate(C.created_at)),1),l("td",Js,A(((T=C.hold_items)==null?void 0:T.length)||0),1),l("td",Xs,A(a.formatCurrency(C.total/100)),1),l("td",null,[e(vt,{color:V(C.paid_status),size:"small",variant:"flat",class:"status-chip"},{default:t(()=>[S(A(C.paid_status||"UNPAID"),1)]),_:2},1032,["color"])]),a.hideActions?ve("",!0):($(),ee("td",Zs,[l("div",er,[e(Q,{size:"small",color:"info",variant:"flat",onClick:Ct(h=>y.$emit("load",C),["prevent"]),loading:a.loadingOrder===C.id,disabled:a.convertingOrder===C.id||a.deletingOrder===C.id||C.paid_status==="PAID"},{default:t(()=>[e(le,{size:"small",class:"mr-1"},{default:t(()=>n[12]||(n[12]=[S("mdi-cart-arrow-down")])),_:1}),n[13]||(n[13]=S(" LOAD "))]),_:2},1032,["onClick","loading","disabled"]),e(Q,{size:"small",color:"success",variant:"flat",onClick:Ct(h=>y.$emit("convert",C),["prevent"]),loading:a.convertingOrder===C.id,disabled:a.loadingOrder===C.id||a.deletingOrder===C.id||C.paid_status==="PAID"},{default:t(()=>[e(le,{size:"small",class:"mr-1"},{default:t(()=>n[14]||(n[14]=[S("mdi-cash-register")])),_:1}),n[15]||(n[15]=S(" PAY "))]),_:2},1032,["onClick","loading","disabled"]),e(Q,{size:"small",color:"error",variant:"flat",onClick:h=>y.$emit("delete",C),loading:a.deletingOrder===C.id,disabled:a.loadingOrder===C.id||a.convertingOrder===C.id||C.paid_status==="PAID"},{default:t(()=>[e(le,{size:"small",class:"mr-1"},{default:t(()=>n[16]||(n[16]=[S("mdi-delete")])),_:1}),n[17]||(n[17]=S(" DELETE "))]),_:2},1032,["onClick","loading","disabled"])])]))])}),128))])]),_:1})]),a.showPagination?($(),ee("div",tr,[e(ta,{"model-value":a.page,"onUpdate:modelValue":n[4]||(n[4]=C=>y.$emit("update:page",C)),length:a.totalPages,"total-visible":7,rounded:"circle"},null,8,["model-value","length"])])):ve("",!0)]))}},or=Te(ar,[["__scopeId","data-v-986591ae"]]);const sr={class:"text-body-2"},rr={__name:"DeleteConfirmationDialog",props:{modelValue:{type:Boolean,required:!0},loading:{type:Boolean,default:!1},orderDescription:{type:String,default:""}},emits:["update:modelValue","confirm"],setup(a){return(o,r)=>($(),re(ze,{"model-value":a.modelValue,"onUpdate:modelValue":r[2]||(r[2]=i=>o.$emit("update:modelValue",i)),"max-width":"460",persistent:"",transition:"dialog-bottom-transition"},{default:t(()=>[e(Pe,null,{default:t(()=>[e(Je,{color:"error",density:"comfortable"},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>[e(le,{start:"",icon:"mdi-alert",class:"mr-2"}),r[3]||(r[3]=S(" Confirm Delete "))]),_:1})]),_:1}),e(ke,{class:"pt-4"},{default:t(()=>[r[5]||(r[5]=l("p",{class:"text-body-1 mb-4"},"Are you sure you want to delete this order? This action cannot be undone.",-1)),a.orderDescription?($(),re(at,{key:0,type:"warning",variant:"tonal",border:"start",class:"mb-0",density:"comfortable"},{prepend:t(()=>[e(le,{icon:"mdi-information",class:"mb-1"})]),default:t(()=>[r[4]||(r[4]=l("div",{class:"text-subtitle-2 font-weight-medium mb-1"},"Order Details",-1)),l("div",sr,A(a.orderDescription),1)]),_:1})):ve("",!0)]),_:1}),e(bt),e(st,{class:"pa-4"},{default:t(()=>[e(Ne),e(Q,{color:"grey-darken-1",variant:"text",onClick:r[0]||(r[0]=i=>o.$emit("update:modelValue",!1)),disabled:a.loading,class:"mr-2"},{default:t(()=>r[6]||(r[6]=[S(" Cancel ")])),_:1},8,["disabled"]),e(Q,{color:"error",variant:"elevated",onClick:r[1]||(r[1]=i=>o.$emit("confirm")),loading:a.loading,disabled:a.loading},{default:t(()=>[e(le,{start:"",icon:"mdi-delete",class:"mr-1"}),r[7]||(r[7]=S(" Delete Order "))]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}},lr=Te(rr,[["__scopeId","data-v-4daac1a8"]]),nr=a=>{s.debug("Validating invoice data:",a);const r=["invoice_number","invoice_date","due_date","total","sub_total","items","user_id","type","paid_status"].filter(i=>!a[i]);if(r.length>0)throw new Error(`Missing required fields: ${r.join(", ")}`);if(!Array.isArray(a.items)||a.items.length===0)throw new Error("Invoice must have at least one item");if(a.items.forEach((i,d)=>{if(!i.item_id||!i.name||!i.price||!i.quantity)throw new Error(`Invalid item data at index ${d}`)}),!Object.values(Ae).includes(a.type))throw new Error(`Invalid order type: ${a.type}. Must be one of: ${Object.values(Ae).join(", ")}`);if(!Object.values(mt).includes(a.paid_status))throw new Error(`Invalid paid status: ${a.paid_status}. Must be either PAID or UNPAID`);return s.debug("Invoice data validation passed"),!0},Ta=async a=>{var o,r,i,d,b,f;if(!a||typeof a!="object")throw new Error("Invalid invoice data provided");if(a.invoice&&typeof a.invoice=="object"&&(a=a.invoice),!a.id){const m=new Error("Invalid invoice: missing ID");throw s.error("[InvoiceConverter] Invalid invoice data:",{invoice:a}),m}s.info("[InvoiceConverter] Starting conversion process:",{id:a.id,description:a.description,total:a.total,items:(o=a.hold_items)==null?void 0:o.length});try{if(!a||typeof a!="object")throw new Error("Invalid invoice data provided");s.debug("Starting invoice conversion with data:",{id:a.id,type:a.type,items:((r=a.hold_items)==null?void 0:r.length)||0}),!a.items&&a.hold_items?a.items=a.hold_items:a.items||(a.items=[]),console.log("Fetching company settings");const m=await tt.getCompanySettings();if(console.log("Company settings received:",m),!m.invoice_auto_generate)throw new Error("Invoice auto-generate setting is required but missing");const I=m.invoice_issuance_period||"7";let c;if(m.invoice_auto_generate==="YES"){console.log("Getting next invoice number");const X=await tt.invoice.getNextNumber();if(console.log("Next number response:",X),!(X!=null&&X.invoice_number))throw new Error("Failed to get next invoice number");c=`${X.prefix}-${X.nextNumber}`}else throw new Error("Manual invoice number entry is not supported");const u=new Date,g=new Date(u);g.setDate(g.getDate()+parseInt(I));let _={};try{a.notes&&(_=JSON.parse(a.notes))}catch(X){console.error("Failed to parse table data from notes:",X)}console.log("Formatting items data");const V=a.items.map(X=>{const v=Math.round(Number(X.price)),p=parseInt(X.quantity),R=v*p;return{item_id:Number(X.item_id),name:X.name,description:X.description||"",price:v,quantity:p,unit_name:X.unit_name||"units",sub_total:R,total:R,discount:"0",discount_val:0,discount_type:"fixed",tax:Math.round(Number(X.tax||0)),retention_amount:0,retention_concept:null,retention_percentage:null,retentions_id:null}}),y=a.tip?String(Math.round(Number(a.tip))):"0";console.log("Formatted tip value:",y),console.log("Preparing invoice data"),console.log("Invoice data",a);const n=Math.round(Number(a.sub_total||0)),C=Math.round(Number(a.tax||0)),T=Math.round(Number(a.total||n+C)),h={invoice_date:ma(u),due_date:ma(g),invoice_number:c,sub_total:n,total:T,tax:C,items:V,tables_selected:a.tables_selected||[],hold_tables:a.hold_tables||[],avalara_bool:!1,banType:!0,package_bool:!1,print_pdf:!1,save_as_draft:!1,send_email:!1,not_charge_automatically:!1,is_hold_invoice:!0,is_invoice_pos:1,is_pdf_pos:m.pdf_format_pos==="1",is_prepared_data:!0,invoice_template_id:1,invoice_pbx_modify:0,hold_invoice_id:Math.round(Number(a.id||0)),store_id:Math.round(Number(a.store_id||0)),cash_register_id:Math.round(Number(a.cash_register_id||0)),user_id:Math.round(Number(a.user_id||1)),due_amount:Math.round(Number(T)),discount:String(Math.round(Number(a.discount||0))),discount_type:a.discount_type||"fixed",discount_val:Math.round(Number(Rs(a.discount_val||0))),discount_per_item:m.discount_per_item||"NO",tip:y,tip_type:a.tip_type||"fixed",tip_val:a.tip_val||0,status:"SENT",paid_status:a.paid_status||mt.UNPAID,type:a.type||Ae.TO_GO,items:V,taxes:a.taxes||[],packages:[],tables_selected:_.tables||[],notes:"",description:a.description||`Order #${a.id}`};nr(h),console.log("Creating invoice with data:",h);const N=await tt.invoice.create(h);if(console.log("Invoice creation response:",N),(d=(i=N==null?void 0:N.result)==null?void 0:i.invoice)!=null&&d.id)N.invoice=N.result.invoice;else if(!((b=N==null?void 0:N.invoice)!=null&&b.id))throw new Error("Failed to create invoice: No valid invoice ID");N.invoice.hold_invoice_id=a.id,console.log("Fetching created invoice details");const M=await tt.invoice.getById(N.invoice.id);if(!M)throw new Error("Failed to fetch created invoice details");return M.tip&&(M.tip=String(Math.round(Number(M.tip)))),M.hold_invoice_id=a.id,console.log("Created invoice details:",M),s.info("Order converted to invoice successfully:",M.id),{success:!0,invoice:M}}catch(m){return console.error("Failed to convert order to invoice:",m),s.error("Failed to convert order to invoice:",m),(f=window.toastr)==null||f.error(m.message||"Failed to convert order to invoice"),{success:!1,error:m.message}}};const ir={key:0,class:"d-flex justify-center align-center pa-4"},dr=["src"],ur={__name:"PdfViewerDialog",props:{modelValue:{type:Boolean,default:!1},pdfUrl:{type:String,required:!0},title:{type:String,default:"Invoice"}},emits:["update:modelValue","closed"],setup(a,{emit:o}){const r=a,i=o,d=D(r.modelValue),b=D(!0);we(()=>r.modelValue,c=>{d.value=c}),we(d,c=>{i("update:modelValue",c),c||i("closed")});const f=()=>{setTimeout(()=>{b.value=!1},500)};we(()=>r.pdfUrl,()=>{b.value=!0});const m=()=>{const c=document.querySelector("iframe");c&&c.contentWindow.print()},I=()=>{d.value=!1};return(c,u)=>($(),re(ze,{modelValue:d.value,"onUpdate:modelValue":u[0]||(u[0]=g=>d.value=g),"max-width":"1000px",persistent:""},{default:t(()=>[e(Pe,null,{default:t(()=>[e(Je,{color:"primary",dark:""},{default:t(()=>[e(Xe,null,{default:t(()=>[S(A(a.title),1)]),_:1}),e(Ne),e(Q,{icon:"",onClick:m},{default:t(()=>[e(le,null,{default:t(()=>u[1]||(u[1]=[S("mdi-printer")])),_:1})]),_:1}),e(Q,{icon:"",onClick:I},{default:t(()=>[e(le,null,{default:t(()=>u[2]||(u[2]=[S("mdi-close")])),_:1})]),_:1})]),_:1}),e(ke,{class:"pdf-container"},{default:t(()=>[b.value?($(),ee("div",ir,[e(lt,{indeterminate:"",color:"primary"})])):ve("",!0),ra(l("iframe",{src:a.pdfUrl,width:"100%",height:"600",onLoad:f},null,40,dr),[[so,!b.value]])]),_:1}),e(st,{class:"d-flex justify-space-between pa-4"},{default:t(()=>[e(Q,{color:"primary",variant:"outlined",onClick:m,disabled:b.value},{default:t(()=>[e(le,{left:""},{default:t(()=>u[3]||(u[3]=[S("mdi-printer")])),_:1}),u[4]||(u[4]=S(" Print "))]),_:1},8,["disabled"]),e(Q,{color:"grey",variant:"outlined",onClick:I},{default:t(()=>u[5]||(u[5]=[S(" Close ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},jt=Te(ur,[["__scopeId","data-v-e122c84c"]]);const cr={class:"payment-dialog-wrapper"},mr={class:"payment-content"},pr={key:0,class:"loading-state"},fr={class:"d-flex justify-space-between mb-2"},vr={class:"d-flex justify-space-between mb-2"},yr={key:0,class:"d-flex justify-space-between mb-2"},gr={class:"d-flex justify-space-between mb-2"},_r={class:"d-flex justify-space-between"},br={key:0,class:"active-payments-section"},hr={class:"d-flex align-center mb-4"},wr={class:"text-h6"},Ir={class:"amount-display"},Pr={class:"amount-display__amount"},Cr={key:0,class:"amount-display__error"},Or={key:0,class:"mb-4"},Sr={class:"amount-display"},xr={class:"amount-display__amount"},Dr=["onUpdate:modelValue","onInput"],Vr={key:0,class:"amount-display__error"},Tr={key:1,class:"text-caption mb-2"},$r={class:"d-flex justify-space-between"},kr={class:"text-grey"},Nr={class:"d-flex justify-space-between mb-2"},Er={key:2,class:"d-flex justify-space-between mb-2"},Ar={key:3,class:"d-flex justify-space-between mb-2"},Fr={key:4,class:"d-flex justify-space-between"},Ur={class:"process-payment-footer"},zr={class:"d-flex justify-space-between"},Rr={__name:"PaymentDialog",props:{modelValue:Boolean,invoice:{type:Object,required:!1,default:()=>({})}},emits:["update:modelValue","paymentComplete"],setup(a,{emit:o}){const r=o,i=a,d=te(()=>{var O,z,Ie;const B=((z=(O=i.invoice)==null?void 0:O.invoice)==null?void 0:z.total)||0;return console.log("PaymentDialog - Raw invoice total:",{rawTotal:B,invoice:(Ie=i.invoice)==null?void 0:Ie.invoice,isDollarAmount:se.isInDollars(B),isCentsAmount:B>100}),B}),{loading:b,error:f,paymentMethods:m,settings:I,createPayment:c,fetchPaymentMethods:u,fetchSettings:g,getDenominations:_,calculateFees:V,getPaymentMethod:y,isCashOnly:n}=qt(),{loading:C,error:T,releaseTablesAfterPayment:h}=Mt(),N=te(()=>b.value||C.value),M=te(()=>f.value||T.value),X=D(!1),v=D([]),p=D(!1),R=D(""),me=()=>{R.value=""},x=D(!1),H=[15,18,20,25],P=D(null),K=D(""),j=D(0),w=D("percentage"),ne=te(()=>{var B,O,z,Ie;return((O=(B=i.invoice)==null?void 0:B.invoice)==null?void 0:O.invoice_number)||`${(z=i.invoice)==null?void 0:z.invoicePrefix}-${(Ie=i.invoice)==null?void 0:Ie.nextInvoiceNumber}`||""}),ce=te(()=>{const B=P.value||Number(K.value)||0,O=se.toDollars(d.value),z=Math.round(O*(B/100)*100);return console.log("PaymentDialog - Tip calculation:",{percent:B,invoiceTotalInCents:d.value,invoiceTotalInDollars:O,calculatedTipInCents:z}),z}),oe=te({get:()=>i.modelValue,set:B=>r("update:modelValue",B)}),ue=te(()=>{const B=v.value.reduce((z,Ie)=>z+Ie.amount,0),O=d.value+j.value-B;return console.log("PaymentDialog - Remaining amount:",{invoiceTotalInCents:d.value,tipAmountInCents:j.value,totalPaidInCents:B,remainingInCents:O}),O});te(()=>v.value.reduce((B,O)=>B+O.amount,0)),te(()=>v.value.reduce((B,O)=>B+(O.fees||0),0));const U=te(()=>ue.value>0&&v.value.length<m.value.length),L=B=>!B.displayAmount||Number(B.displayAmount)<=0?!1:Number(B.displayAmount)===se.toDollars(d.value+j.value),_e=B=>B.displayReceived?Number(B.displayReceived)>=Number(B.displayAmount):!1,ye=te(()=>v.value.every(B=>!(!B.method_id||!B.amount||n(B.method_id)&&!B.received||!L(B)||n(B.method_id)&&!_e(B)))&&ue.value===0),De=B=>(console.log("PaymentDialog - Formatting currency:",{inputAmount:B,isDollarAmount:se.isInDollars(B),isCentsAmount:B>100,formattedResult:se.format(B)}),se.format(B)),G=B=>{const O=y(B);return(O==null?void 0:O.IsPaymentFeeActive)==="YES"},E=(B,O)=>{const z=y(B);if(!(z!=null&&z.registrationdatafees))return"";const Ie=z.registrationdatafees;switch(Ie.type){case"FIXED":return`Fixed fee: ${De(Ie.value)}`;case"PERCENTAGE":return`${Ie.value}% of transaction amount`;case"FIXED_PLUS_PERCENTAGE":return`${De(Ie.value.fixed)} + ${Ie.value.percentage}% of transaction amount`;default:return""}},Z=B=>({Cash:"mdi-cash","Credit Card":"mdi-credit-card","Debit Card":"mdi-credit-card-outline",Check:"mdi-checkbox-marked-circle-outline","Gift Card":"mdi-gift","Mobile Payment":"mdi-cellphone","Bank Transfer":"mdi-bank"})[B]||"mdi-currency-usd",ge=B=>v.value.some(O=>O.method_id===B),Re=B=>ge(B)||v.value.length>=m.value.length,Le=B=>{if(ge(B)||Re(B))return;const O=ue.value,z=se.toDollars(O).toString();v.value.push({method_id:B,amount:O,displayAmount:z,received:O,displayReceived:z,returned:0,fees:0}),Ve(v.value.length-1)},$e=(B,O)=>{var k;const z=v.value[O],Ie=z.displayReceived?Number(z.displayReceived):0,Qe=Number(B.amount),J=Ie+Qe;z.displayReceived=J.toFixed(2),z.received=se.toCents(z.displayReceived),Ee(O),(k=window.navigator)!=null&&k.vibrate&&window.navigator.vibrate(50)},Ee=B=>{const O=v.value[B];if(!O.displayReceived||!O.displayAmount)return;const z=se.toCents(O.displayReceived),Ie=O.amount;O.received=z,z>=Ie?O.returned=z-Ie:O.returned=0},Ve=B=>{const O=v.value[B];if(!O)return;const z=d.value+j.value;console.log("PaymentDialog - Validating payment amount:",{paymentIndex:B,totalInCents:z,totalInDollars:se.toDollars(z),currentPayment:{...O}}),O.displayAmount=se.toDollars(z).toString(),O.amount=z,G(O.method_id)&&(O.fees=V(O.method_id,O.amount));const Ie=m.value.find(Qe=>Qe.id===O.method_id);if((Ie==null?void 0:Ie.only_cash)===1){const Qe=se.toCents(O.displayReceived);console.log("PaymentDialog - Cash payment received:",{displayReceived:O.displayReceived,receivedInCents:Qe,paymentAmount:O.amount}),O.received=Qe,O.returned=Math.max(0,O.received-O.amount)}else O.displayReceived=O.displayAmount,O.received=O.amount,O.returned=0},qe=()=>{v.value.push({method_id:null,amount:0,displayAmount:se.toDollars(d.value+j.value).toString(),received:0,displayReceived:"0",returned:0,fees:0})},Ce=B=>{v.value.splice(B,1),v.value.forEach((O,z)=>Ve(z))},he=()=>{X.value||(oe.value=!1)},Ze=B=>{P.value=B,K.value=""},Y=()=>{P.value=null},q=()=>{x.value=!1,P.value=null,K.value=""},be=()=>{j.value=ce.value,w.value="percentage",x.value=!1,v.value.forEach((B,O)=>Ve(O))},ie=async()=>{var B,O,z,Ie,Qe,J,k,W;if(console.log(" [Payment] Starting payment processing...",{isValid:ye.value,processing:X.value,invoiceTotal:d.value,tipAmount:j.value,payments:v.value}),!ye.value||X.value){console.log(" [Payment] Cannot process - validation failed or already processing");return}X.value=!0;try{console.log(" [Payment] Starting invoice creation with props:",{invoice:i.invoice,hasInvoiceData:!!((B=i.invoice)!=null&&B.invoice),invoiceTotal:d.value,tipAmount:j.value});const pe=i.invoice.invoice;if(!pe)throw new Error("Invoice data not provided");const nt=d.value+j.value;console.log(" [Payment] Prepared hold invoice data:",{id:pe.id,total:nt,originalTotal:pe.total,tipAmount:j.value});const It=P.value||Number(K.value)||0;pe.tip=String(Math.round(It)),pe.tip_type="percentage",pe.tip_val=j.value,pe.total=nt,pe.due_amount=nt,pe.sub_total=d.value,console.log("Tip values:",{percentage:pe.tip,type:pe.tip_type,amount:pe.tip_val,total:pe.total}),pe.is_hold_invoice=!1,pe.is_invoice_pos=1,pe.is_pdf_pos=!0,pe.package_bool=!1,pe.print_pdf=!1,pe.save_as_draft=!1,pe.send_email=!1,pe.not_charge_automatically=!1,pe.avalara_bool=!1,pe.banType=!0;const _t=new Date;pe.invoice_date=_t.toISOString().split("T")[0];const We=new Date(_t);We.setDate(We.getDate()+7),pe.due_date=We.toISOString().split("T")[0],console.log(" [Payment] Converting held order to invoice...");const Fe=await Ta(pe);if(console.log(" [Payment] Invoice creation result:",Fe),!Fe.success)throw console.error(" [Payment] Failed to create invoice:",Fe),new Error("Failed to create invoice");if(console.log("Created invoice:",Fe),i.createInvoiceOnly)try{const fe={...Fe.invoice,is_hold_invoice:!0,status:"HELD",description:Fe.invoice.description||"Delivery Order"};if(!(await tt.holdInvoice.create(fe)).success)throw new Error("Failed to add invoice to held orders");(O=window.toastr)==null||O.success("Invoice created and added to held orders"),r("payment-complete",!0),oe.value=!1;return}catch(fe){throw console.error("Failed to add to held orders:",fe),new Error("Failed to add invoice to held orders")}const Ot=v.value.map(fe=>({method_id:fe.method_id,amount:fe.amount,received:fe.received,returned:fe.returned,fees:fe.fees||0}));if(console.log(" [Payment] Formatted payments:",Ot),Ot.reduce((fe,Be)=>fe+Be.amount,0)!==nt)throw new Error("Payment amount must match invoice total including tip");console.log(" [Payment] Creating payment...");const it=await c(Fe.invoice,Ot);if(console.log(" [Payment] Payment creation result:",it),it!=null&&it.invoice_id){console.log(" [Invoice PDF] Starting PDF preparation",{paymentResult:it,invoiceResult:Fe});const fe=((z=Fe==null?void 0:Fe.invoice)==null?void 0:z.invoice)||(Fe==null?void 0:Fe.invoice);if(!(fe!=null&&fe.unique_hash)){console.error(" [Invoice PDF] Missing invoice hash:",fe),(Ie=window.toastr)==null||Ie.error("Could not generate invoice PDF");return}const Be=fe.invoicePdfUrl||`${"https://lajuanita.corebill.co/api/v1".replace("/api/v1","")}/invoices/pdf/${fe.unique_hash}`;console.log(" [Invoice PDF] Using invoice details:",{invoiceId:fe.id,invoiceHash:fe.unique_hash,directPdfUrl:fe.invoicePdfUrl,constructedUrl:Be,fullInvoice:fe}),console.log(" [Invoice PDF] Opening PDF viewer with URL:",Be),R.value=Be,p.value=!0}else console.error(" [Payment] Missing invoice ID in payment result:",it),(Qe=window.toastr)==null||Qe.error("Could not get invoice PDF");if(Fe.invoice.type==="DINE_IN"&&((J=Fe.invoice.tables_selected)!=null&&J.length))try{await h(Fe.invoice.tables_selected)}catch(fe){console.error("Failed to release tables:",fe),(k=window.toastr)==null||k.warning("Payment successful, but failed to update table status")}r("payment-complete",it),oe.value=!1}catch(pe){console.error(" [Payment] Payment failed:",pe),(W=window.toastr)==null||W.error(pe.message||"Failed to process payment")}finally{X.value=!1}};return we(()=>oe.value,async B=>{var O;if(B)try{await g(),v.value=[],X.value=!1,j.value=0,P.value=null,K.value="",await u()}catch(z){console.error("Failed to initialize payment dialog:",z),(O=window.toastr)==null||O.error("Failed to initialize payment"),oe.value=!1}}),(B,O)=>($(),ee("div",cr,[e(ze,{modelValue:oe.value,"onUpdate:modelValue":O[2]||(O[2]=z=>oe.value=z),fullscreen:"",transition:"dialog-bottom-transition",scrim:!1,class:"payment-dialog"},{default:t(()=>[e(Pe,{class:"modal-card"},{default:t(()=>[e(Je,{color:"primary",elevation:1},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>[e(le,{icon:"mdi-cash-register",size:"large",class:"mr-2"}),O[6]||(O[6]=S(" Process Payment "))]),_:1}),e(Ne),e(Q,{icon:"",onClick:he},{default:t(()=>[e(le,null,{default:t(()=>O[7]||(O[7]=[S("mdi-close")])),_:1})]),_:1})]),_:1}),l("div",mr,[N.value?($(),ee("div",pr,[e(lt,{indeterminate:"",color:"primary",size:"64"}),O[8]||(O[8]=l("div",{class:"text-h6 mt-4"},"Loading Payment Methods...",-1))])):($(),re(ot,{key:1,class:"payment-container"},{default:t(()=>[e(de,null,{default:t(()=>[e(ae,{cols:"12",md:"4"},{default:t(()=>[e(Pe,{variant:"elevated",class:"invoice-summary-card mb-4",elevation:"2"},{default:t(()=>[e(aa,null,{prepend:t(()=>[e(le,{icon:"mdi-receipt",size:"large",color:"primary",class:"mr-4"})]),default:t(()=>[e(ft,{class:"text-h6 pb-2"},{default:t(()=>O[9]||(O[9]=[S(" Invoice Summary ")])),_:1})]),_:1}),e(bt),e(ke,{class:"py-4"},{default:t(()=>[l("div",fr,[O[10]||(O[10]=l("span",null,"Invoice Number:",-1)),l("strong",null,A(ne.value),1)]),l("div",vr,[O[11]||(O[11]=l("span",null,"Subtotal:",-1)),l("strong",null,A(De(d.value)),1)]),j.value>0?($(),ee("div",yr,[O[12]||(O[12]=l("span",null,"Tip:",-1)),l("strong",null,A(De(j.value)),1)])):ve("",!0),l("div",gr,[O[13]||(O[13]=l("span",null,"Total Amount:",-1)),l("strong",null,A(De(d.value+j.value)),1)]),l("div",_r,[O[14]||(O[14]=l("span",null,"Remaining:",-1)),l("strong",null,A(De(ue.value)),1)])]),_:1})]),_:1}),e(Q,{block:"",color:"primary",variant:"outlined",onClick:O[0]||(O[0]=z=>x.value=!0),class:"mb-4 tip-button",height:"48"},{default:t(()=>[S(A(j.value>0?`Update Tip (${De(j.value)})`:"Add Tip"),1)]),_:1})]),_:1}),e(ae,{cols:"12",md:"8"},{default:t(()=>[O[29]||(O[29]=l("div",{class:"text-subtitle-1 mb-3 font-weight-medium"},"Select Payment Method",-1)),e(de,{class:"payment-methods-grid"},{default:t(()=>[($(!0),ee(xe,null,Ye(F(m),z=>($(),re(ae,{key:z.id,cols:"6",sm:"4"},{default:t(()=>[e(Q,{block:"",color:ge(z.id)?"primary":void 0,variant:ge(z.id)?"flat":"outlined",class:"payment-method-btn",height:"64",onClick:Ie=>Le(z.id),disabled:Re(z.id)},{default:t(()=>[e(le,{icon:Z(z.name),class:"mr-2"},null,8,["icon"]),S(" "+A(z.name),1)]),_:2},1032,["color","variant","onClick","disabled"])]),_:2},1024))),128))]),_:1}),v.value.length>0?($(),ee("div",br,[($(!0),ee(xe,null,Ye(v.value,(z,Ie)=>($(),ee("div",{key:Ie,class:"payment-section"},[e(Pe,{variant:"outlined",class:"pa-4"},{default:t(()=>{var Qe,J,k;return[l("div",hr,[e(le,{icon:Z((Qe=F(y)(z.method_id))==null?void 0:Qe.name),class:"mr-2"},null,8,["icon"]),l("span",wr,A((J=F(y)(z.method_id))==null?void 0:J.name),1),e(Ne),e(Q,{icon:"mdi-close",variant:"text",density:"comfortable",onClick:W=>Ce(Ie)},null,8,["onClick"])]),l("div",Ir,[O[17]||(O[17]=l("div",{class:"amount-display__label"},"Amount",-1)),l("div",{class:je(["amount-display__value-container",{"is-error":!L(z)}])},[l("div",Pr,[O[15]||(O[15]=l("span",{class:"amount-display__currency"},"$",-1)),S(A(F(se).toDollars(z.amount).toFixed(2)),1)])],2),e(Lt,{name:"fade"},{default:t(()=>[L(z)?ve("",!0):($(),ee("div",Cr,[e(le,{icon:"mdi-alert-circle",size:"small",color:"error",class:"mr-1"}),O[16]||(O[16]=S(" Full payment amount is required "))]))]),_:2},1024)]),F(n)(z.method_id)?($(),ee(xe,{key:0},[(k=F(_)(z.method_id))!=null&&k.length?($(),ee("div",Or,[O[18]||(O[18]=l("div",{class:"text-subtitle-2 mb-2"},"Quick Amount Selection",-1)),e(de,null,{default:t(()=>[($(!0),ee(xe,null,Ye(F(_)(z.method_id),W=>($(),re(ae,{key:W.id,cols:"4",class:"pa-1"},{default:t(()=>[e(Q,{block:"",variant:"outlined",class:"denomination-btn",size:"small",onClick:pe=>$e(W,Ie)},{default:t(()=>[S(A(De(F(se).toCents(W.amount))),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:2},1024)])):ve("",!0),l("div",Sr,[O[21]||(O[21]=l("div",{class:"amount-display__label"},"Amount Received",-1)),l("div",{class:je(["amount-display__value-container",{"is-error":!_e(z)}])},[l("div",xr,[O[19]||(O[19]=l("span",{class:"amount-display__currency"},"$",-1)),ra(l("input",{"onUpdate:modelValue":W=>z.displayReceived=W,type:"number",class:"amount-display__input",step:"0.01",min:"0",onInput:W=>Ee(Ie)},null,40,Dr),[[xa,z.displayReceived]])])],2),e(Lt,{name:"fade"},{default:t(()=>[_e(z)?ve("",!0):($(),ee("div",Vr,[e(le,{icon:"mdi-alert-circle",size:"small",color:"error",class:"mr-1"}),O[20]||(O[20]=S(" Received amount must be greater than or equal to payment amount "))]))]),_:2},1024)])],64)):ve("",!0),G(z.method_id)?($(),ee("div",Tr,[l("div",$r,[O[22]||(O[22]=l("span",null,"Service Fee:",-1)),l("strong",null,A(De(z.fees)),1)]),l("div",kr,A(E(z.method_id,z.amount)),1)])):ve("",!0),l("div",Nr,[O[23]||(O[23]=l("span",null,"Payment Amount:",-1)),l("strong",null,"$"+A(F(se).toDollars(z.amount).toFixed(2)),1)]),z.displayReceived?($(),ee("div",Er,[O[24]||(O[24]=l("span",null,"Amount Received:",-1)),l("strong",null,"$"+A(Number(z.displayReceived).toFixed(2)),1)])):ve("",!0),z.returned>0?($(),ee("div",Ar,[O[25]||(O[25]=l("span",null,"Change:",-1)),l("strong",null,"$"+A(F(se).toDollars(z.returned).toFixed(2)),1)])):ve("",!0),z.fees?($(),ee("div",Fr,[O[26]||(O[26]=l("span",null,"Fees:",-1)),l("strong",null,A(De(z.fees)),1)])):ve("",!0),Ie<v.value.length-1?($(),re(bt,{key:5,class:"my-4"})):ve("",!0)]}),_:2},1024)]))),128)),U.value?($(),re(Q,{key:0,block:"",color:"primary",variant:"outlined",onClick:qe,class:"mt-4",height:"48"},{default:t(()=>[e(le,{start:""},{default:t(()=>O[27]||(O[27]=[S("mdi-plus")])),_:1}),O[28]||(O[28]=S(" Add Another Payment Method "))]),_:1})):ve("",!0)])):ve("",!0)]),_:1})]),_:1}),M.value?($(),re(at,{key:0,type:"error",variant:"tonal",closable:"",class:"error-alert","onClick:close":O[1]||(O[1]=z=>M.value=null)},{default:t(()=>[S(A(M.value),1)]),_:1})):ve("",!0),l("div",Ur,[e(Q,{color:"primary",size:"large",block:"",height:"56",onClick:ie,loading:X.value,disabled:!ye.value||X.value,class:"process-payment-btn"},{default:t(()=>[e(le,{start:""},{default:t(()=>O[30]||(O[30]=[S("mdi-cash-register")])),_:1}),O[31]||(O[31]=S(" Process Payment "))]),_:1},8,["loading","disabled"])])]),_:1}))])]),_:1})]),_:1},8,["modelValue"]),e(ze,{modelValue:x.value,"onUpdate:modelValue":O[4]||(O[4]=z=>x.value=z),"max-width":"400px"},{default:t(()=>[e(Pe,null,{default:t(()=>[e(ft,{class:"text-h6"},{default:t(()=>O[32]||(O[32]=[S(" Select Tip Amount ")])),_:1}),e(ke,null,{default:t(()=>[O[34]||(O[34]=l("p",{class:"text-subtitle-2 mb-4"},"Choose a tip percentage or enter a custom amount.",-1)),e(de,{class:"mb-4"},{default:t(()=>[($(),ee(xe,null,Ye(H,z=>e(ae,{key:z,cols:"3"},{default:t(()=>[e(Q,{block:"",variant:P.value===z?"flat":"outlined",color:P.value===z?"primary":void 0,onClick:Ie=>Ze(z)},{default:t(()=>[S(A(z)+"% ",1)]),_:2},1032,["variant","color","onClick"])]),_:2},1024)),64))]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Se,{modelValue:K.value,"onUpdate:modelValue":O[3]||(O[3]=z=>K.value=z),label:"Custom %",type:"number",min:"0",max:"100","append-inner-text":"%",onInput:Y},null,8,["modelValue"])]),_:1})]),_:1}),ce.value>0?($(),re(de,{key:0},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[l("div",zr,[O[33]||(O[33]=l("span",null,"Tip Amount:",-1)),l("strong",null,A(De(ce.value)),1)])]),_:1})]),_:1})):ve("",!0)]),_:1}),e(st,null,{default:t(()=>[e(Ne),e(Q,{color:"grey",variant:"text",onClick:q},{default:t(()=>O[35]||(O[35]=[S(" Cancel ")])),_:1}),e(Q,{color:"primary",onClick:be},{default:t(()=>O[36]||(O[36]=[S(" Confirm Tip ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(jt,{modelValue:p.value,"onUpdate:modelValue":O[5]||(O[5]=z=>p.value=z),"pdf-url":R.value,title:"Invoice",onClosed:me},null,8,["modelValue","pdf-url"])]))}},la=Te(Rr,[["__scopeId","data-v-8daacd89"]]);const Lr={class:"payment-content"},qr={class:"d-flex justify-space-between mb-2"},Mr={class:"d-flex justify-space-between mb-2"},jr={key:0,class:"d-flex justify-space-between mb-2"},Gr={class:"d-flex justify-space-between"},Hr={class:"d-flex align-center mb-4"},Br={class:"text-h6"},Kr={class:"amount-display"},Yr={class:"amount-display__amount"},Qr={key:0,class:"amount-display__error"},Wr={key:0,class:"mb-4"},Jr={class:"amount-display"},Xr={class:"amount-display__amount"},Zr=["onUpdate:modelValue","onInput"],el={key:0,class:"amount-display__error"},tl={class:"d-flex justify-space-between align-center"},al={class:"text-h5 font-weight-bold"},ol={key:1,class:"text-caption mb-2"},sl={class:"d-flex justify-space-between"},rl={class:"text-grey"},ll={class:"d-flex justify-space-between mb-2"},nl={class:"d-flex justify-space-between mb-2"},il={class:"d-flex justify-space-between"},dl={class:"d-flex justify-space-between"},ul={__name:"PaymentInvoiceDialog",props:{modelValue:Boolean,createInvoiceOnly:{type:Boolean,default:!1},invoice:{type:Object,required:!1,default:()=>({invoice:{},invoicePrefix:"",nextInvoiceNumber:""})}},emits:["update:modelValue","payment-complete"],setup(a,{emit:o}){const r=He();rt();const i=a,d=o,{loading:b,error:f,paymentMethods:m,settings:I,createPayment:c,fetchPaymentMethods:u,fetchSettings:g,getDenominations:_,calculateFees:V,getPaymentMethod:y,isCashOnly:n}=qt(),{loading:C,error:T,releaseTablesAfterPayment:h}=Mt(),N=te(()=>b.value||C.value),M=te(()=>f.value||T.value),X=D(!1),v=D([]),p=te(()=>{var J,k;return["DRAFT","SENT"].includes((k=(J=i.invoice)==null?void 0:J.invoice)==null?void 0:k.status)}),R=async()=>{var J,k;try{await r.loadInvoice(i.invoice.invoice),(J=window.toastr)==null||J.success("Invoice loaded to cart successfully"),U.value=!1}catch(W){console.error("Failed to load invoice to cart:",W),(k=window.toastr)==null||k.error("Failed to load invoice to cart")}},me=D(!1),x=[15,18,20,25],H=D(null),P=D(""),K=D(0),j=D("percentage"),w=D(!1),ne=D(""),ce=te(()=>{var J,k,W,pe;return((k=(J=i.invoice)==null?void 0:J.invoice)==null?void 0:k.invoice_number)||`${(W=i.invoice)==null?void 0:W.invoicePrefix}-${(pe=i.invoice)==null?void 0:pe.nextInvoiceNumber}`||""}),oe=te(()=>{var J,k;return se.normalizePrice(((k=(J=i.invoice)==null?void 0:J.invoice)==null?void 0:k.total)||0)}),ue=te(()=>{const J=H.value||Number(P.value)||0;return Math.round(oe.value*J/100)}),U=te({get:()=>i.modelValue,set:J=>d("update:modelValue",J)}),L=te(()=>{const J=v.value.reduce((k,W)=>k+se.normalizePrice(W.amount),0);return se.normalizePrice(oe.value+K.value-J)}),_e=te(()=>v.value.reduce((J,k)=>J+k.amount,0)),ye=te(()=>v.value.reduce((J,k)=>J+(k.fees||0),0)),De=te(()=>L.value>0&&v.value.length<m.value.length),G=J=>!J.displayAmount||Number(J.displayAmount)<=0?!1:Number(J.displayAmount)===se.toDollars(oe.value+K.value),E=J=>J.displayReceived?Number(J.displayReceived)>=Number(J.displayAmount):!1,Z=te(()=>v.value.every(J=>!(!J.method_id||!J.amount||n(J.method_id)&&!J.received||!G(J)||n(J.method_id)&&!E(J)))&&L.value===0),ge=J=>se.formatInvoiceAmount(J),Re=()=>{w.value=!1,ne.value=""},Le=J=>{const k=y(J);return(k==null?void 0:k.IsPaymentFeeActive)==="YES"},$e=(J,k)=>{const W=y(J);if(!(W!=null&&W.registrationdatafees))return"";const pe=W.registrationdatafees;switch(pe.type){case"FIXED":return`Fixed fee: ${ge(pe.value)}`;case"PERCENTAGE":return`${pe.value}% of transaction amount`;case"FIXED_PLUS_PERCENTAGE":return`${ge(pe.value.fixed)} + ${pe.value.percentage}% of transaction amount`;default:return""}},Ee=J=>({Cash:"mdi-cash","Credit Card":"mdi-credit-card","Debit Card":"mdi-credit-card-outline",Check:"mdi-checkbox-marked-circle-outline","Gift Card":"mdi-gift","Mobile Payment":"mdi-cellphone","Bank Transfer":"mdi-bank"})[J]||"mdi-currency-usd",Ve=J=>v.value.some(k=>k.method_id===J),qe=J=>Ve(J)||v.value.length>=m.value.length,Ce=J=>{if(Ve(J)||qe(J))return;const k=L.value,W=(k/100).toString();v.value.push({method_id:J,amount:k,displayAmount:W,received:k,displayReceived:W,returned:0,fees:0}),Y(v.value.length-1)},he=(J,k)=>{const W=v.value[k];W.displayReceived=J.amount.toString(),W.received=Math.round(Number(J.amount)*100),Ze(k)},Ze=J=>{const k=v.value[J];if(!k.displayReceived||!k.displayAmount)return;const W=Math.round(Number(k.displayReceived)*100),pe=k.amount;k.received=W,W>=pe?k.returned=W-pe:k.returned=0},Y=J=>{const k=v.value[J];k.displayAmount&&(k.displayAmount=((oe.value+K.value)/100).toString(),k.amount=Math.round(Number(k.displayAmount)*100),Le(k.method_id)&&(k.fees=V(k.method_id,k.amount)),n(k.method_id)&&(k.displayReceived=k.displayAmount,k.received=k.amount,k.returned=0))},q=()=>{v.value.push({method_id:null,amount:0,displayAmount:((oe.value+K.value)/100).toString(),received:0,displayReceived:"0",returned:0,fees:0})},be=J=>{v.value.splice(J,1),v.value.forEach((k,W)=>Y(W))},ie=()=>{X.value||(U.value=!1)},B=J=>{H.value=J,P.value=""},O=()=>{H.value=null},z=()=>{me.value=!1,H.value=null,P.value=""},Ie=()=>{K.value=ue.value,j.value="percentage",me.value=!1,v.value.forEach((J,k)=>Y(k))},Qe=async()=>{var J,k,W,pe,nt,It,_t,We,Fe,Ot,Gt,it;if(console.log("PaymentDialog: Starting payment processing",{isValid:Z.value,processing:X.value,invoiceTotal:oe.value,tipAmount:K.value,payments:v.value,invoice:i.invoice}),!Z.value||X.value){console.log("PaymentDialog: Cannot process - validation failed or already processing");return}X.value=!0;try{console.log("PaymentDialog: Starting invoice creation with props:",{invoice:i.invoice,hasInvoiceData:!!((J=i.invoice)!=null&&J.invoice),invoiceTotal:oe.value,tipAmount:K.value});let fe;const Be=((k=i.invoice)==null?void 0:k.invoice)||i.invoice;if(!Be)throw new Error("Invoice data not provided");console.log("PaymentDialog: Processing invoice data:",{invoiceData:Be,isHoldInvoice:Be.is_hold_invoice,total:Be.total,dueAmount:Be.due_amount});const dt=oe.value+K.value,Ht=H.value||Number(P.value)||0;if(Be.is_hold_invoice){console.log("PaymentDialog: Processing hold invoice conversion");const Oe={...Be,tip:String(Math.round(Ht)),tip_type:"percentage",tip_val:K.value,total:dt,due_amount:dt,sub_total:oe.value},Ke=await Ta(Oe);if(!Ke.success)throw console.error("Hold invoice conversion failed:",Ke.error),new Error(Ke.error||"Failed to create invoice from hold order");console.log("Hold invoice converted successfully:",{holdInvoiceId:Oe.id,newInvoiceId:Ke.invoice.id,invoiceNumber:Ke.invoice.invoice_number}),fe={invoice:{...Ke.invoice,id:Ke.invoice.id,invoice_number:Ke.invoice.invoice_number,hold_invoice_id:Oe.id,tip:String(Math.round(Ht)),tip_type:"percentage",tip_val:K.value,total:dt,due_amount:dt,sub_total:oe.value}}}else fe={invoice:{...Be,tip:String(Math.round(Ht)),tip_type:"percentage",tip_val:K.value,total:dt,due_amount:dt,sub_total:oe.value}};if(i.createInvoiceOnly)try{const Oe={...fe,is_hold_invoice:!0,status:"HELD",description:fe.description||"Delivery Order"};if(!(await tt.holdInvoice.create(Oe)).success)throw new Error("Failed to add invoice to held orders");(W=window.toastr)==null||W.success("Invoice created and added to held orders"),d("payment-complete",!0),U.value=!1;return}catch(Oe){throw console.error("Failed to add to held orders:",Oe),new Error("Failed to add invoice to held orders")}const Pi=rt(),Bt=v.value.map(Oe=>({method_id:Oe.method_id,name:y(Oe.method_id).name,amount:Oe.amount,received:Oe.received,returned:Oe.returned,valid:!0})),At=Bt.reduce((Oe,Ke)=>Oe+Ke.amount,0);if(console.log("Payment validation:",{totalPaymentAmount:At,totalWithTip:dt,difference:Math.abs(At-dt)}),Math.abs(At-dt)>1)throw new Error(`Payment amount (${At}) must match invoice total including tip (${dt})`);console.log("Final invoice for payment:",fe);const Dt=((pe=fe.invoice)==null?void 0:pe.id)||fe.id,Kt=((nt=fe.invoice)==null?void 0:nt.invoice_number)||fe.invoice_number||Dt;if(!Dt)throw new Error("Invalid invoice: missing ID");console.log("PaymentDialog: Final invoice details:",{invoiceId:Dt,invoiceNumber:Kt,total:fe.total||((It=fe.invoice)==null?void 0:It.total),dueAmount:fe.due_amount||((_t=fe.invoice)==null?void 0:_t.due_amount)}),console.log("Processing payment with:",{invoiceId:Dt,invoiceNumber:Kt,finalInvoice:fe,payments:Bt});const ia=await c({...fe,id:Dt,invoice_number:Kt},Bt);if(fe.type==="DINE_IN"&&((We=fe.tables_selected)!=null&&We.length))try{await h(invoiceResult.invoice.tables_selected)}catch(Oe){console.error("Failed to release tables:",Oe),(Fe=window.toastr)==null||Fe.warning("Payment successful, but failed to update table status")}try{const Oe=((Ot=fe==null?void 0:fe.invoice)==null?void 0:Ot.invoice)||(fe==null?void 0:fe.invoice);if(!(Oe!=null&&Oe.unique_hash))throw console.error(" [Invoice PDF] Missing invoice hash:",Oe),new Error("Could not generate invoice PDF: Missing invoice hash");const Ke=Oe.invoicePdfUrl||`${"https://lajuanita.corebill.co/api/v1".replace("/api/v1","")}/invoices/pdf/${Oe.unique_hash}`;console.log(" [Invoice PDF] Opening PDF viewer with URL:",Ke),ne.value=Ke,w.value=!0,d("payment-complete",{...ia,invoicePdfUrl:Ke}),U.value=!1}catch(Oe){console.error(" [Invoice PDF] Failed to display invoice:",Oe),(Gt=window.toastr)==null||Gt.error(Oe.message||"Failed to display invoice PDF"),d("payment-complete",ia),U.value=!1}}catch(fe){console.error("Payment processing error:",fe),(it=window.toastr)==null||it.error(fe.message||"Failed to process payment")}finally{X.value=!1}};return we(()=>U.value,async J=>{var k;if(J)try{await g(),v.value=[],X.value=!1,K.value=0,H.value=null,P.value="",await u()}catch(W){console.error("Failed to initialize payment dialog:",W),(k=window.toastr)==null||k.error("Failed to initialize payment"),U.value=!1}}),(J,k)=>($(),ee(xe,null,[e(ze,{modelValue:U.value,"onUpdate:modelValue":k[2]||(k[2]=W=>U.value=W),fullscreen:"",transition:"dialog-bottom-transition",scrim:!1,class:"payment-dialog"},{default:t(()=>[e(Pe,{class:"modal-card"},{default:t(()=>[e(Je,{color:"primary",elevation:1},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>[e(le,{icon:"mdi-cash-register",size:"large",class:"mr-2"}),k[5]||(k[5]=S(" Process Payment "))]),_:1}),e(Ne),e(Q,{color:"primary",variant:"text",class:"mr-2",onClick:R,disabled:!p.value},{default:t(()=>[e(le,{start:""},{default:t(()=>k[6]||(k[6]=[S("mdi-cart-arrow-down")])),_:1}),k[7]||(k[7]=S(" Load to Cart "))]),_:1},8,["disabled"]),e(Q,{icon:"mdi-close",variant:"text",onClick:ie,class:"ml-2",size:"large"})]),_:1}),l("div",Lr,[e(ot,{class:"payment-container"},{default:t(()=>[N.value?($(),re(de,{key:0},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Ga,{class:"pa-3"},{default:t(()=>[e(Ha,{type:"article, actions",class:"mx-auto"})]),_:1})]),_:1})]),_:1})):($(),ee(xe,{key:1},[e(de,null,{default:t(()=>[e(ae,{cols:"12",md:"4"},{default:t(()=>[e(Pe,{variant:"elevated",class:"invoice-summary-card mb-4",elevation:"2"},{default:t(()=>[e(aa,null,{prepend:t(()=>[e(le,{icon:"mdi-receipt",size:"large",color:"primary",class:"mr-4"})]),default:t(()=>[e(ft,{class:"text-h6 pb-2"},{default:t(()=>k[8]||(k[8]=[S(" Invoice Summary ")])),_:1})]),_:1}),e(bt),e(ke,{class:"py-4"},{default:t(()=>[l("div",qr,[k[9]||(k[9]=l("span",null,"Invoice Number:",-1)),l("strong",null,A(ce.value),1)]),l("div",Mr,[k[10]||(k[10]=l("span",null,"Subtotal:",-1)),l("strong",null,A(ge(oe.value)),1)]),K.value>0?($(),ee("div",jr,[k[11]||(k[11]=l("span",null,"Tip:",-1)),l("strong",null,A(ge(K.value)),1)])):ve("",!0),l("div",Gr,[k[12]||(k[12]=l("span",null,"Total Amount:",-1)),l("strong",null,A(ge(oe.value+K.value)),1)])]),_:1})]),_:1}),e(Q,{block:"",color:"primary",variant:"outlined",onClick:k[0]||(k[0]=W=>me.value=!0),class:"mb-4"},{default:t(()=>[S(A(K.value>0?`Update Tip (${ge(K.value/100)})`:"Add Tip"),1)]),_:1})]),_:1}),e(ae,{cols:"12",md:"8"},{default:t(()=>[k[13]||(k[13]=l("div",{class:"text-subtitle-1 mb-3 font-weight-medium"},"Select Payment Method",-1)),e(de,{class:"payment-methods-grid"},{default:t(()=>[($(!0),ee(xe,null,Ye(F(m),W=>($(),re(ae,{key:W.id,cols:"6",sm:"4"},{default:t(()=>[e(Q,{block:"",color:Ve(W.id)?"primary":void 0,variant:Ve(W.id)?"flat":"outlined",class:"payment-method-btn",height:"64",disabled:qe(W.id),onClick:pe=>Ce(W.id)},{default:t(()=>[e(le,{icon:Ee(W.name),class:"mr-2"},null,8,["icon"]),S(" "+A(W.name),1)]),_:2},1032,["color","variant","disabled","onClick"])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}),v.value.length>0?($(),re(de,{key:0},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[($(!0),ee(xe,null,Ye(v.value,(W,pe)=>($(),ee("div",{key:pe,class:"payment-section mb-4"},[e(Pe,{variant:"outlined",class:"pa-4"},{default:t(()=>{var nt,It,_t;return[l("div",Hr,[e(le,{icon:Ee((nt=F(y)(W.method_id))==null?void 0:nt.name),class:"mr-2"},null,8,["icon"]),l("span",Br,A((It=F(y)(W.method_id))==null?void 0:It.name),1),e(Ne),e(Q,{icon:"mdi-close",variant:"text",density:"comfortable",onClick:We=>be(pe)},null,8,["onClick"])]),l("div",Kr,[k[16]||(k[16]=l("div",{class:"amount-display__label"},"Amount",-1)),l("div",{class:je(["amount-display__value-container",{"is-error":!G(W)}])},[l("div",Yr,[k[14]||(k[14]=l("span",{class:"amount-display__currency"},"$",-1)),S(A(F(se).toDollars(W.amount).toFixed(2)),1)])],2),e(Lt,{name:"fade"},{default:t(()=>[G(W)?ve("",!0):($(),ee("div",Qr,[e(le,{icon:"mdi-alert-circle",size:"small",color:"error",class:"mr-1"}),k[15]||(k[15]=S(" Full payment amount is required "))]))]),_:2},1024)]),F(n)(W.method_id)?($(),ee(xe,{key:0},[(_t=F(_)(W.method_id))!=null&&_t.length?($(),ee("div",Wr,[k[17]||(k[17]=l("div",{class:"text-subtitle-2 mb-2"},"Quick Amount Selection",-1)),e(de,null,{default:t(()=>[($(!0),ee(xe,null,Ye(F(_)(W.method_id),We=>($(),re(ae,{key:We.id,cols:"4",class:"pa-1"},{default:t(()=>[e(Q,{block:"",variant:"outlined",size:"small",onClick:Fe=>he(We,pe)},{default:t(()=>[S(A(ge(F(se).toCents(We.amount))),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:2},1024)])):ve("",!0),l("div",Jr,[k[20]||(k[20]=l("div",{class:"amount-display__label"},"Amount Received",-1)),l("div",{class:je(["amount-display__value-container",{"is-error":!E(W)}])},[l("div",Xr,[k[18]||(k[18]=l("span",{class:"amount-display__currency"},"$",-1)),ra(l("input",{"onUpdate:modelValue":We=>W.displayReceived=We,type:"number",class:"amount-display__input",step:"0.01",min:"0",onInput:We=>Ze(pe)},null,40,Zr),[[xa,W.displayReceived]])])],2),e(Lt,{name:"fade"},{default:t(()=>[E(W)?ve("",!0):($(),ee("div",el,[e(le,{icon:"mdi-alert-circle",size:"small",color:"error",class:"mr-1"}),k[19]||(k[19]=S(" Received amount must be greater than or equal to payment amount "))]))]),_:2},1024)]),W.returned>0?($(),re(Pe,{key:1,color:"primary",class:"change-amount-card mb-2"},{default:t(()=>[e(ke,{class:"pa-3"},{default:t(()=>[l("div",tl,[k[21]||(k[21]=l("span",{class:"text-h6 font-weight-medium"},"Change Due:",-1)),l("span",al,A(ge(W.returned/100)),1)])]),_:2},1024)]),_:2},1024)):ve("",!0)],64)):ve("",!0),Le(W.method_id)?($(),ee("div",ol,[l("div",sl,[k[22]||(k[22]=l("span",null,"Service Fee:",-1)),l("strong",null,A(ge(W.fees/100)),1)]),l("div",rl,A($e(W.method_id,W.amount)),1)])):ve("",!0),pe<v.value.length-1?($(),re(bt,{key:2,class:"my-4"})):ve("",!0)]}),_:2},1024)]))),128)),De.value?($(),re(Q,{key:0,color:"primary",variant:"outlined",size:"small",class:"mt-2",onClick:q},{default:t(()=>k[23]||(k[23]=[S(" Add Payment Method ")])),_:1})):ve("",!0),ye.value>0?($(),re(Pe,{key:1,variant:"outlined",class:"mt-4"},{default:t(()=>[e(ke,null,{default:t(()=>[l("div",ll,[k[24]||(k[24]=l("span",null,"Subtotal:",-1)),l("strong",null,A(ge(_e.value/100)),1)]),l("div",nl,[k[25]||(k[25]=l("span",null,"Service Fees:",-1)),l("strong",null,A(ge(ye.value/100)),1)]),l("div",il,[k[26]||(k[26]=l("span",null,"Total:",-1)),l("strong",null,A(ge((_e.value+ye.value)/100)),1)])]),_:1})]),_:1})):ve("",!0)]),_:1})]),_:1})):ve("",!0),M.value?($(),re(de,{key:1},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(at,{type:"error",variant:"tonal"},{default:t(()=>[S(A(M.value),1)]),_:1})]),_:1})]),_:1})):ve("",!0)],64))]),_:1}),e(jt,{modelValue:w.value,"onUpdate:modelValue":k[1]||(k[1]=W=>w.value=W),pdfUrl:ne.value,onClosed:Re},null,8,["modelValue","pdfUrl"])]),e(st,{class:"pa-4"},{default:t(()=>[e(Q,{block:"",color:"primary",variant:"flat",size:"large",height:"56",loading:X.value,disabled:!Z.value||X.value,onClick:Qe,class:"process-payment-btn"},{default:t(()=>k[27]||(k[27]=[S(" Process Payment ")])),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(ze,{modelValue:me.value,"onUpdate:modelValue":k[4]||(k[4]=W=>me.value=W),"max-width":"400px"},{default:t(()=>[e(Pe,null,{default:t(()=>[e(ft,{class:"text-h6"},{default:t(()=>k[28]||(k[28]=[S(" Select Tip Amount ")])),_:1}),e(ke,null,{default:t(()=>[k[30]||(k[30]=l("p",{class:"text-subtitle-2 mb-4"},"Choose a tip percentage or enter a custom amount.",-1)),e(de,{class:"mb-4"},{default:t(()=>[($(),ee(xe,null,Ye(x,W=>e(ae,{key:W,cols:"3"},{default:t(()=>[e(Q,{block:"",variant:H.value===W?"flat":"outlined",color:H.value===W?"primary":void 0,onClick:pe=>B(W)},{default:t(()=>[S(A(W)+"% ",1)]),_:2},1032,["variant","color","onClick"])]),_:2},1024)),64))]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Se,{modelValue:P.value,"onUpdate:modelValue":k[3]||(k[3]=W=>P.value=W),label:"Custom %",type:"number",min:"0",max:"100","append-inner-text":"%",onInput:O},null,8,["modelValue"])]),_:1})]),_:1}),ue.value>0?($(),re(de,{key:0},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[l("div",dl,[k[29]||(k[29]=l("span",null,"Tip Amount:",-1)),l("strong",null,A(ge(ue.value/100)),1)])]),_:1})]),_:1})):ve("",!0)]),_:1}),e(st,null,{default:t(()=>[e(Ne),e(Q,{color:"grey",variant:"text",onClick:z},{default:t(()=>k[31]||(k[31]=[S(" Cancel ")])),_:1}),e(Q,{color:"primary",onClick:Ie},{default:t(()=>k[32]||(k[32]=[S(" Confirm Tip ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}},cl=Te(ul,[["__scopeId","data-v-681bd7dc"]]);const ml={class:"table-container"},pl={class:"text-truncate"},fl={class:"text-right"},vl={class:"actions-wrapper"},yl={key:0,class:"pagination-container"},gl={class:"mb-2"},_l={class:"mb-2"},bl={class:"mb-2"},hl={class:"mb-2"},wl={class:"mb-2"},Il={class:"mb-2"},Pl={class:"mb-2"},Cl={class:"text-right"},Ol={class:"text-right"},Sl={class:"text-right"},xl={class:"d-flex justify-space-between mb-2"},Dl={class:"d-flex justify-space-between mb-2"},Vl={class:"d-flex justify-space-between"},Tl={__name:"OrderInvoicesTable",props:{invoices:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1},page:{type:Number,default:1},totalPages:{type:Number,default:1},getOrderType:{type:Function,required:!1},getOrderTypeColor:{type:Function,required:!1},formatDate:{type:Function,required:!1},showPagination:{type:Boolean,default:!1},selectedFilter:{type:String,default:"all"}},emits:["invoice-paid","page-change"],setup(a,{emit:o}){const r=a,i=He();console.log("OrderInvoicesTable - Initial props:",{invoicesCount:r.invoices.length,loading:r.loading,page:r.page,totalPages:r.totalPages}),we(()=>r.invoices,(v,p)=>{console.log("OrderInvoicesTable - Invoices changed:",{oldCount:(p==null?void 0:p.length)||0,newCount:v.length,invoices:v.map(R=>({id:R.id,invoice_number:R.invoice_number,status:R.status,paid_status:R.paid_status,total:R.total,formatted_total:se.format(R.total)}))})},{deep:!0});const d=o,b=D(!1),f=D(!1),m=D(null),I=D(!1),c=D(null),u=D(!1),g=D("");te(()=>r.totalPages>1);const _=v=>new Date(v).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),V=v=>{if(!v)return 0;const p=typeof v=="string"?parseFloat(v):v;return p>1e3?se.toDollars(p):p},y=()=>{u.value=!1,g.value=""},n=async v=>{var R,me,x,H;const p={...v,total:V(v.total),hold_items:(R=v.items)==null?void 0:R.map(P=>({item_id:P.item_id||P.id,name:P.name,description:P.description,price:V(P.price),total:V(P.total),quantity:P.quantity,unit_name:P.unit_name})),type:v.type||"DINE_IN"};console.log("OrderInvoicesTable - Loading invoice to cart:",{id:p.id,invoice_number:p.invoice_number,total:p.total,formatted_total:se.format(p.total),items:(me=p.hold_items)==null?void 0:me.map(P=>({id:P.item_id,name:P.name,price:P.price,formatted_price:se.format(P.price),quantity:P.quantity}))});try{await i.loadInvoice(p),(x=window.toastr)==null||x.success("Invoice loaded to cart successfully"),console.log("OrderInvoicesTable - Invoice loaded to cart successfully:",{invoice_id:p.id,invoice_number:p.invoice_number}),d("page-change",1)}catch(P){console.error("OrderInvoicesTable - Failed to load invoice to cart:",P),(H=window.toastr)==null||H.error("Failed to load invoice to cart")}},C=v=>{const p={DRAFT:"grey",SENT:"info",VIEWED:"warning",EXPIRED:"error",DECLINED:"error",ACCEPTED:"success",COMPLETED:"success"}[v==null?void 0:v.toUpperCase()]||"grey";return console.log("OrderInvoicesTable - Status color:",{status:v,color:p}),p},T=v=>{const p={PAID:"success",PARTIALLY_PAID:"warning",UNPAID:"error"}[v==null?void 0:v.toUpperCase()]||"error";return console.log("OrderInvoicesTable - Paid status color:",{status:v,color:p}),p},h=async v=>{console.log("OrderInvoicesTable - Showing invoice details:",{id:v.id,invoice_number:v.invoice_number,status:v.status,paid_status:v.paid_status,total:v.total,formatted_total:se.format(v.total)}),c.value=v,I.value=!0},N=v=>{console.log("OrderInvoicesTable - Pay clicked:",{id:v.id,invoice_number:v.invoice_number,total:v.total,formatted_total:se.format(v.total)}),m.value=v,f.value=!0},M=()=>{var v,p;console.log("OrderInvoicesTable - Payment confirmed:",{invoice_id:(v=m.value)==null?void 0:v.id,invoice_number:(p=m.value)==null?void 0:p.invoice_number}),f.value=!1,b.value=!0},X=async v=>{var p,R,me;try{console.log("OrderInvoicesTable - Payment completed:",{result:v,invoice_id:(p=m.value)==null?void 0:p.id,invoice_number:(R=m.value)==null?void 0:R.invoice_number}),v!=null&&v.invoicePdfUrl?(console.log(" [Invoice PDF] Opening PDF viewer with URL:",v.invoicePdfUrl),g.value=v.invoicePdfUrl,u.value=!0):console.warn(" [Invoice PDF] No payment PDF URL provided in result:",v),b.value=!1,m.value=null,d("invoice-paid",v)}catch(x){console.error(" [Invoice PDF] Failed to display invoice:",x),(me=window.toastr)==null||me.error(x.message||"Failed to display invoice PDF"),b.value=!1,m.value=null,d("invoice-paid",v)}};return(v,p)=>{var R,me;return $(),ee(xe,null,[l("div",{class:je(["order-invoices-table",v.$attrs.class])},[l("div",ml,[e(ea,{"fixed-header":"",class:"invoices-table"},{default:t(()=>[p[13]||(p[13]=l("thead",null,[l("tr",null,[l("th",{class:"text-left date-col"},"Date"),l("th",{class:"text-left invoice-col"},"Invoice #"),l("th",{class:"text-left customer-col"},"Customer"),l("th",{class:"text-left status-col"},"Status"),l("th",{class:"text-left payment-col"},"Payment"),l("th",{class:"text-right total-col"},"Total"),l("th",{class:"text-center actions-col"},"Actions")])],-1)),l("tbody",null,[($(!0),ee(xe,null,Ye(a.invoices,x=>{var H;return $(),ee("tr",{key:x.id},[l("td",null,A(x!=null&&x.created_at?_(x.created_at):"N/A"),1),l("td",null,A((x==null?void 0:x.invoice_number)||"N/A"),1),l("td",pl,A(((H=x==null?void 0:x.contact)==null?void 0:H.name)||(x==null?void 0:x.first_name)||(x==null?void 0:x.name)||"Walk-in Customer"),1),l("td",null,[e(vt,{color:C(x.status),size:"small",variant:"flat",class:"status-chip"},{default:t(()=>[S(A(x.status),1)]),_:2},1032,["color"])]),l("td",null,[e(vt,{color:T(x.paid_status),size:"small",variant:"flat",class:"status-chip"},{default:t(()=>[S(A(x.paid_status||"UNPAID"),1)]),_:2},1032,["color"])]),l("td",fl,A(F(se).format(x.total)),1),l("td",null,[l("div",vl,[x.paid_status==="UNPAID"?($(),re(Q,{key:0,color:"success",size:"small",variant:"flat",onClick:P=>N(x)},{default:t(()=>[e(le,{size:"small",class:"mr-1"},{default:t(()=>p[7]||(p[7]=[S("mdi-cash-register")])),_:1}),p[8]||(p[8]=S(" PAY "))]),_:2},1032,["onClick"])):ve("",!0),e(Q,{color:"info",size:"small",variant:"flat",onClick:P=>h(x)},{default:t(()=>[e(le,{size:"small",class:"mr-1"},{default:t(()=>p[9]||(p[9]=[S("mdi-information")])),_:1}),p[10]||(p[10]=S(" DETAILS "))]),_:2},1032,["onClick"]),["DRAFT","SENT"].includes(x.status)?($(),re(Q,{key:1,color:"primary",size:"small",variant:"flat",onClick:P=>n(x)},{default:t(()=>[e(le,{size:"small",class:"mr-1"},{default:t(()=>p[11]||(p[11]=[S("mdi-cart-arrow-down")])),_:1}),p[12]||(p[12]=S(" LOAD TO CART "))]),_:2},1032,["onClick"])):ve("",!0)])])])}),128))])]),_:1})]),a.showPagination?($(),ee("div",yl,[e(ta,{"model-value":a.page,"onUpdate:modelValue":p[0]||(p[0]=x=>v.$emit("page-change",x)),length:a.totalPages,"total-visible":5},null,8,["model-value","length"])])):ve("",!0)],2),e(ze,{modelValue:f.value,"onUpdate:modelValue":p[2]||(p[2]=x=>f.value=x),"max-width":"400"},{default:t(()=>[e(Pe,null,{default:t(()=>[e(ft,{class:"text-h6"},{default:t(()=>p[14]||(p[14]=[S(" Confirm Payment ")])),_:1}),e(ke,null,{default:t(()=>{var x;return[S(" Are you sure you want to process payment for invoice #"+A((x=m.value)==null?void 0:x.invoice_number)+"? ",1)]}),_:1}),e(st,null,{default:t(()=>[e(Ne),e(Q,{color:"grey-darken-1",variant:"text",onClick:p[1]||(p[1]=x=>f.value=!1)},{default:t(()=>p[15]||(p[15]=[S(" Cancel ")])),_:1}),e(Q,{color:"success",onClick:M},{default:t(()=>p[16]||(p[16]=[S(" Proceed to Payment ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(cl,{modelValue:b.value,"onUpdate:modelValue":p[3]||(p[3]=x=>b.value=x),invoice:{invoice:m.value,invoicePrefix:((R=m.value)==null?void 0:R.invoice_prefix)||"INV",nextInvoiceNumber:(me=m.value)==null?void 0:me.id},onPaymentComplete:X},null,8,["modelValue","invoice"]),e(jt,{modelValue:u.value,"onUpdate:modelValue":p[4]||(p[4]=x=>u.value=x),pdfUrl:g.value,onClosed:y},null,8,["modelValue","pdfUrl"]),e(ze,{modelValue:I.value,"onUpdate:modelValue":p[6]||(p[6]=x=>I.value=x),"max-width":"700"},{default:t(()=>[e(Pe,null,{default:t(()=>[e(Je,{color:"primary",density:"comfortable"},{default:t(()=>[e(Xe,{class:"text-h6"},{default:t(()=>p[17]||(p[17]=[S(" Invoice Details ")])),_:1}),e(Ne),e(Q,{icon:"mdi-close",variant:"text",onClick:p[5]||(p[5]=x=>I.value=!1)})]),_:1}),e(ke,{class:"pa-4"},{default:t(()=>[c.value?($(),ee(xe,{key:0},[e(de,null,{default:t(()=>[e(ae,{cols:"12",sm:"6"},{default:t(()=>[p[22]||(p[22]=l("div",{class:"text-subtitle-1 font-weight-bold mb-2"},"Basic Information",-1)),l("div",gl,[p[18]||(p[18]=l("strong",null,"Invoice Number:",-1)),S(" "+A(c.value.invoice_number),1)]),l("div",_l,[p[19]||(p[19]=l("strong",null,"Date:",-1)),S(" "+A(_(c.value.created_at)),1)]),l("div",bl,[p[20]||(p[20]=l("strong",null,"Status:",-1)),e(vt,{color:C(c.value.status),size:"small",class:"text-uppercase ml-2"},{default:t(()=>[S(A(c.value.status),1)]),_:1},8,["color"])]),l("div",hl,[p[21]||(p[21]=l("strong",null,"Payment Status:",-1)),e(vt,{color:T(c.value.paid_status),size:"small",class:"text-uppercase ml-2"},{default:t(()=>[S(A(c.value.paid_status||"UNPAID"),1)]),_:1},8,["color"])])]),_:1}),e(ae,{cols:"12",sm:"6"},{default:t(()=>{var x,H,P,K;return[p[26]||(p[26]=l("div",{class:"text-subtitle-1 font-weight-bold mb-2"},"Customer Information",-1)),l("div",wl,[p[23]||(p[23]=l("strong",null,"Name:",-1)),S(" "+A(((x=c.value.contact)==null?void 0:x.name)||c.value.first_name||c.value.name||"N/A"),1)]),l("div",Il,[p[24]||(p[24]=l("strong",null,"Phone:",-1)),S(" "+A(((H=c.value.contact)==null?void 0:H.phone)||((P=c.value.customer)==null?void 0:P.phone)||c.value.phone||"N/A"),1)]),l("div",Pl,[p[25]||(p[25]=l("strong",null,"Email:",-1)),S(" "+A(((K=c.value.contact)==null?void 0:K.email)||c.value.email||"N/A"),1)])]}),_:1})]),_:1}),e(de,{class:"mt-4"},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[p[28]||(p[28]=l("div",{class:"text-subtitle-1 font-weight-bold mb-2"},"Order Items",-1)),e(ea,{density:"comfortable"},{default:t(()=>[p[27]||(p[27]=l("thead",null,[l("tr",null,[l("th",null,"Item"),l("th",{class:"text-right"},"Quantity"),l("th",{class:"text-right"},"Price"),l("th",{class:"text-right"},"Total")])],-1)),l("tbody",null,[($(!0),ee(xe,null,Ye(c.value.items,x=>($(),ee("tr",{key:x.id},[l("td",null,A(x.name),1),l("td",Cl,A(x.quantity),1),l("td",Ol,A(F(se).format(V(x.price))),1),l("td",Sl,A(F(se).format(V(x.total))),1)]))),128))])]),_:1})]),_:1})]),_:1}),e(de,{class:"mt-4"},{default:t(()=>[e(ae,{cols:"12",sm:"6","offset-sm":"6"},{default:t(()=>[l("div",xl,[p[29]||(p[29]=l("strong",null,"Subtotal:",-1)),l("span",null,A(F(se).format(V(c.value.sub_total))),1)]),l("div",Dl,[p[30]||(p[30]=l("strong",null,"Tax:",-1)),l("span",null,A(F(se).format(V(c.value.tax))),1)]),e(bt,{class:"my-2"}),l("div",Vl,[p[31]||(p[31]=l("strong",null,"Total:",-1)),l("span",null,A(F(se).format(V(c.value.total))),1)])]),_:1})]),_:1}),c.value.notes?($(),re(de,{key:0,class:"mt-4"},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[p[32]||(p[32]=l("div",{class:"text-subtitle-1 font-weight-bold mb-2"},"Notes",-1)),e(Pe,{variant:"outlined",class:"pa-3"},{default:t(()=>[S(A(c.value.notes),1)]),_:1})]),_:1})]),_:1})):ve("",!0)],64)):ve("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}},pa=Te(Tl,[["__scopeId","data-v-b5ebf6d6"]]);const $l={class:"held-orders-container"},kl={class:"filters-container"},Nl={class:"filters-container"},El={__name:"HeldOrdersModal",props:{modelValue:{type:Boolean,required:!0},disabled:{type:Boolean,default:!1}},emits:["update:model-value"],setup(a,{emit:o}){const r=a,i=o,d=D(!1),b=D(!1),f=D(null),m=D("active"),I=D(""),c=D("ALL"),u=D(""),g=D("COMPLETED"),_=D("PAID"),V=D(1),y=D(10),n=D(""),C=D("SENT"),T=D("UNPAID"),h=D(1),N=D(!1),M=Y=>{i("update:model-value",Y)},{loading:X,loadingOrder:v,deletingOrder:p,convertingOrder:R,holdInvoices:me,getOrderType:x,getOrderTypeColor:H,formatDate:P,formatCurrency:K,convertToInvoice:j,loadOrder:w,deleteOrder:ne,fetchHoldInvoices:ce,showPaymentDialog:oe,currentInvoice:ue,handlePaymentComplete:U,clearOrderHistory:L}=Ms(),{loading:_e,invoices:ye,error:De,pagination:G,fetchInvoices:E}=js();te(()=>X||_e);const Z=te(()=>me.value.filter(Y=>Y.paid_status===mt.UNPAID)),ge=te(()=>{let Y=Z.value;if(c.value!=="ALL"&&(Y=Y.filter(ie=>ie.paid_status===c.value)),I.value){const ie=I.value.toLowerCase();Y=Y.filter(B=>{var O,z;return((O=B.description)==null?void 0:O.toLowerCase().includes(ie))||((z=B.id)==null?void 0:z.toString().includes(ie))})}const q=(V.value-1)*y.value;return Y.slice(q,q+y.value)}),Re=te(()=>G.value.lastPage||1),Le=te(()=>{if(!Array.isArray(ye.value))return s.warn("Invoices is not an array:",ye.value),[];let Y=ye.value;if(C.value!=="ALL"&&(Y=Y.filter(q=>(q==null?void 0:q.status)===C.value)),T.value!=="ALL"&&(Y=Y.filter(q=>(q==null?void 0:q.paid_status)===T.value)),n.value){const q=n.value.toLowerCase();Y=Y.filter(be=>{var ie,B,O,z;return((ie=be==null?void 0:be.invoice_number)==null?void 0:ie.toLowerCase().includes(q))||((O=(B=be==null?void 0:be.customer)==null?void 0:B.name)==null?void 0:O.toLowerCase().includes(q))||((z=be==null?void 0:be.id)==null?void 0:z.toString().includes(q))})}return s.debug("Filtered delivery orders:",{total:ye.value.length,filtered:Y.length,filters:{status:C.value,paymentStatus:T.value,search:n.value}}),Y}),$e=te(()=>G.value.lastPage||1),Ee=te(()=>{if(!Array.isArray(ye.value))return s.warn("Invoices is not an array:",ye.value),[];let Y=ye.value;if(g.value!=="ALL"&&(Y=Y.filter(q=>(q==null?void 0:q.status)===g.value)),_.value!=="ALL"&&(Y=Y.filter(q=>(q==null?void 0:q.paid_status)===_.value)),u.value){const q=u.value.toLowerCase();Y=Y.filter(be=>{var ie,B,O,z;return((ie=be==null?void 0:be.invoice_number)==null?void 0:ie.toLowerCase().includes(q))||((O=(B=be==null?void 0:be.customer)==null?void 0:B.name)==null?void 0:O.toLowerCase().includes(q))||((z=be==null?void 0:be.id)==null?void 0:z.toString().includes(q))})}return s.debug("Filtered invoice orders:",{total:ye.value.length,filtered:Y.length,filters:{status:g.value,search:u.value}}),Y}),Ve=async Y=>{var be,ie;s.info("Loading order:",{id:Y.id,description:Y.description,type:Y.type}),await w(Y)?((be=window.toastr)==null||be.success("Order loaded successfully"),M(!1)):(ie=window.toastr)==null||ie.error("Failed to load order")},qe=async Y=>{var ie,B;console.log("HeldOrdersModal - Initial invoice data:",{id:Y.id,description:Y.description,rawTotal:Y.total,items:(ie=Y.hold_items)==null?void 0:ie.length,holdItems:(B=Y.hold_items)==null?void 0:B.map(O=>({name:O.name,price:O.price,quantity:O.quantity}))});let q=se.ensureCents(Y.total);console.log("HeldOrdersModal - Normalized total:",{originalTotal:Y.total,finalTotal:q,asDollars:se.toDollars(q)}),Y.total=q,Y.hold_items&&(Y.hold_items=Y.hold_items.map(O=>({...O,price:O.price%1!==0?se.ensureCents(O.price):O.price})));const be=await j(Y);console.log("HeldOrdersModal - Convert to invoice result:",{success:be.success,finalTotal:Y.total,asDollars:se.toDollars(Y.total)}),be.success?console.log("HeldOrdersModal - Conversion successful"):console.error("HeldOrdersModal - Conversion failed:",be.error)},Ce=Y=>{var q;if(!(Y!=null&&Y.id)){(q=window.toastr)==null||q.error("Invalid order selected");return}f.value=Y,d.value=!0},he=async()=>{var Y,q,be,ie;if(!((Y=f.value)!=null&&Y.id)){(q=window.toastr)==null||q.error("Invalid order selected");return}try{b.value=!0,await ne(f.value.id)&&(d.value=!1,await ce(),(be=window.toastr)==null||be.success("Order deleted successfully"))}catch(B){(ie=window.toastr)==null||ie.error(B.message||"Failed to delete order")}finally{b.value=!1,f.value=null}},Ze=Y=>{s.info("Order loaded to cart:",{id:Y.id,invoice_number:Y.invoice_number}),M(!1)};return we(()=>r.modelValue,async Y=>{Y&&await Promise.all([ce(),E()])}),we(m,async Y=>{if(Y==="invoices")await E({status:g.value!=="ALL"?g.value:"",invoiceNumber:u.value});else if(Y==="delivery"){N.value=!0;try{await E({type:["DELIVERY","PICKUP"],status:C.value!=="ALL"?C.value:"",invoiceNumber:n.value,page:h.value,orderByField:"invoice_number",orderBy:"desc"})}finally{N.value=!1}}}),we([n,C,T,h],async()=>{if(m.value==="delivery"){N.value=!0;try{const Y={type:["DELIVERY","PICKUP"],invoiceNumber:n.value,page:h.value,orderByField:"invoice_number",orderBy:"desc",per_page:10};C.value!=="ALL"&&(Y.status=C.value),T.value!=="ALL"&&(Y.paid_status=T.value),await E(Y)}finally{N.value=!1}}}),we([u,g,V],async()=>{m.value==="invoices"&&await E({status:g.value!=="ALL"?g.value:"",invoiceNumber:u.value,page:V.value,orderByField:"invoice_number",orderBy:"desc"})}),we(oe,async Y=>{console.log("HeldOrdersModal: Payment dialog state changed:",{showPaymentDialog:Y,hasCurrentInvoice:!!ue.value}),Y||ue.value&&(console.log("HeldOrdersModal: Payment dialog closed with current invoice, refreshing list"),await ce(),M(!1))}),ce(),(Y,q)=>{var be;return $(),ee("div",$l,[e(Q,{color:"primary","prepend-icon":"mdi-clipboard-list",onClick:q[0]||(q[0]=ie=>M(!0)),disabled:a.disabled,class:"text-none px-6 text-capitalize",rounded:"pill",elevation:Y.$vuetify.display.mobile?1:2,size:"large",block:Y.$vuetify.display.mobile},{default:t(()=>q[14]||(q[14]=[l("span",{class:"text-subtitle-1 font-weight-medium"},"ORDERS",-1)])),_:1},8,["disabled","elevation","block"]),e(ze,{"model-value":a.modelValue,"onUpdate:modelValue":M,fullscreen:"",transition:"dialog-bottom-transition",scrim:!1},{default:t(()=>[e(Pe,{class:"modal-card"},{default:t(()=>[e(Je,{color:"primary",density:"comfortable"},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>q[15]||(q[15]=[S(" Orders Management ")])),_:1}),e(Ne),e(Q,{icon:"",onClick:q[1]||(q[1]=ie=>M(!1))},{default:t(()=>[e(le,null,{default:t(()=>q[16]||(q[16]=[S("mdi-close")])),_:1})]),_:1})]),_:1}),e(Pa,{modelValue:m.value,"onUpdate:modelValue":q[2]||(q[2]=ie=>m.value=ie),"bg-color":"transparent",class:"orders-tabs px-2","show-arrows":!1},{default:t(()=>[e(zt,{value:"active",class:je(["tab-item flex-1 dine-in-tab",{"tab-active":m.value==="active"}])},{default:t(()=>[e(le,{start:""},{default:t(()=>q[17]||(q[17]=[S("mdi-silverware")])),_:1}),q[18]||(q[18]=S(" DINE IN | TOGO "))]),_:1},8,["class"]),e(zt,{value:"delivery",class:je(["tab-item flex-1 delivery-tab",{"tab-active":m.value==="delivery"}])},{default:t(()=>[e(le,{start:""},{default:t(()=>q[19]||(q[19]=[S("mdi-bike-fast")])),_:1}),q[20]||(q[20]=S(" DELIVERY | PICKUP "))]),_:1},8,["class"]),e(zt,{value:"invoices",class:je(["tab-item flex-1 history-tab",{"tab-active":m.value==="invoices"}])},{default:t(()=>[e(le,{start:""},{default:t(()=>q[21]||(q[21]=[S("mdi-history")])),_:1}),q[22]||(q[22]=S(" ORDER HISTORY "))]),_:1},8,["class"])]),_:1},8,["modelValue"]),e(Ba,{modelValue:m.value,"onUpdate:modelValue":q[11]||(q[11]=ie=>m.value=ie),class:"window-content"},{default:t(()=>[e(Yt,{value:"active",class:"window-item"},{default:t(()=>[e(or,{invoices:ge.value,"loading-order":F(v),"converting-order":F(R),"deleting-order":F(p),"get-order-type":F(x),"get-order-type-color":F(H),"format-date":F(P),"format-currency":F(K),onLoad:Ve,onConvert:qe,onDelete:Ce,onOrderLoaded:Ze,class:"table-component"},null,8,["invoices","loading-order","converting-order","deleting-order","get-order-type","get-order-type-color","format-date","format-currency"])]),_:1}),e(Yt,{value:"delivery",class:"window-item"},{default:t(()=>[e(de,{"no-gutters":""},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[l("div",kl,[e(de,null,{default:t(()=>[e(ae,{cols:"12",sm:"4"},{default:t(()=>[e(Se,{modelValue:n.value,"onUpdate:modelValue":q[3]||(q[3]=ie=>n.value=ie),label:"Search",density:"comfortable","hide-details":"","prepend-inner-icon":"mdi-magnify",variant:"outlined",class:"mb-2"},null,8,["modelValue"])]),_:1}),e(ae,{cols:"12",sm:"4"},{default:t(()=>[e(ut,{modelValue:C.value,"onUpdate:modelValue":q[4]||(q[4]=ie=>C.value=ie),items:["ALL","DRAFT","SENT","COMPLETED"],label:"Status",density:"comfortable","hide-details":"",variant:"outlined",class:"mb-2"},null,8,["modelValue"])]),_:1}),e(ae,{cols:"12",sm:"4"},{default:t(()=>[e(ut,{modelValue:T.value,"onUpdate:modelValue":q[5]||(q[5]=ie=>T.value=ie),items:["ALL","PAID","UNPAID"],label:"Payment Status",density:"comfortable","hide-details":"",variant:"outlined",class:"mb-2"},null,8,["modelValue"])]),_:1})]),_:1})])]),_:1}),e(ae,{cols:"12"},{default:t(()=>[e(pa,{loading:N.value,invoices:Le.value,"get-order-type":F(x),"get-order-type-color":F(H),"format-date":F(P),"show-pagination":!0,page:h.value,"total-pages":$e.value,"onUpdate:page":q[6]||(q[6]=ie=>h.value=ie),onRefresh:F(E),onLoad:Ve,onOrderLoaded:Ze,class:"table-component"},null,8,["loading","invoices","get-order-type","get-order-type-color","format-date","page","total-pages","onRefresh"])]),_:1})]),_:1})]),_:1}),e(Yt,{value:"invoices",class:"window-item"},{default:t(()=>[e(de,{"no-gutters":""},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[l("div",Nl,[e(de,null,{default:t(()=>[e(ae,{cols:"12",sm:"4"},{default:t(()=>[e(Se,{modelValue:u.value,"onUpdate:modelValue":q[7]||(q[7]=ie=>u.value=ie),label:"Search",density:"comfortable","hide-details":"","prepend-inner-icon":"mdi-magnify",variant:"outlined",class:"mb-2"},null,8,["modelValue"])]),_:1}),e(ae,{cols:"12",sm:"4"},{default:t(()=>[e(ut,{modelValue:g.value,"onUpdate:modelValue":q[8]||(q[8]=ie=>g.value=ie),items:["ALL","DRAFT","SENT","COMPLETED"],label:"Status",density:"comfortable","hide-details":"",variant:"outlined",class:"mb-2"},null,8,["modelValue"])]),_:1}),e(ae,{cols:"12",sm:"4"},{default:t(()=>[e(ut,{modelValue:_.value,"onUpdate:modelValue":q[9]||(q[9]=ie=>_.value=ie),items:["ALL","PAID","UNPAID"],label:"Payment Status",density:"comfortable","hide-details":"",variant:"outlined",class:"mb-2"},null,8,["modelValue"])]),_:1})]),_:1})])]),_:1}),e(ae,{cols:"12"},{default:t(()=>[e(pa,{loading:F(_e),invoices:Ee.value,"get-order-type":F(x),"get-order-type-color":F(H),"format-date":F(P),"show-pagination":!0,page:V.value,"total-pages":Re.value,"onUpdate:page":q[10]||(q[10]=ie=>V.value=ie),onRefresh:F(E),onLoad:Ve,onOrderLoaded:Ze,class:"table-component"},null,8,["loading","invoices","get-order-type","get-order-type-color","format-date","page","total-pages","onRefresh"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model-value"]),e(lr,{modelValue:d.value,"onUpdate:modelValue":q[12]||(q[12]=ie=>d.value=ie),loading:b.value,"order-description":(be=f.value)==null?void 0:be.description,onConfirm:he},null,8,["modelValue","loading","order-description"]),e(la,{modelValue:F(oe),"onUpdate:modelValue":q[13]||(q[13]=ie=>Et(oe)?oe.value=ie:null),invoice:F(ue)||{},onPaymentComplete:F(U)},null,8,["modelValue","invoice","onPaymentComplete"])])}}},Al=Te(El,[["__scopeId","data-v-534fe6bc"]]);const Fl={class:"d-flex justify-space-between align-center"},Ul={key:0,class:"d-flex flex-column align-center"},zl={class:"d-flex align-center justify-center"},Rl={class:"mx-2 text-h6"},Ll={key:1,class:"d-flex align-center justify-center"},ql={class:"text-body-1"},Ml={key:2,class:"d-flex align-center justify-center"},jl={__name:"DineInModal",props:{disabled:{type:Boolean,default:!1}},setup(a,{expose:o}){const r=gt(),i=He(),d=rt(),{loading:b,error:f,getTables:m,isTableOccupied:I,setTableOccupancy:c,currentCashRegister:u}=Mt(),g=te(()=>d.selectedStore),_=te(()=>d.selectedCashier);te(()=>{const j=!!g.value,w=!!_.value,ne=!i.isEmpty;return s.debug("[DineInModal] Order prerequisites:",{hasStore:j,hasCashier:w,hasItems:ne,selectedStore:g.value,selectedCashier:_.value,companyStoreState:{store:d.selectedStore,cashier:d.selectedCashier}}),j&&w&&ne});const{setOrderType:V,setCustomerInfo:y,canCreateOrder:n}=xt(),C=D(!1),T=te(()=>b.value),h=D(!1),N=D([]),M=D([]),X=j=>!I(j.id)||v(j.id),v=j=>M.value.some(w=>w.id===j),p=j=>{const w=M.value.find(ne=>ne.id===j);return w?w.quantity:1},R=j=>{var ne;if(!X(j)){(ne=window.toastr)==null||ne.warning("This table is currently occupied");return}const w=M.value.findIndex(ce=>ce.id===j.id);w>=0?M.value.splice(w,1):M.value.push({id:j.id,name:j.name,quantity:1})},me=j=>{const w=M.value.find(ne=>ne.id===j);w&&w.quantity++},x=j=>{const w=M.value.find(ne=>ne.id===j);w&&w.quantity>1&&w.quantity--},H=async()=>{var j;try{N.value=await m()}catch(w){s.error("Failed to retry loading tables:",w),(j=window.toastr)==null||j.error("Failed to load tables")}},P=async()=>{var j,w,ne,ce;if(!(!M.value.length||!n.value)){if(!g.value||!_.value){(j=window.toastr)==null||j.error("Please select both store and cashier"),s.warn("[DineInModal] Missing store or cashier selection",{store:g.value,cashier:_.value});return}h.value=!0,s.info("[DineInModal] Processing order with store/cashier:",{store:g.value,cashier:_.value});try{V(Ae.DINE_IN);const oe=M.value.map(ye=>({id:ye.id,table_id:ye.id,name:ye.name,quantity:ye.quantity,in_use:1})),ue=oe.map(ye=>ye.name).join(", "),U=oe.reduce((ye,De)=>ye+De.quantity,0);y({tableNumbers:ue,tables:oe,customerCount:U}),i.setSelectedTables(oe);const L={orderInfo:{customer:{tableNumbers:ue,customerCount:U},tables:oe}};i.setNotes(JSON.stringify(L));const _e={...i.prepareHoldInvoiceData(g.value,_.value,`DINE_IN_Table_${ue}`),tables_selected:oe.map(ye=>({id:ye.id,table_id:ye.id,name:ye.name,quantity:ye.quantity,in_use:1})),hold_tables:oe.map(ye=>({id:ye.id,table_id:ye.id,name:ye.name,quantity:ye.quantity,in_use:1}))};try{await r.holdOrder(_e),oe.forEach(ye=>{c(ye.table_id,!0)}),await m(),i.clearCart(),C.value=!1,(w=window.toastr)==null||w.success("Dine-in order held successfully")}catch(ye){s.error("Hold order error:",ye),await new Promise(G=>setTimeout(G,500)),await r.fetchHoldInvoices(),r.holdInvoices.some(G=>{var E;return G.type===Ae.DINE_IN&&((E=G.description)==null?void 0:E.includes(`DINE_IN_Table_${ue}`))})&&(oe.forEach(G=>{c(G.table_id,!0)}),await m(),i.clearCart(),C.value=!1,(ne=window.toastr)==null||ne.success("Dine-in order held successfully"))}}catch(oe){s.error("Failed to hold dine-in order:",oe),(ce=window.toastr)==null||ce.error("Failed to create dine-in order")}finally{h.value=!1}}},K=()=>{h.value||(C.value=!1,M.value=[])};return wt(()=>{s.info("[DineInModal] Component mounted"),(async()=>{try{d.isInitialized||(s.debug("[DineInModal] Initializing company store"),await d.initializeStore()),s.info("[DineInModal] Store state after mount:",{store:g.value,cashier:_.value,companyStore:{selectedStore:d.selectedStore,selectedCashier:d.selectedCashier}})}catch(w){s.error("[DineInModal] Initialization error:",w),f.value="Failed to initialize store selections"}})()}),we(C,async j=>{var w;if(j)try{V(Ae.DINE_IN),N.value=await m()}catch(ne){s.error("Failed to initialize dine-in modal:",ne),(w=window.toastr)==null||w.error("Failed to load tables")}else M.value=[]}),o({dialog:C}),(j,w)=>($(),re(ze,{modelValue:C.value,"onUpdate:modelValue":w[0]||(w[0]=ne=>C.value=ne),fullscreen:"",transition:"dialog-bottom-transition",scrim:!1},{activator:t(({props:ne})=>[e(Q,pt({color:"primary"},ne,{"prepend-icon":"mdi-table-furniture",loading:T.value,disabled:a.disabled||F(i).isEmpty,class:"text-none px-6",rounded:"pill",elevation:j.$vuetify.display.mobile?1:2,size:"large",block:j.$vuetify.display.mobile}),{default:t(()=>w[1]||(w[1]=[l("span",{class:"text-subtitle-1 font-weight-medium"},"DINE IN",-1)])),_:2},1040,["loading","disabled","elevation","block"])]),default:t(()=>[e(Pe,{class:"modal-card"},{default:t(()=>[e(Je,{color:"primary",density:"comfortable"},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>w[2]||(w[2]=[S(" Table Selection ")])),_:1}),e(Ne),e(Q,{icon:"",onClick:K},{default:t(()=>[e(le,null,{default:t(()=>w[3]||(w[3]=[S("mdi-close")])),_:1})]),_:1})]),_:1}),e(ke,{class:"pa-0 fill-height d-flex flex-column"},{default:t(()=>[e(ot,{fluid:"",class:"flex-grow-1 pa-4"},{default:t(()=>[T.value?($(),re(de,{key:0,class:"fill-height"},{default:t(()=>[e(ae,{cols:"12",class:"d-flex align-center justify-center"},{default:t(()=>[e(lt,{indeterminate:"",size:"64"})]),_:1})]),_:1})):F(f)?($(),re(de,{key:1,class:"fill-height"},{default:t(()=>[e(ae,{cols:"12",class:"d-flex align-center justify-center"},{default:t(()=>[e(at,{type:"error",variant:"tonal",width:"100%","max-width":"500"},{append:t(()=>[e(Q,{color:"error",variant:"text",onClick:H},{default:t(()=>w[4]||(w[4]=[S(" Retry ")])),_:1})]),default:t(()=>[S(A(F(f))+" ",1)]),_:1})]),_:1})]),_:1})):N.value.length?($(),re(de,{key:3,class:"table-grid"},{default:t(()=>[($(!0),ee(xe,null,Ye(N.value,ne=>($(),re(ae,{key:ne.id,cols:"12",sm:"6",md:"4",lg:"3",class:"table-col pa-2"},{default:t(()=>[e(Ka,null,{default:t(({isHovering:ce,props:oe})=>[e(Pe,pt({ref_for:!0},oe,{elevation:ce?4:1,class:["table-card","transition-swing",v(ne.id)?"selected":"",X(ne)?"available":"occupied"],onClick:ue=>R(ne)}),{default:t(()=>[e(aa,{class:"pa-2"},{default:t(()=>[l("div",Fl,[e(ft,{class:"text-h6 font-weight-bold pa-0"},{default:t(()=>[S(A(ne.name),1)]),_:2},1024),e(vt,{color:X(ne)?"success":"error",size:"small",class:"font-weight-medium text-caption",variant:"elevated"},{default:t(()=>[S(A(X(ne)?"Available":"In Use"),1)]),_:2},1032,["color"])])]),_:2},1024),e(ke,{class:"text-center pa-2"},{default:t(()=>[v(ne.id)?($(),ee("div",Ul,[w[6]||(w[6]=l("div",{class:"text-subtitle-2 mb-1"},"Number of People",-1)),l("div",zl,[e(Q,{icon:"mdi-minus",size:"small",variant:"text",density:"compact",onClick:Ct(ue=>x(ne.id),["stop"]),disabled:p(ne.id)<=1},null,8,["onClick","disabled"]),l("span",Rl,A(p(ne.id)),1),e(Q,{icon:"mdi-plus",size:"small",variant:"text",density:"compact",onClick:Ct(ue=>me(ne.id),["stop"])},null,8,["onClick"])])])):X(ne)?($(),ee("div",Ml,[e(le,{size:"small",color:"success",class:"mr-1"},{default:t(()=>w[8]||(w[8]=[S("mdi-cursor-pointer")])),_:1}),w[9]||(w[9]=l("span",{class:"text-body-2"},"Click to Select",-1))])):($(),ee("div",Ll,[e(le,{color:"error",size:"small",class:"mr-1"},{default:t(()=>w[7]||(w[7]=[S("mdi-account-group")])),_:1}),l("span",ql,A(ne.quantity)+" People",1)]))]),_:2},1024)]),_:2},1040,["elevation","class","onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})):($(),re(de,{key:2,class:"fill-height"},{default:t(()=>[e(ae,{cols:"12",class:"d-flex align-center justify-center"},{default:t(()=>[e(at,{type:"info",variant:"tonal",width:"100%","max-width":"500"},{default:t(()=>w[5]||(w[5]=[S(" No tables available for this cash register ")])),_:1})]),_:1})]),_:1}))]),_:1}),e(ot,{fluid:"",class:"pa-4 pt-0"},{default:t(()=>[e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Q,{block:"",color:"primary",size:"large",loading:h.value,disabled:!M.value.length||h.value,onClick:P,class:"text-none"},{default:t(()=>w[10]||(w[10]=[S(" CONFIRM AND HOLD ORDER ")])),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Gl=Te(jl,[["__scopeId","data-v-fb6d6b11"]]);const Hl={__name:"ToGoModal",props:{disabled:{type:Boolean,default:!1}},setup(a){const o=He(),r=rt(),i=gt(),{customerNotes:d}=xt(),b=D(!1),f=D(!1),m=D(!1),I=D(null),c=D(null),u=D(!1),g=ht({name:"",phone:"",email:"",notes:""}),_=ht({name:"",phone:"",email:"",notes:""}),V=te(()=>r.selectedStore),y=te(()=>r.selectedCashier),n=v=>{var p;try{let R={};try{o.notes&&(R=JSON.parse(o.notes))}catch(x){s.warn("Failed to parse existing notes:",x)}const me={...R,customerNotes:v,timestamp:new Date().toISOString(),orderType:Ae.TO_GO,orderInfo:{...R.orderInfo,customer:{...(p=R.orderInfo)==null?void 0:p.customer,name:g.name.trim(),phone:g.phone.replace(/\D/g,""),email:g.email.trim(),notes:v,instructions:v}}};o.setNotes(JSON.stringify(me)),s.debug("Updated cart notes:",me)}catch(R){s.error("Failed to update cart notes:",R)}},C=()=>{h();let v=!0;return g.name.trim()||(_.name="Name is required",v=!1),g.phone.trim()||(_.phone="Phone number is required",v=!1),g.email&&!g.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)&&(_.email="Invalid email format",v=!1),v},T=v=>{_[v]=""},h=()=>{Object.keys(_).forEach(v=>{_[v]=""})},N=async()=>{var v,p,R,me,x,H,P;if(C()){m.value=!0,I.value=null;try{const K=g.phone.replace(/\D/g,""),w={...o.prepareHoldInvoiceData(V.value,y.value,`TO_GO_${g.name}`),type:Ae.TO_GO,description:`TO_GO_${g.name}`,cash_register_id:((v=r.selectedCashier)==null?void 0:v.id)||((p=r.company)==null?void 0:p.id)||1,hold_items:o.items.map(U=>({item_id:U.id,name:U.name,description:U.description||"",price:U.price,quantity:U.quantity,unit_name:U.unit_name||"units",tax:U.tax||0}))};if(delete w.tip,delete w.tip_type,delete w.tip_val,!((R=w.hold_items)!=null&&R.length))throw new Error("No items found in cart");const ne={customerNotes:g.notes,timestamp:new Date().toISOString(),orderType:Ae.TO_GO,orderInfo:{customer:{name:g.name.trim(),phone:K,email:g.email.trim(),notes:g.notes,instructions:g.notes}}};w.notes=JSON.stringify(ne),s.debug("Processing TO-GO order with data:",{type:w.type,description:w.description,total:w.total,items:(me=w.hold_items)==null?void 0:me.length,notes:w.notes});const ce=await i.holdOrder(w);if(s.debug("Hold order response:",ce),!(ce!=null&&ce.success))throw new Error((ce==null?void 0:ce.message)||"Failed to create hold order");await i.fetchHoldInvoices();const oe=i.holdInvoices.find(U=>U.description===w.description&&U.type===Ae.TO_GO);if(!oe)throw s.error("Could not find newly created hold invoice"),new Error("Failed to retrieve created hold invoice");if(!oe.total||!((x=oe.hold_items)!=null&&x.length))throw s.error("Missing required hold invoice fields:",oe),new Error("Invalid hold invoice data: missing total or items");const ue=oe.id;if(o.setHoldInvoiceId(ue),s.info("TO-GO hold order created successfully:",{holdInvoiceId:ue,description:oe.description,total:oe.total,items:(H=oe.hold_items)==null?void 0:H.length}),c.value={invoice:oe,invoicePrefix:"TO-GO",nextInvoiceNumber:ue,description:oe.description},!((P=c.value.invoice)!=null&&P.total))throw s.error("Invalid invoice data for payment:",c.value),new Error("Invalid invoice data for payment");u.value=!0,b.value=!1}catch(K){I.value=K.message||"Failed to process order",s.error("Failed to process TO-GO order:",K)}finally{m.value=!1}}},M=v=>{s.info("Payment completed:",v),u.value=!1,b.value=!1,Object.keys(g).forEach(p=>{g[p]=""})},X=()=>{b.value=!1,I.value=null,Object.keys(g).forEach(v=>{g[v]=""})};return we(b,v=>{if(v){if(!V.value||!y.value){I.value="Please select both store and cashier first",b.value=!1;return}try{const p=yt(o.notes);p&&(g.notes=p,s.debug("Initialized notes from cart store:",{notes:p}))}catch(p){s.error("Failed to parse cart notes:",p)}}}),we(()=>o.notes,v=>{try{const p=yt(v);p&&p!==g.notes&&(g.notes=p,s.debug("Updated notes from cart store:",{notes:p}))}catch(p){s.error("Failed to parse cart notes:",p)}}),we(()=>d.value,v=>{v!==g.notes&&(g.notes=v,s.debug("Updated notes from customer notes:",{newNotes:v}))}),(v,p)=>($(),re(ze,{modelValue:b.value,"onUpdate:modelValue":p[9]||(p[9]=R=>b.value=R),fullscreen:"",transition:"dialog-bottom-transition",scrim:!1},{activator:t(({props:R})=>[e(Q,pt({color:"primary"},R,{"prepend-icon":"mdi-shopping",loading:f.value,disabled:a.disabled||F(o).isEmpty,class:"text-none px-6",rounded:"pill",elevation:v.$vuetify.display.mobile?1:2,size:"large",block:v.$vuetify.display.mobile}),{default:t(()=>p[10]||(p[10]=[l("span",{class:"text-subtitle-1 font-weight-medium"},"TO GO",-1)])),_:2},1040,["loading","disabled","elevation","block"])]),default:t(()=>[e(Pe,{class:"modal-card"},{default:t(()=>[e(Je,{color:"primary",density:"comfortable"},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>[e(le,{icon:"mdi-shopping",size:"large",class:"mr-2"}),p[11]||(p[11]=S(" To Go Order "))]),_:1}),e(Ne),e(Q,{icon:"",onClick:X},{default:t(()=>[e(le,null,{default:t(()=>p[12]||(p[12]=[S("mdi-close")])),_:1})]),_:1})]),_:1}),e(ke,{class:"pa-0 fill-height d-flex flex-column"},{default:t(()=>[e(ot,{fluid:"",class:"flex-grow-1 pa-4"},{default:t(()=>[e(Ia,null,{default:t(()=>[f.value?($(),re(de,{key:0},{default:t(()=>[e(ae,{cols:"12",class:"text-center"},{default:t(()=>[e(lt,{indeterminate:"",color:"primary",size:"64"})]),_:1})]),_:1})):I.value?($(),re(de,{key:1},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(at,{type:"error",variant:"tonal",closable:"",class:"mb-4","onClick:close":p[0]||(p[0]=R=>I.value=null)},{default:t(()=>[S(A(I.value),1)]),_:1})]),_:1})]),_:1})):($(),re(Ya,{key:2,onSubmit:Ct(N,["prevent"])},{default:t(()=>[e(de,null,{default:t(()=>[e(ae,{cols:"12",md:"6"},{default:t(()=>[p[13]||(p[13]=l("div",{class:"text-subtitle-1 mb-2"},"Customer Information",-1)),e(Se,{modelValue:g.name,"onUpdate:modelValue":p[1]||(p[1]=R=>g.name=R),label:"Customer Name",variant:"outlined",density:"comfortable","error-messages":_.name,onInput:p[2]||(p[2]=R=>T("name")),required:"","prepend-inner-icon":"mdi-account",placeholder:"Enter customer name",class:"mb-4","bg-color":"surface"},null,8,["modelValue","error-messages"]),e(Se,{modelValue:g.phone,"onUpdate:modelValue":p[3]||(p[3]=R=>g.phone=R),label:"Phone Number",variant:"outlined",density:"comfortable","error-messages":_.phone,onInput:p[4]||(p[4]=R=>T("phone")),required:"","prepend-inner-icon":"mdi-phone",placeholder:"Enter phone number",class:"mb-4","bg-color":"surface"},null,8,["modelValue","error-messages"]),e(Se,{modelValue:g.email,"onUpdate:modelValue":p[5]||(p[5]=R=>g.email=R),label:"Email",variant:"outlined",density:"comfortable","error-messages":_.email,onInput:p[6]||(p[6]=R=>T("email")),"prepend-inner-icon":"mdi-email",placeholder:"Enter email address",class:"mb-4","bg-color":"surface"},null,8,["modelValue","error-messages"])]),_:1}),e(ae,{cols:"12",md:"6"},{default:t(()=>[p[14]||(p[14]=l("div",{class:"text-subtitle-1 mb-2"},"Order Notes",-1)),e(oa,{modelValue:g.notes,"onUpdate:modelValue":p[7]||(p[7]=R=>g.notes=R),label:"Special Instructions",variant:"outlined",density:"comfortable","error-messages":_.notes,onInput:n,"prepend-inner-icon":"mdi-note-text",placeholder:"Enter any special instructions",rows:"4","auto-grow":"","bg-color":"surface"},null,8,["modelValue","error-messages"])]),_:1})]),_:1})]),_:1}))]),_:1})]),_:1}),e(bt),e(st,{class:"pa-4"},{default:t(()=>[e(Ne),e(Q,{color:"primary",size:"large",loading:f.value,disabled:f.value,onClick:N,class:"px-6"},{default:t(()=>[e(le,{start:""},{default:t(()=>p[15]||(p[15]=[S("mdi-cash-register")])),_:1}),p[16]||(p[16]=S(" Process Order "))]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1}),e(la,{modelValue:u.value,"onUpdate:modelValue":p[8]||(p[8]=R=>u.value=R),invoice:c.value,onPaymentComplete:M},null,8,["modelValue","invoice"])]),_:1},8,["modelValue"]))}},Bl=Te(Hl,[["__scopeId","data-v-5d2eab5a"]]),Kl={async getStates(a="US"){try{return(await Ue.get(`/v1/states/${a}`)).data}catch(o){throw o}}},$a={__name:"StateDropdown",props:{modelValue:{type:String,required:!0},label:{type:String,default:"State"},required:{type:Boolean,default:!0},disabled:{type:Boolean,default:!1},error:{type:String,default:void 0},countryCode:{type:String,default:"US"}},emits:["update:modelValue","state-selected"],setup(a,{emit:o}){const r=a,i=o,d=D(!1),b=D([]),f=D(r.modelValue),m=async()=>{d.value=!0;try{const c=await Kl.getStates(r.countryCode);b.value=c.states,s.info(`Loaded ${b.value.length} states`)}catch(c){throw s.error("Failed to fetch states:",c),c}finally{d.value=!1}},I=c=>{const u=b.value.find(g=>g.code===c);u&&(i("update:modelValue",c),i("state-selected",u),s.debug("State selected:",u))};return we(()=>r.modelValue,c=>{f.value=c}),wt(()=>{m()}),(c,u)=>($(),re(sa,{modelValue:f.value,"onUpdate:modelValue":[u[0]||(u[0]=g=>f.value=g),I],items:b.value,loading:d.value,"error-messages":a.error,label:a.label,required:a.required,disabled:a.disabled,"item-title":"name","item-value":"code",variant:"outlined",density:"comfortable",hint:d.value?"Loading states...":void 0,"persistent-hint":""},{"no-data":t(()=>[d.value?($(),re(St,{key:0},{default:t(()=>[e(Nt,null,{default:t(()=>u[1]||(u[1]=[S(" Loading states... ")])),_:1})]),_:1})):($(),re(St,{key:1},{default:t(()=>[e(Nt,null,{default:t(()=>u[2]||(u[2]=[S(" No states found ")])),_:1})]),_:1}))]),_:1},8,["modelValue","items","loading","error-messages","label","required","disabled","hint"]))}};var Ut=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Yl(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function Ql(a){var o=typeof a;return a!=null&&(o=="object"||o=="function")}var ka=Ql,Wl=typeof Ut=="object"&&Ut&&Ut.Object===Object&&Ut,Jl=Wl,Xl=Jl,Zl=typeof self=="object"&&self&&self.Object===Object&&self,en=Xl||Zl||Function("return this")(),Na=en,tn=Na,an=function(){return tn.Date.now()},on=an,sn=/\s/;function rn(a){for(var o=a.length;o--&&sn.test(a.charAt(o)););return o}var ln=rn,nn=ln,dn=/^\s+/;function un(a){return a&&a.slice(0,nn(a)+1).replace(dn,"")}var cn=un,mn=Na,pn=mn.Symbol,Ea=pn,fa=Ea,Aa=Object.prototype,fn=Aa.hasOwnProperty,vn=Aa.toString,Tt=fa?fa.toStringTag:void 0;function yn(a){var o=fn.call(a,Tt),r=a[Tt];try{a[Tt]=void 0;var i=!0}catch{}var d=vn.call(a);return i&&(o?a[Tt]=r:delete a[Tt]),d}var gn=yn,_n=Object.prototype,bn=_n.toString;function hn(a){return bn.call(a)}var wn=hn,va=Ea,In=gn,Pn=wn,Cn="[object Null]",On="[object Undefined]",ya=va?va.toStringTag:void 0;function Sn(a){return a==null?a===void 0?On:Cn:ya&&ya in Object(a)?In(a):Pn(a)}var xn=Sn;function Dn(a){return a!=null&&typeof a=="object"}var Vn=Dn,Tn=xn,$n=Vn,kn="[object Symbol]";function Nn(a){return typeof a=="symbol"||$n(a)&&Tn(a)==kn}var En=Nn,An=cn,ga=ka,Fn=En,_a=0/0,Un=/^[-+]0x[0-9a-f]+$/i,zn=/^0b[01]+$/i,Rn=/^0o[0-7]+$/i,Ln=parseInt;function qn(a){if(typeof a=="number")return a;if(Fn(a))return _a;if(ga(a)){var o=typeof a.valueOf=="function"?a.valueOf():a;a=ga(o)?o+"":o}if(typeof a!="string")return a===0?a:+a;a=An(a);var r=zn.test(a);return r||Rn.test(a)?Ln(a.slice(2),r?2:8):Un.test(a)?_a:+a}var Mn=qn,jn=ka,Xt=on,ba=Mn,Gn="Expected a function",Hn=Math.max,Bn=Math.min;function Kn(a,o,r){var i,d,b,f,m,I,c=0,u=!1,g=!1,_=!0;if(typeof a!="function")throw new TypeError(Gn);o=ba(o)||0,jn(r)&&(u=!!r.leading,g="maxWait"in r,b=g?Hn(ba(r.maxWait)||0,o):b,_="trailing"in r?!!r.trailing:_);function V(v){var p=i,R=d;return i=d=void 0,c=v,f=a.apply(R,p),f}function y(v){return c=v,m=setTimeout(T,o),u?V(v):f}function n(v){var p=v-I,R=v-c,me=o-p;return g?Bn(me,b-R):me}function C(v){var p=v-I,R=v-c;return I===void 0||p>=o||p<0||g&&R>=b}function T(){var v=Xt();if(C(v))return h(v);m=setTimeout(T,n(v))}function h(v){return m=void 0,_&&i?V(v):(i=d=void 0,f)}function N(){m!==void 0&&clearTimeout(m),c=0,i=I=d=m=void 0}function M(){return m===void 0?f:h(Xt())}function X(){var v=Xt(),p=C(v);if(i=arguments,d=this,I=v,p){if(m===void 0)return y(I);if(g)return clearTimeout(m),m=setTimeout(T,o),V(I)}return m===void 0&&(m=setTimeout(T,o)),f}return X.cancel=N,X.flush=M,X}var Yn=Kn;const Fa=Yl(Yn);function na(){const a=D([]),o=D(!1),r=D(null),i=D(""),d=Fa(async f=>{var m,I;if(!f||f.length<3){a.value=[],r.value=null;return}if(f!==i.value){i.value=f,o.value=!0,r.value=null;try{const c=await Ue.get("/v1/customers",{params:{search:f,status_customer:"A",orderByField:"created_at",orderBy:"desc",page:1}});(I=(m=c.data)==null?void 0:m.customers)!=null&&I.data&&(a.value=c.data.customers.data.map(u=>{const g=u.phone?u.phone.replace(/(\d{3})(\d{3})(\d{4})/,"$1$2$3"):"No phone";return{title:u.name,subtitle:`${g}  ${u.email||""}`,value:u}}))}catch(c){s.error("Customer search failed:",c),r.value="Failed to search customers",a.value=[]}finally{o.value=!1}}},350);return{searchResults:a,isSearching:o,searchError:r,searchCustomers:d,createCustomer:async f=>{var m,I;try{return(await Ue.post("/v2/core-pos/customer",f)).data}catch(c){s.error("Customer creation failed:",c);const u=((I=(m=c.response)==null?void 0:m.data)==null?void 0:I.message)||c.message||"Failed to create customer";throw new Error(u)}}}}const Qn={__name:"CreateCustomerDialog",props:{modelValue:Boolean},emits:["update:modelValue","customer-created"],setup(a,{emit:o}){const r=a,i=o,{createCustomer:d}=na(),b=te({get:()=>r.modelValue,set:T=>i("update:modelValue",T)}),f=ht({name:"",phone:"",email:"",address:"",unit:"",city:"",state:"",state_id:null,zipCode:""}),m=T=>{f.state_id=T.id},I={...f},c=()=>{Object.assign(f,I),y()},u=ht({name:"",phone:"",address:"",city:"",state:"",zipCode:""}),g=D(!1),_=()=>{let T=!0;return y(),f.name.trim()?f.name.trim().length<3?(u.name="Name must be at least 3 characters",T=!1):f.name.trim().length>100&&(u.name="Name must not exceed 100 characters",T=!1):(u.name="Name is required",T=!1),f.phone.trim()&&(f.phone.trim().length<3||f.phone.trim().length>25)&&(u.phone="Phone number must be between 3 and 25 characters",T=!1),f.address.trim()&&(f.address.trim().length<3||f.address.trim().length>120)&&(u.address="Address must be between 3 and 120 characters",T=!1),f.city.trim()?f.city.trim().length>50&&(u.city="City must not exceed 50 characters",T=!1):(u.city="City is required",T=!1),f.state.trim()?f.state.trim().length>2&&(u.state="Please use 2-letter state code",T=!1):(u.state="State is required",T=!1),f.zipCode.trim()?/^\d{5}(-\d{4})?$/.test(f.zipCode.trim())||(u.zipCode="Invalid ZIP code format",T=!1):(u.zipCode="ZIP code is required",T=!1),f.email.trim()&&(f.email.trim().length<5||f.email.trim().length>120?(u.email="Email must be between 5 and 120 characters",T=!1):/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email.trim())||(u.email="Please enter a valid email address",T=!1)),T},V=T=>{u[T]=""},y=()=>{Object.keys(u).forEach(T=>{u[T]=""})},n=async()=>{var T,h,N;if(_()){g.value=!0;try{const M={name:f.name.trim(),phone:f.phone.trim(),...f.email.trim()&&{email:f.email.trim()},address_street_1:f.address.trim(),address_street_2:f.unit.trim()||null,city:f.city.trim(),state:f.state.trim(),zip:f.zipCode.trim(),state_id:f.state_id,status_customer:"A",company_id:1,avalara_type:0,prepaid_option:0,notes:"",first_name:f.name.trim(),last_name:f.name.trim(),contact_name:f.name.trim(),customer_type:"R",role:"customer",sale_type:"Retail",language:"en",timezone:"America/Chicago",status_payment:"prepaid",type_vat_regime:1,incorporated:1,lfln:1};try{const X=await d(M);if(!(X!=null&&X.id))throw new Error("Invalid response from server");const v={id:X.id,...M};window.toastr&&window.toastr.success("Customer created successfully"),i("customer-created",v),c(),C()}catch(X){if((T=X.response)!=null&&T.data){const v=X.response.data;if(v.code==="DUPLICATE_ENTRY"){if(v.field==="phone")u.phone="This phone number is already registered";else if(v.field==="email")u.email="This email is already registered";else throw new Error(v.message||"Customer already exists");return}if(v.details){Object.keys(v.details).forEach(p=>{u.hasOwnProperty(p)&&(u[p]=v.details[p])});return}}throw X}}catch(M){console.error("Customer creation error:",M);const X=((N=(h=M.response)==null?void 0:h.data)==null?void 0:N.message)||M.message||"Failed to create customer";window.toastr?window.toastr.error(X):console.error(X)}finally{g.value=!1}}},C=()=>{g.value||(c(),b.value=!1)};return we(()=>r.modelValue,T=>{!T&&g.value&&(b.value=!0)}),(T,h)=>($(),re(ze,{modelValue:b.value,"onUpdate:modelValue":h[14]||(h[14]=N=>b.value=N),"max-width":"600",scrim:!0,transition:"dialog-bottom-transition",class:"rounded-lg"},{default:t(()=>[e(Pe,{class:"rounded-lg"},{default:t(()=>[e(Je,{color:"primary",density:"comfortable"},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>h[15]||(h[15]=[S(" Create New Customer ")])),_:1}),e(Ne),e(Q,{icon:"mdi-close",variant:"text",onClick:C})]),_:1}),e(ke,null,{default:t(()=>[e(ot,null,{default:t(()=>[e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[h[16]||(h[16]=l("div",{class:"text-subtitle-1 mb-2"},"Customer Information",-1)),e(Se,{modelValue:f.name,"onUpdate:modelValue":h[0]||(h[0]=N=>f.name=N),label:"Full Name","error-messages":u.name,onInput:h[1]||(h[1]=N=>V("name")),required:"",variant:"outlined",density:"comfortable",class:"mb-3"},null,8,["modelValue","error-messages"]),e(Se,{modelValue:f.phone,"onUpdate:modelValue":h[2]||(h[2]=N=>f.phone=N),label:"Phone Number","error-messages":u.phone,onInput:h[3]||(h[3]=N=>V("phone")),required:"",variant:"outlined",density:"comfortable",class:"mb-3"},null,8,["modelValue","error-messages"]),e(Se,{modelValue:f.email,"onUpdate:modelValue":h[4]||(h[4]=N=>f.email=N),label:"Email (Optional)",variant:"outlined",density:"comfortable",class:"mb-3"},null,8,["modelValue"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[h[17]||(h[17]=l("div",{class:"text-subtitle-1 mb-2"},"Address Information",-1)),e(Se,{modelValue:f.address,"onUpdate:modelValue":h[5]||(h[5]=N=>f.address=N),label:"Street Address","error-messages":u.address,onInput:h[6]||(h[6]=N=>V("address")),required:"",variant:"outlined",density:"comfortable",class:"mb-3"},null,8,["modelValue","error-messages"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12",sm:"6"},{default:t(()=>[e(Se,{modelValue:f.unit,"onUpdate:modelValue":h[7]||(h[7]=N=>f.unit=N),label:"Apt/Suite/Unit (Optional)",variant:"outlined",density:"comfortable",class:"mb-3"},null,8,["modelValue"])]),_:1}),e(ae,{cols:"12",sm:"6"},{default:t(()=>[e(Se,{modelValue:f.zipCode,"onUpdate:modelValue":h[8]||(h[8]=N=>f.zipCode=N),label:"ZIP Code","error-messages":u.zipCode,onInput:h[9]||(h[9]=N=>V("zipCode")),required:"",variant:"outlined",density:"comfortable",class:"mb-3"},null,8,["modelValue","error-messages"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12",sm:"6"},{default:t(()=>[e(Se,{modelValue:f.city,"onUpdate:modelValue":h[10]||(h[10]=N=>f.city=N),label:"City","error-messages":u.city,onInput:h[11]||(h[11]=N=>V("city")),required:"",variant:"outlined",density:"comfortable",class:"mb-3"},null,8,["modelValue","error-messages"])]),_:1}),e(ae,{cols:"12",sm:"6"},{default:t(()=>[e($a,{modelValue:f.state,"onUpdate:modelValue":[h[12]||(h[12]=N=>f.state=N),h[13]||(h[13]=N=>V("state"))],error:u.state,onStateSelected:m,class:"mb-3"},null,8,["modelValue","error"])]),_:1})]),_:1})]),_:1})]),_:1}),e(st,null,{default:t(()=>[e(ot,null,{default:t(()=>[e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Q,{color:"primary",size:"large",block:"",height:"56",onClick:n,loading:g.value,disabled:g.value,elevation:"2"},{default:t(()=>[e(le,{start:""},{default:t(()=>h[18]||(h[18]=[S("mdi-account-plus")])),_:1}),h[19]||(h[19]=S(" Create Customer "))]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Ua=Te(Qn,[["__scopeId","data-v-fe2be40d"]]);const Wn={class:"text-h5 mb-4"},Jn={class:"d-flex justify-space-between mb-2"},Xn={class:"d-flex justify-space-between mb-2"},Zn={__name:"DeliveryPaymentDialog",props:{modelValue:Boolean,invoice:{type:Object,required:!0,default:()=>({invoice:{},invoicePrefix:"",nextInvoiceNumber:""})}},emits:["update:modelValue","payment-complete"],setup(a,{emit:o}){const r=a,i=o;D(!1),D(!1),D(null);const d=te({get:()=>r.modelValue,set:c=>i("update:modelValue",c)}),b=te(()=>{var c,u,g,_;return((u=(c=r.invoice)==null?void 0:c.invoice)==null?void 0:u.invoice_number)||`${(g=r.invoice)==null?void 0:g.invoicePrefix}-${(_=r.invoice)==null?void 0:_.nextInvoiceNumber}`||""}),f=te(()=>{var c,u;return((u=(c=r.invoice)==null?void 0:c.invoice)==null?void 0:u.total)||0}),m=c=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(c),I=()=>{i("payment-complete",!0),d.value=!1};return(c,u)=>($(),re(ze,{modelValue:d.value,"onUpdate:modelValue":u[0]||(u[0]=g=>d.value=g),fullscreen:"",transition:"dialog-bottom-transition",scrim:!1,class:"payment-dialog"},{default:t(()=>[e(Pe,{class:"modal-card"},{default:t(()=>[e(Je,{color:"primary",density:"comfortable"},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>{var g,_,V,y;return[e(le,{icon:((_=(g=r.invoice)==null?void 0:g.invoice)==null?void 0:_.type)==="PICKUP"?"mdi-store-clock":"mdi-truck-delivery",size:"large",class:"mr-2"},null,8,["icon"]),S(" "+A(((y=(V=r.invoice)==null?void 0:V.invoice)==null?void 0:y.type)==="PICKUP"?"Process Pick Up Order":"Process Delivery Order"),1)]}),_:1}),e(Ne),e(Q,{icon:"",onClick:I},{default:t(()=>[e(le,null,{default:t(()=>u[1]||(u[1]=[S("mdi-close")])),_:1})]),_:1})]),_:1}),e(ke,{class:"pa-0 fill-height d-flex flex-column"},{default:t(()=>[e(ot,{fluid:"",class:"flex-grow-1 pa-4"},{default:t(()=>[e(de,null,{default:t(()=>[e(ae,{cols:"12",class:"text-center"},{default:t(()=>{var g,_;return[e(le,{icon:"mdi-check-circle",color:"success",size:"64",class:"mb-4"}),l("h2",Wn,A(((_=(g=r.invoice)==null?void 0:g.invoice)==null?void 0:_.type)==="PICKUP"?"Pick Up Order Created Successfully":"Delivery Order Created Successfully"),1),e(Pe,{variant:"outlined",class:"invoice-summary-card mb-4"},{default:t(()=>[e(ke,{class:"py-4"},{default:t(()=>[l("div",Jn,[u[2]||(u[2]=l("span",null,"Invoice Number:",-1)),l("strong",null,A(b.value),1)]),l("div",Xn,[u[3]||(u[3]=l("span",null,"Total Amount:",-1)),l("strong",null,A(m(f.value/100)),1)])]),_:1})]),_:1})]}),_:1})]),_:1})]),_:1})]),_:1}),e(st,{class:"pa-4"},{default:t(()=>[e(Ne),e(Q,{color:"primary",size:"large","min-width":"120",height:"48",onClick:I,class:"text-none px-6",rounded:"pill",elevation:"2"},{default:t(()=>[e(le,{start:"",icon:"mdi-check",class:"mr-1"}),u[4]||(u[4]=S(" Done "))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},za=Te(Zn,[["__scopeId","data-v-1c09a6e9"]]);class ei{async getOrdersBySectionAndType(o,r,i="P"){var d;try{const b=await Ue.post("/v1/core-pos/listordersbysection",null,{params:{section_id:o,type:r,status:i}});if(!((d=b.data)!=null&&d.orders))throw new Error("Invalid response format");return b.data.orders.map(f=>({...f,type:f.type==="Invoice"?"Invoice":"holdInvoice",status:f.status||kt.PENDING}))}catch(b){throw s.error("Failed to fetch orders by section",{sectionId:o,type:r,status:i,error:b}),b}}async getOrderDetails(o,r){var i;try{const d=await Ue.post("/v1/core-pos/getsectionanditem",null,{params:{id:o,type:r}});if(!((i=d.data)!=null&&i.data))throw new Error("Invalid response format");return d.data.data}catch(d){throw s.error("Failed to fetch order details",{orderId:o,type:r,error:d}),d}}async getAllOrdersForSection(o){s.debug("Fetching pending orders for section",{sectionId:o});try{const[r,i]=await Promise.all([this.getOrdersBySectionAndType(o,"HOLD"),this.getOrdersBySectionAndType(o,"INVOICE")]),d=[...r.map(I=>this.getOrderDetails(I.id,"HOLD")),...i.map(I=>this.getOrderDetails(I.id,"INVOICE"))],b=await Promise.all(d);return[...r,...i].map((I,c)=>{const g=b[c].flatMap(_=>_.items.map(V=>({...V,section_type:_.section.name.toLowerCase()})));return{...I,items:g}})}catch(r){throw s.error("Failed to fetch all orders for section",{sectionId:o,error:r}),r}}async updateOrderStatus(o,r,i){try{return(await Ue.post("/v1/core-pos/updateorderstatus",{id:o,type:r,status:i})).data}catch(d){throw s.error("Failed to update order status",{orderId:o,type:r,status:i,error:d}),d}}}const ti=new ei,ha=Ca("sectionOrders",()=>{const a=D([]),o=D(!1),r=D(null),i=D(null),d=new Map,b=1e4,f=te(()=>u=>a.value.filter(g=>{var _;return(_=g.items)==null?void 0:_.some(V=>V.section_type===u)})),m=Fa(async u=>{await I(u)},1e3);async function I(u,g=!1){const _=`section_${u}`,V=Date.now(),y=d.get(_);if(!g&&y&&V-y.timestamp<b){a.value=y.data;return}if(!o.value){o.value=!0,r.value=null;try{const n=await ti.getAllOrdersForSection(u);a.value=n,i.value=new Date,d.set(_,{data:n,timestamp:V}),s.debug("Orders fetched and cached",{count:n.length,sectionId:u})}catch(n){r.value=n instanceof Error?n.message:"Failed to fetch orders",s.error("Failed to fetch section orders",{err:n})}finally{o.value=!1}}}function c(u){return I(u,!0)}return{orders:a,loading:o,error:r,lastUpdated:i,getOrdersBySection:f,fetchOrdersForSection:I,refreshOrders:c,debouncedFetch:m}}),Zt=[kt.DINE_IN,kt.TO_GO,kt.DELIVERY,kt.PICKUP],ai=Ca("kitchen",()=>{const a=D([]),o=D(!1),r=D(null),i=te(()=>a.value.filter(_=>!_.completed_at&&_.status!=="completed"&&_.status!=="cancelled")),d=te(()=>a.value.filter(_=>_.completed_at||_.status==="completed"||_.status==="cancelled")),b=async(_=[],V=[])=>{const y=ha();o.value=!0;try{await y.fetchSections();const n=async(T,h)=>{if(!Zt.includes(T.type))return null;const N=await Promise.all((T.items||[]).map(async M=>{const v=(await y.getSectionsForItem(M.id))[0];return{...M,section_id:v==null?void 0:v.id,section_type:v==null?void 0:v.type,section_name:v==null?void 0:v.name}}));return N.some(M=>M.section_type==="kitchen")?{...T,items:N,source:h,completed_at:T.completed_at||null,status:T.status||"pending",created_at:T.created_at||new Date().toISOString(),type:T.type||"UNKNOWN"}:null},C=await Promise.all([..._.map(T=>n(T,"hold_invoice")),...V.map(T=>n(T,"direct_invoice"))]);a.value=C.filter(T=>T!==null).sort((T,h)=>new Date(h.created_at)-new Date(T.created_at)),s.info(`Initialized ${a.value.length} kitchen orders`),c()}catch(n){r.value="Failed to initialize kitchen orders",s.error("Error initializing kitchen orders:",n)}finally{o.value=!1}},f=async _=>{if(!Zt.includes(_.type)){s.debug("Ignoring non-kitchen order:",_.type);return}const V=ha();try{const y=await Promise.all((_.items||[]).map(async n=>{const T=(await V.getSectionsForItem(n.id))[0];return{...n,section_id:T==null?void 0:T.id,section_type:T==null?void 0:T.type,section_name:T==null?void 0:T.name}}));y.some(n=>n.section_type==="kitchen")?(a.value.unshift({..._,items:y,completed_at:null,status:"pending",created_at:new Date().toISOString()}),s.info(`Added new ${_.type} order to kitchen`),c()):s.debug("Ignoring order with no kitchen items")}catch(y){r.value="Failed to add kitchen order",s.error("Error adding kitchen order:",y)}},m=async _=>{o.value=!0,r.value=null;try{const V=a.value.findIndex(y=>y.id===_);if(V===-1)throw new Error(`Order #${_} not found`);return a.value[V]={...a.value[V],status:"completed",completed_at:new Date().toISOString()},c(),s.info(`Order #${_} marked as completed`),!0}catch(V){return r.value=V.message,s.error("Error completing order:",V),!1}finally{o.value=!1}},I="kitchen_orders",c=()=>{try{localStorage.setItem(I,JSON.stringify(a.value)),s.debug("Kitchen orders persisted to localStorage")}catch(_){s.error("Failed to persist kitchen orders:",_)}};return(()=>{try{const _=localStorage.getItem(I);_&&(a.value=JSON.parse(_),s.info(`Loaded ${a.value.length} kitchen orders from localStorage`))}catch(_){s.error("Failed to load persisted kitchen orders:",_)}})(),{orders:a,loading:o,error:r,activeOrders:i,completedOrders:d,initializeOrders:b,addOrder:f,addDirectInvoice:_=>{if(!_||!Zt.includes(_.type)){s.debug("Ignoring invalid invoice:",_==null?void 0:_.type);return}const V={..._,source:"direct_invoice",completed_at:null,status:"pending",created_at:new Date().toISOString()};a.value.unshift(V),s.info(`Added new ${_.type} order to kitchen`),c()},completeOrder:m}});const oi={__name:"DeliveryModal",props:{disabled:{type:Boolean,default:!1}},setup(a){const{customerNotes:o}=xt(),r=te(()=>b.selectedStore),i=te(()=>b.selectedCashier);gt();const d=He(),b=rt(),f=ai(),{setOrderType:m,processOrder:I,ORDER_TYPES:c,error:u,setCustomerInfo:g}=xt(),{searchResults:_,isSearching:V,searchError:y,searchCustomers:n,createCustomer:C}=na(),T=D(!1),h=D(!1),N=D(!1),M=D(!1),X=D(!1),v=te(()=>u.value||y.value),p=te(()=>!d.isEmpty&&(w.name||"").trim()&&(w.phone||"").trim()&&(w.address||"").trim()&&(w.city||"").trim()&&(w.state||"").trim()&&(w.zipCode||"").trim()),R=D(""),me=D(null),x=D(!1),H=async G=>{var E;if(R.value=G,G&&G.length>=3)try{const Z=/^[\d\s\-()]+$/.test(G),ge=Z?G.replace(/[\s\-()]/g,""):G,Le=((E=(await Ue.get("/v1/customers",{params:{search:ge,status_customer:"A",orderByField:"created_at",orderBy:"desc",page:1}})).data.customers)==null?void 0:E.data)||[];_.value=Le.map($e=>{const Ee=$e.name||$e.customer_username||"Unknown",Ve=$e.phone?$e.phone.replace(/(\d{3})(\d{3})(\d{4})/,"($1) $2-$3"):"No phone",qe=$e.email?`  ${$e.email}`:"";return{...$e,title:Z?`${Ve} - ${Ee}`:Ee,subtitle:Z?qe:`${Ve}${qe}`,value:$e.id}}),s.debug("Customer search results:",{searchTerm:ge,isPhoneSearch:Z,results:_.value})}catch(Z){s.error("Customer search failed:",Z),_.value=[]}else _.value=[]},P=async G=>{var E,Z,ge,Re,Le,$e,Ee,Ve;if(G){s.debug("Customer selected:",G);try{const Ce=(await Ue.get(`/v1/customers/${G.id}`,{params:{include:"billing_address,addresses"}})).data.customer,he=Ce.billing_address||{};s.debug("Full customer data:",Ce),s.debug("Billing address:",he),w.name=((E=Ce==null?void 0:Ce.name)==null?void 0:E.trim())||((Z=Ce==null?void 0:Ce.first_name)==null?void 0:Z.trim())||"",w.phone=((ge=Ce==null?void 0:Ce.phone)==null?void 0:ge.trim())||"",w.email=((Re=Ce==null?void 0:Ce.email)==null?void 0:Re.trim())||"",w.address=((Le=he==null?void 0:he.address_street_1)==null?void 0:Le.trim())||"",w.unit=(($e=he==null?void 0:he.address_street_2)==null?void 0:$e.trim())||"",w.city=((Ee=he==null?void 0:he.city)==null?void 0:Ee.trim())||"",w.zipCode=((Ve=he==null?void 0:he.zip)==null?void 0:Ve.trim())||"",he.state?(w.state=he.state.code||"",w.state_id=he.state.id||null):(w.state="",w.state_id=null),w.instructions=G.notes||"",R.value=G.name,s.debug("Customer selected:",G),s.debug("Billing address:",he),s.info("Customer data populated:",{customer:G.id,fields:{...w}}),U()}catch(qe){s.error("Error fetching customer details:",qe),window.toastr&&window.toastr.error("Failed to load customer details")}}},K=()=>{me.value=null,R.value="",Object.keys(w).forEach(G=>{w[G]=""})},j=async G=>{try{s.info("New customer created:",G),x.value=!1,me.value=G,R.value=G.name,w.name=G.name,w.phone=G.phone||"",w.email=G.email||"",w.address=G.address_street_1||"",w.unit=G.address_street_2||"",w.city=G.city||"",w.state=G.state||"",w.zipCode=G.zip||"",w.instructions=G.notes||"",U(),window.toastr&&window.toastr.success("Customer created and loaded successfully")}catch(E){s.error("Error handling new customer:",E),window.toastr&&window.toastr.error("Error loading customer data")}},w=ht({name:"",phone:"",email:"",address:"",unit:"",city:"",state:"",zipCode:"",notes:""}),ne=G=>{w.state_id=G.id,w.state=G.code},ce=ht({name:"",phone:"",address:"",zip:"",city:"",state:""});we(T,G=>{G?m(c.DELIVERY):(Object.keys(w).forEach(E=>{w[E]=""}),U())}),we(T,G=>{if(G){if(!r.value||!i.value){v.value="Please select both store and cashier first",T.value=!1;return}try{const E=yt(d.notes);E&&(w.notes=E,s.debug("Initialized notes from cart store:",{notes:E}))}catch(E){s.error("Failed to parse cart notes:",E)}}}),we(()=>d.notes,G=>{try{const E=yt(G);E&&E!==w.notes&&(w.notes=E,s.debug("Updated notes from cart store:",{notes:E}))}catch(E){s.error("Failed to parse cart notes:",E)}}),we(()=>o.value,G=>{G!==w.notes&&(w.notes=G,s.debug("Updated notes from customer notes:",{newNotes:G}))});const oe=()=>{var E;let G=!0;return U(),(E=me.value)!=null&&E.id||(ce.name="Please select a customer from the search results",G=!1),w.phone.trim()||(ce.phone="Phone number is required",G=!1),w.address.trim()||(ce.address="Delivery address is required",G=!1),G},ue=G=>{ce[G]=""},U=()=>{Object.keys(ce).forEach(G=>{ce[G]=""})},L=D({invoice:null,invoicePrefix:"",nextInvoiceNumber:""}),_e=async()=>{var G,E,Z,ge,Re,Le,$e,Ee;if(oe()){N.value=!0;try{const Ve=[w.address.trim(),w.unit.trim(),w.zipCode.trim()].filter(Boolean).join(", "),qe={customer_id:((G=me.value)==null?void 0:G.id)||null,name:(w.name||"").trim(),phone:(w.phone||"").trim(),address:(w.address||"").trim(),unit:(w.unit||"").trim(),zip:(w.zipCode||"").trim(),city:(w.city||"").trim(),state:(w.state||"").trim(),state_id:w.state_id,email:(w.email||"").trim(),instructions:(w.instructions||"").trim(),send_sms:M.value?1:0};g(qe);const Ce=new Date,he=new Date(Ce);he.setDate(he.getDate()+7);const Ze={invoice_date:Ce.toISOString().split("T")[0],due_date:he.toISOString().split("T")[0],invoice_number:`DEL-${Date.now()}`,sub_total:d.subtotal,total:d.total,tax:d.taxAmount,items:d.items.map(ie=>({item_id:ie.id,name:ie.name,description:ie.description||"",price:se.normalizePrice(ie.price),quantity:ie.quantity,unit_name:ie.unit_name||"units",total:se.normalizePrice(ie.total),sub_total:se.normalizePrice(ie.sub_total),tax:se.normalizePrice(ie.tax||0)})),avalara_bool:!1,banType:!0,package_bool:!1,print_pdf:!1,save_as_draft:!1,send_email:!1,not_charge_automatically:!1,is_hold_invoice:!0,is_invoice_pos:1,is_pdf_pos:!0,invoice_template_id:1,invoice_pbx_modify:0,store_id:(E=b.selectedStore)==null?void 0:E.id,cash_register_id:(Z=b.selectedCashier)==null?void 0:Z.id,user_id:((ge=me.value)==null?void 0:ge.id)||null,type:c.DELIVERY,status:"HELD",description:"Delivery Order",contact:{name:((Re=me.value)==null?void 0:Re.name)||w.name.trim(),last_name:"N/A",email:((Le=me.value)==null?void 0:Le.email)||w.email.trim(),phone:(($e=me.value)==null?void 0:$e.phone)||w.phone.trim(),second_phone:"N/A",identification:"N/A"},tables_selected:[],packages:[],taxes:[],discount:"0",discount_type:"fixed",discount_val:Math.round(0),discount_per_item:"NO",send_sms:M.value?1:0,notes:JSON.stringify({customerNotes:w.notes,timestamp:new Date().toISOString(),orderType:Ae.DELIVERY,orderInfo:{customer:{name:w.name.trim(),phone:w.phone.replace(/\D/g,""),email:w.email.trim(),address:w.address,unit:w.unit,city:w.city,state:w.state,zipCode:w.zipCode,notes:w.notes,instructions:w.notes}}}),hold_invoice_id:null,tip:"0",tip_type:"fixed",tip_val:0};s.debug("Creating hold order with data:",{...Ze,debugPrices:{subtotal:{raw:d.subtotal,cents:se.toCents(d.subtotal)},total:{raw:d.total,cents:se.toCents(d.total)},tax:{raw:d.taxAmount,cents:se.toCents(d.taxAmount)}}});const Y=await tt.invoice.getNextNumber();if(!Y)throw new Error("Failed to get next invoice number");Ze.invoice_number=`${Y.prefix}-${Y.nextNumber}`;const q=await tt.invoice.create(Ze);if(!(q!=null&&q.invoice)){const ie="No invoice data received";throw s.error("Failed to create invoice:",{result:q,orderData:Ze}),new Error(ie)}f.addDirectInvoice(q.invoice),s.debug("Invoice created successfully:",q.invoice);const be={success:!0,invoice:q.invoice};if(!be.success)throw new Error("Failed to prepare invoice data");s.debug("Converted invoice data:",be),L.value={invoice:be.invoice,invoicePrefix:Y.prefix,nextInvoiceNumber:Y.nextNumber},X.value=!0}catch(Ve){s.error("Failed to prepare delivery order:",{error:Ve,message:Ve.message,data:{customerInfo:w}}),(Ee=window.toastr)==null||Ee.error(Ve.message||"Failed to prepare delivery order")}finally{N.value=!1}}},ye=async G=>{var E;G&&(T.value=!1,(E=window.toastr)==null||E.success("Delivery order created successfully"))},De=()=>{N.value||(T.value=!1)};return(G,E)=>($(),re(ze,{modelValue:T.value,"onUpdate:modelValue":E[18]||(E[18]=Z=>T.value=Z),fullscreen:"",transition:"dialog-bottom-transition",scrim:!1},{activator:t(({props:Z})=>[e(Q,pt({color:"primary"},Z,{"prepend-icon":"mdi-truck-delivery",loading:h.value,disabled:a.disabled||F(d).isEmpty,class:"text-none px-6",rounded:"pill",elevation:G.$vuetify.display.mobile?1:2,size:"large",block:G.$vuetify.display.mobile}),{default:t(()=>E[19]||(E[19]=[l("span",{class:"text-subtitle-1 font-weight-medium"},"DELIVERY",-1)])),_:2},1040,["loading","disabled","elevation","block"])]),default:t(()=>[e(za,{modelValue:X.value,"onUpdate:modelValue":E[0]||(E[0]=Z=>X.value=Z),invoice:L.value,onPaymentComplete:ye},null,8,["modelValue","invoice"]),e(Pe,{class:"modal-card"},{default:t(()=>[e(Je,{color:"primary",density:"comfortable"},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>[e(le,{icon:"mdi-truck-delivery",size:"large",class:"mr-2"}),E[20]||(E[20]=S(" Delivery Order "))]),_:1}),e(Ne),e(Q,{icon:"",onClick:De},{default:t(()=>[e(le,null,{default:t(()=>E[21]||(E[21]=[S("mdi-close")])),_:1})]),_:1})]),_:1}),e(ke,{class:"pa-0 fill-height d-flex flex-column"},{default:t(()=>[e(ot,{fluid:"",class:"flex-grow-1 pa-4"},{default:t(()=>[h.value?($(),re(de,{key:0},{default:t(()=>[e(ae,{cols:"12",class:"text-center"},{default:t(()=>[e(lt,{indeterminate:"",size:"64"})]),_:1})]),_:1})):v.value?($(),re(de,{key:1},{default:t(()=>[e(ae,{cols:"12",class:"text-center"},{default:t(()=>[e(at,{type:"error",variant:"tonal"},{default:t(()=>[S(A(v.value),1)]),_:1})]),_:1})]),_:1})):($(),ee(xe,{key:2},[e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[E[25]||(E[25]=l("div",{class:"text-subtitle-1 mb-2"},"Customer Information",-1)),e(sa,{modelValue:me.value,"onUpdate:modelValue":[E[2]||(E[2]=Z=>me.value=Z),P],search:R.value,"onUpdate:search":[E[3]||(E[3]=Z=>R.value=Z),H],items:F(_),loading:F(V),"error-messages":ce.name,label:"Search Customer","item-title":"title","item-value":"value",variant:"outlined",density:"comfortable","persistent-hint":"",hint:"Search by name, phone, or email (min. 3 characters)","return-object":""},{"append-inner":t(()=>[me.value?($(),re(le,{key:0,color:"error",onClick:Ct(K,["stop"])},{default:t(()=>E[22]||(E[22]=[S(" mdi-close ")])),_:1})):ve("",!0)]),"no-data":t(()=>[e(St,null,{append:t(()=>[e(Q,{color:"primary",variant:"text",onClick:E[1]||(E[1]=Z=>x.value=!0)},{default:t(()=>E[24]||(E[24]=[S(" Create New ")])),_:1})]),default:t(()=>[e(Nt,null,{default:t(()=>E[23]||(E[23]=[S(" No customers found ")])),_:1})]),_:1})]),item:t(({props:Z,item:ge})=>[e(St,ro(lo(Z)),{default:t(()=>[e(Nt,null,{default:t(()=>[S(A(ge.raw.name),1)]),_:2},1024),e(da,null,{default:t(()=>[S(A(ge.raw.phone||"No phone")+" "+A(ge.raw.email?` ${ge.raw.email}`:""),1)]),_:2},1024),ge.raw.address_street_1?($(),re(da,{key:0},{default:t(()=>[S(A(ge.raw.address_street_1)+" "+A(ge.raw.address_street_2?`, ${ge.raw.address_street_2}`:"")+" "+A(ge.raw.city?`, ${ge.raw.city}`:"")+" "+A(ge.raw.state?` ${ge.raw.state}`:"")+" "+A(ge.raw.zip_code?` ${ge.raw.zip_code}`:""),1)]),_:2},1024)):ve("",!0)]),_:2},1040)]),_:1},8,["modelValue","search","items","loading","error-messages"]),e(Ua,{modelValue:x.value,"onUpdate:modelValue":E[4]||(E[4]=Z=>x.value=Z),onCustomerCreated:j},null,8,["modelValue"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Se,{modelValue:w.phone,"onUpdate:modelValue":E[5]||(E[5]=Z=>w.phone=Z),label:"Phone Number",variant:"outlined",density:"comfortable","error-messages":ce.phone,onInput:E[6]||(E[6]=Z=>ue("phone")),required:""},null,8,["modelValue","error-messages"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[E[26]||(E[26]=l("div",{class:"text-subtitle-1 mb-2"},"Delivery Address",-1)),e(Se,{modelValue:w.address,"onUpdate:modelValue":E[7]||(E[7]=Z=>w.address=Z),label:"Street Address",variant:"outlined",density:"comfortable","error-messages":ce.address,onInput:E[8]||(E[8]=Z=>ue("address")),required:""},null,8,["modelValue","error-messages"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12",sm:"6"},{default:t(()=>[e(Se,{modelValue:w.unit,"onUpdate:modelValue":E[9]||(E[9]=Z=>w.unit=Z),label:"Apt/Suite/Unit (Optional)",variant:"outlined",density:"comfortable"},null,8,["modelValue"])]),_:1}),e(ae,{cols:"12",sm:"6"},{default:t(()=>[e(Se,{modelValue:w.zipCode,"onUpdate:modelValue":E[10]||(E[10]=Z=>w.zipCode=Z),label:"ZIP Code",variant:"outlined",density:"comfortable","error-messages":ce.zipCode,onInput:E[11]||(E[11]=Z=>ue("zipCode")),required:""},null,8,["modelValue","error-messages"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12",sm:"6"},{default:t(()=>[e(Se,{modelValue:w.city,"onUpdate:modelValue":E[12]||(E[12]=Z=>w.city=Z),label:"City",variant:"outlined",density:"comfortable","error-messages":ce.city,onInput:E[13]||(E[13]=Z=>ue("city")),required:""},null,8,["modelValue","error-messages"])]),_:1}),e(ae,{cols:"12",sm:"6"},{default:t(()=>[e($a,{modelValue:w.state,"onUpdate:modelValue":[E[14]||(E[14]=Z=>w.state=Z),E[15]||(E[15]=Z=>ue("state"))],error:ce.state,onStateSelected:ne},null,8,["modelValue","error"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(oa,{modelValue:w.instructions,"onUpdate:modelValue":E[16]||(E[16]=Z=>w.instructions=Z),label:"Delivery Instructions (Optional)",variant:"outlined",density:"comfortable",rows:"2",hint:"Special instructions for delivery driver"},null,8,["modelValue"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Oa,{modelValue:M.value,"onUpdate:modelValue":E[17]||(E[17]=Z=>M.value=Z),color:"primary",label:"Send invoice via SMS",hint:"Customer will receive an SMS with the invoice link","persistent-hint":""},null,8,["modelValue"])]),_:1})]),_:1}),e(de,{class:"mt-4"},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Q,{color:"primary",size:"large",block:"",height:"56",onClick:_e,loading:N.value,disabled:!p.value||N.value,elevation:"2"},{default:t(()=>[e(le,{start:""},{default:t(()=>E[27]||(E[27]=[S("mdi-check-circle")])),_:1}),E[28]||(E[28]=S(" Process Order "))]),_:1},8,["loading","disabled"])]),_:1})]),_:1})],64))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},si=Te(oi,[["__scopeId","data-v-c442c7d0"]]);const ri={__name:"PickupModal",props:{disabled:{type:Boolean,default:!1}},setup(a){const o=He(),r=rt(),{setOrderType:i,setCustomerInfo:d,customerNotes:b}=xt(),f=te(()=>r.selectedStore),m=te(()=>r.selectedCashier),I=D(!1),c=D(!1),u=D(!1),g=D(!1),_=D(!1),V=te(()=>N.value),y=D(""),n=D(null),C=D(!1),{searchResults:T,isSearching:h,searchError:N,searchCustomers:M,createCustomer:X}=na(),v=async U=>{if(!U||U.length<3){T.value=[];return}try{h.value=!0,await M(U)}catch(L){s.error("Error searching customers:",L)}},p=async U=>{var L,_e,ye,De;if(!U){R();return}try{const G=U.value;if(G){n.value=G,x.name=G.name||"",x.phone=G.phone||"",x.email=G.email||"",y.value=G.name;const Z=(await tt.get(`/v1/customers/${G.id}`,{params:{include:"billing_address"}})).data.customer;s.debug("Full customer data:",Z),x.name=((L=Z==null?void 0:Z.name)==null?void 0:L.trim())||((_e=Z==null?void 0:Z.first_name)==null?void 0:_e.trim())||G.name||"",x.phone=((ye=Z==null?void 0:Z.phone)==null?void 0:ye.trim())||G.phone||"",x.email=((De=Z==null?void 0:Z.email)==null?void 0:De.trim())||G.email||"",n.value=Z,s.debug("Customer selected:",Z),s.info("Customer data populated:",{customer:G.id,fields:{...x}}),w()}}catch(G){s.error("Error selecting customer:",G),window.toastr&&window.toastr.error("Failed to load customer details")}},R=()=>{n.value=null,x.name="",x.phone="",x.email="",x.pickupTime=""},me=U=>{s.debug("[PickupModal] New customer created:",U),n.value={id:U.id,title:U.name,phone:U.phone,email:U.email},C.value=!1,x.name=U.name,x.phone=U.phone,x.email=U.email};we(I,U=>{if(U&&o.notes)try{const L=JSON.parse(o.notes);b.value=L.customerNotes||""}catch{b.value=o.notes}}),we(()=>o.notes,U=>{if(U)try{const L=JSON.parse(U);L.customerNotes!==b.value&&(b.value=L.customerNotes||"")}catch{U!==b.value&&(b.value=U)}else b.value=""},{immediate:!0}),we(b,U=>{if(U)try{const L={customerNotes:U,orderInfo:{customer:x},timestamp:new Date().toISOString()};o.notes=JSON.stringify(L)}catch(L){s.error("Error syncing notes with cart:",L)}else o.notes=""},{immediate:!0});const x=ht({name:"",phone:"",email:"",pickupTime:""}),H=ht({name:"",phone:"",pickupTime:""}),P=te(()=>!o.isEmpty&&(x.name||"").trim()&&(x.phone||"").trim()&&(x.pickupTime||"").trim());we(I,U=>{U?i(Ge.PICKUP):(Object.keys(x).forEach(L=>{x[L]=""}),w())});const K=()=>{var L;let U=!0;return w(),(L=n.value)!=null&&L.id||(H.name="Please select a customer from the search results",U=!1),x.phone.trim()||(H.phone="Phone number is required",U=!1),x.pickupTime.trim()||(H.pickupTime="Pickup time is required",U=!1),U},j=U=>{H[U]=""},w=()=>{Object.keys(H).forEach(U=>{H[U]=""})},ne=D({invoice:null,invoicePrefix:"",nextInvoiceNumber:""}),ce=async()=>{var U,L,_e,ye,De,G,E,Z,ge;if(K()){u.value=!0;try{const Re={customer_id:((U=n.value)==null?void 0:U.id)||null,name:(x.name||"").trim(),phone:(x.phone||"").trim(),email:(x.email||"").trim(),send_sms:g.value?1:0};d(Re);const Le=new Date,$e=new Date(Le);$e.setDate($e.getDate()+7);const Ee=await tt.invoice.getNextNumber();if(!Ee)throw new Error("Failed to get next invoice number");const Ve=b.value?JSON.stringify({customerNotes:b.value,orderInfo:{customer:x,store:((L=f.value)==null?void 0:L.name)||"",cashier:((_e=m.value)==null?void 0:_e.name)||"",orderType:"pickup"},timestamp:new Date().toISOString()}):"",qe={invoice_date:Le.toISOString().split("T")[0],due_date:$e.toISOString().split("T")[0],invoice_number:`${Ee.prefix}-${Ee.nextNumber}`,sub_total:o.subtotal,total:o.total,tax:o.taxAmount,items:o.items.map(he=>({item_id:he.id,name:he.name,description:he.description||"",price:se.normalizePrice(he.price),quantity:he.quantity,unit_name:he.unit_name||"units",total:se.normalizePrice(he.total),sub_total:se.normalizePrice(he.sub_total),tax:se.normalizePrice(he.tax||0)})),avalara_bool:!1,banType:!0,package_bool:!1,print_pdf:!1,save_as_draft:!1,send_email:!1,not_charge_automatically:!1,is_hold_invoice:!0,is_invoice_pos:1,is_pdf_pos:!0,invoice_template_id:1,invoice_pbx_modify:0,store_id:(ye=r.selectedStore)==null?void 0:ye.id,cash_register_id:(De=r.selectedCashier)==null?void 0:De.id,user_id:((G=n.value)==null?void 0:G.id)||null,type:Ge.PICKUP,status:"HELD",description:`Pick Up Order - ${x.pickupTime}`,contact:{name:((E=n.value)==null?void 0:E.name)||x.name.trim(),last_name:"N/A",email:((Z=n.value)==null?void 0:Z.email)||x.email.trim(),phone:((ge=n.value)==null?void 0:ge.phone)||x.phone.trim(),second_phone:"N/A",identification:"N/A"},tables_selected:[],packages:[],taxes:[],discount:"0",discount_type:"fixed",discount_val:Math.round(0),discount_per_item:"NO",send_sms:g.value?1:0,notes:Ve,hold_invoice_id:null,tip:"0",tip_type:"fixed",tip_val:0};s.debug("Creating pickup order with data:",qe);const Ce=await tt.invoice.create(qe);if(!(Ce!=null&&Ce.invoice))throw new Error("No invoice data received");kitchenStore.addDirectInvoice(Ce.invoice),s.debug("Invoice created successfully:",Ce),ne.value={invoice:{...Ce.invoice,type:Ge.PICKUP},invoicePrefix:Ee.prefix,nextInvoiceNumber:Ee.nextNumber},_.value=!0}catch(Re){s.error("Failed to prepare pickup order:",{error:Re,message:Re.message,data:{customerInfo:x}}),window.toastr&&window.toastr.error("Failed to create pickup order. Please try again.")}finally{u.value=!1}}},oe=async U=>{var L;U&&(I.value=!1,(L=window.toastr)==null||L.success("Pick up order created successfully"))},ue=()=>{u.value||(I.value=!1)};return(U,L)=>($(),re(ze,{modelValue:I.value,"onUpdate:modelValue":L[11]||(L[11]=_e=>I.value=_e),fullscreen:"",transition:"dialog-bottom-transition",scrim:!1},{activator:t(({props:_e})=>[e(Q,pt({color:"primary"},_e,{"prepend-icon":"mdi-store-clock",loading:c.value,disabled:a.disabled||F(o).isEmpty,class:"text-none px-6",rounded:"pill",elevation:U.$vuetify.display.mobile?1:2,size:"large",block:U.$vuetify.display.mobile}),{default:t(()=>L[12]||(L[12]=[l("span",{class:"text-subtitle-1 font-weight-medium"},"PICK UP",-1)])),_:2},1040,["loading","disabled","elevation","block"])]),default:t(()=>[e(za,{modelValue:_.value,"onUpdate:modelValue":L[0]||(L[0]=_e=>_.value=_e),invoice:ne.value,onPaymentComplete:oe},null,8,["modelValue","invoice"]),e(Pe,{class:"modal-card"},{default:t(()=>[e(Je,{color:"primary",density:"comfortable"},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>[e(le,{icon:"mdi-store-clock",size:"large",class:"mr-2"}),L[13]||(L[13]=S(" Pick Up Order "))]),_:1}),e(Ne),e(Q,{icon:"",onClick:ue},{default:t(()=>[e(le,null,{default:t(()=>L[14]||(L[14]=[S("mdi-close")])),_:1})]),_:1})]),_:1}),e(ke,{class:"pa-0 fill-height d-flex flex-column"},{default:t(()=>[e(ot,{fluid:"",class:"flex-grow-1 pa-4"},{default:t(()=>[c.value?($(),re(de,{key:0},{default:t(()=>[e(ae,{cols:"12",class:"text-center"},{default:t(()=>[e(lt,{indeterminate:"",size:"64"})]),_:1})]),_:1})):V.value?($(),re(de,{key:1},{default:t(()=>[e(ae,{cols:"12",class:"text-center"},{default:t(()=>[e(at,{type:"error",variant:"tonal"},{default:t(()=>[S(A(V.value),1)]),_:1})]),_:1})]),_:1})):($(),ee(xe,{key:2},[e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[L[18]||(L[18]=l("div",{class:"text-subtitle-1 mb-2"},"Customer Information",-1)),e(sa,{modelValue:n.value,"onUpdate:modelValue":[L[2]||(L[2]=_e=>n.value=_e),p],search:y.value,"onUpdate:search":[L[3]||(L[3]=_e=>y.value=_e),v],items:F(T),loading:F(h),"error-messages":H.name,label:"Search Customer","item-title":"title","item-subtitle":"subtitle","item-value":"value",variant:"outlined",density:"comfortable","persistent-hint":"",hint:"Search by name, phone, or email (min. 3 characters)","return-object":""},{"append-inner":t(()=>[n.value?($(),re(le,{key:0,color:"error",onClick:Ct(R,["stop"])},{default:t(()=>L[15]||(L[15]=[S(" mdi-close ")])),_:1})):ve("",!0)]),"no-data":t(()=>[e(St,null,{append:t(()=>[e(Q,{color:"primary",variant:"text",onClick:L[1]||(L[1]=_e=>C.value=!0)},{default:t(()=>L[17]||(L[17]=[S(" Create New ")])),_:1})]),default:t(()=>[e(Nt,null,{default:t(()=>L[16]||(L[16]=[S(" No customers found ")])),_:1})]),_:1})]),_:1},8,["modelValue","search","items","loading","error-messages"]),e(Ua,{modelValue:C.value,"onUpdate:modelValue":L[4]||(L[4]=_e=>C.value=_e),onCustomerCreated:me},null,8,["modelValue"]),e(oa,{modelValue:F(b),"onUpdate:modelValue":L[5]||(L[5]=_e=>Et(b)?b.value=_e:null),label:"Order Notes",variant:"outlined",density:"comfortable",rows:"3",class:"mt-4","hide-details":"",placeholder:"Add any special instructions or notes for this order"},null,8,["modelValue"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Se,{modelValue:x.phone,"onUpdate:modelValue":L[6]||(L[6]=_e=>x.phone=_e),label:"Phone Number",variant:"outlined",density:"comfortable","error-messages":H.phone,onInput:L[7]||(L[7]=_e=>j("phone")),required:""},null,8,["modelValue","error-messages"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[L[19]||(L[19]=l("div",{class:"text-subtitle-1 mb-2"},"Pickup Time",-1)),e(Se,{modelValue:x.pickupTime,"onUpdate:modelValue":L[8]||(L[8]=_e=>x.pickupTime=_e),label:"Pickup Time",type:"time",variant:"outlined",density:"comfortable","error-messages":H.pickupTime,onInput:L[9]||(L[9]=_e=>j("pickupTime")),required:""},null,8,["modelValue","error-messages"])]),_:1})]),_:1}),e(de,null,{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Oa,{modelValue:g.value,"onUpdate:modelValue":L[10]||(L[10]=_e=>g.value=_e),color:"primary",label:"Send invoice via SMS",hint:"Customer will receive an SMS with the invoice link","persistent-hint":""},null,8,["modelValue"])]),_:1})]),_:1}),e(de,{class:"mt-4"},{default:t(()=>[e(ae,{cols:"12"},{default:t(()=>[e(Q,{color:"primary",size:"large",block:"",height:"56",onClick:ce,loading:u.value,disabled:!P.value||u.value,elevation:"2"},{default:t(()=>[e(le,{start:""},{default:t(()=>L[20]||(L[20]=[S("mdi-check-circle")])),_:1}),L[21]||(L[21]=S(" Process Order "))]),_:1},8,["loading","disabled"])]),_:1})]),_:1})],64))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},li=Te(ri,[["__scopeId","data-v-b19d5572"]]);const ni={class:"payment-content"},ii={key:1,class:"processing-state"},di={key:3},ui={__name:"RetailPaymentDialog",props:{modelValue:Boolean},emits:["update:modelValue","payment-complete"],setup(a,{emit:o}){const r=x=>{const H=new Date(x),P=H.getFullYear(),K=String(H.getMonth()+1).padStart(2,"0"),j=String(H.getDate()).padStart(2,"0");return`${P}-${K}-${j}`},i=a,d=o,b=He(),f=rt(),m=Qa();wt(async()=>{console.log("Component mounted, initializing company store...");try{await f.initializeStore(),console.log("Company data after initialization:",{selectedCustomer:f.selectedCustomer,currentStore:f.currentStore,isConfigured:f.isConfigured})}catch(x){console.error("Failed to initialize company store:",x)}});const{items:I}=Pt(b),{user:c}=Pt(m);console.log("Auth Store User:",c.value);const u=D(!1),g=D(null),_=D(null),V=D(!1),y=te({get:()=>i.modelValue,set:x=>d("update:modelValue",x)}),n=te(()=>I.value.length>0),C=te(()=>n.value&&!u.value),T=D(!1),h=D("");te(()=>{var x,H,P,K;return((H=(x=_.value)==null?void 0:x.invoice)==null?void 0:H.invoice_number)||`${(P=_.value)==null?void 0:P.invoicePrefix}-${(K=_.value)==null?void 0:K.nextInvoiceNumber}`||""}),te(()=>{var x;return((x=_.value)==null?void 0:x.total)||0});const N=()=>{T.value=!1,h.value=""},M=te(()=>{var x,H;return((x=c.value)==null?void 0:x.id)||((H=f.currentStore)==null?void 0:H.default_user_id)||1}),X=x=>x.map(H=>({item_id:Number(H.id),name:H.name,description:H.description||"",price:H.price,quantity:H.quantity,unit_name:H.unit_name||"units",sub_total:H.price*H.quantity,total:H.price*H.quantity,discount:"0",discount_val:0,discount_type:"fixed",tax:Math.round(Number(H.tax||0)),retention_amount:0,retention_concept:null,retention_percentage:null,retentions_id:null})),v=async()=>{var x,H,P;s.startGroup("Creating Retail Invoice");try{f.isConfigured||await f.initializeStore();const K=await tt.invoice.getNextNumber();s.debug("Next invoice number response:",K);const j=new Date,w=r(j),ne=X(b.items),ce=f.currentStore;if(!ce)throw new Error("No store selected");const oe={invoice_number:`${K.prefix}-${K.nextNumber}`,invoice_date:w,due_date:r(new Date(j.getTime()+7*24*60*60*1e3)),total:se.toCents(b.total),sub_total:se.toCents(b.subtotal),tax:se.toCents(b.taxAmount),items:ne,hold_items:ne,taxes:[],packages:[],tables_selected:[],contact:{name:ce.company_name||"Walk-in Customer",company_name:ce.company_name||"Walk-in Customer",first_name:ce.company_name||"Walk-in",last_name:"Customer",email:ce.email||"walk-in@example.com",phone:ce.phone||"000-000-0000",second_phone:"N/A",identification:ce.tax_id||"N/A",type:"company"},type:Ae.TO_GO,status:"SENT",paid_status:mt.UNPAID,description:"Retail Point of Sale Transaction",user_id:M.value,company_id:(x=f.company)==null?void 0:x.id,invoice_template_id:1,is_invoice_pos:1,is_pdf_pos:!0,is_hold_invoice:!1,avalara_bool:!1,banType:!0,package_bool:!1,print_pdf:!1,save_as_draft:!1,send_email:!1,not_charge_automatically:!1,invoice_pbx_modify:0,send_sms:0,discount:"0",discount_type:"fixed",discount_val:0,discount_per_item:"NO",tip:"0",tip_type:"fixed",tip_val:0,notes:"",hold_invoice_id:null,store_id:ce.id||0,cash_register_id:((H=f.selectedCashier)==null?void 0:H.id)||0},ue=await tt.invoice.create(oe);return _.value={invoice:{...oe,id:((P=ue==null?void 0:ue.data)==null?void 0:P.id)||`${K.prefix}-${K.nextNumber}`,type:Ae.TO_GO,hold_items:ne,total:b.total,sub_total:b.subtotal,tax:b.taxAmount,is_prepared_data:!0}},V.value=!0,y.value=!1,s.endGroup(),_.value.invoice}catch(K){throw s.error("Invoice Creation Failed:",K),s.endGroup(),K}},p=async()=>{if(!C.value){me();return}u.value=!0,g.value=null;try{if(!await v())throw new Error("Failed to create invoice")}catch(x){g.value=x.message||"Failed to process payment",s.error("Payment processing error:",x),me()}finally{u.value=!1}},R=async x=>{var H,P;if(s.info("Payment completion handler called with result:",x),x)try{const K=((H=x==null?void 0:x.invoice)==null?void 0:H.invoice)||(x==null?void 0:x.invoice);if(!(K!=null&&K.unique_hash))throw console.error(" [Invoice PDF] Missing invoice hash:",K),new Error("Could not generate invoice PDF: Missing invoice hash");const j=K.invoicePdfUrl||`${"https://lajuanita.corebill.co/api/v1".replace("/api/v1","")}/invoices/pdf/${K.unique_hash}`;console.log(" [Invoice PDF] Opening PDF viewer with URL:",j),h.value=j,T.value=!0,me(),d("payment-complete",x)}catch(K){console.error(" [Invoice PDF] Failed to display invoice:",K),(P=window.toastr)==null||P.error(K.message||"Failed to display invoice PDF")}},me=()=>{u.value||(g.value=null,_.value=null,V.value=!1,d("update:modelValue",!1))};return(x,H)=>($(),ee("div",null,[e(ze,{modelValue:y.value,"onUpdate:modelValue":H[1]||(H[1]=P=>y.value=P),fullscreen:"",transition:"dialog-bottom-transition",scrim:!1,class:"payment-dialog"},{default:t(()=>[e(Pe,{class:"modal-card"},{default:t(()=>[e(Je,{color:"primary",elevation:1},{default:t(()=>[e(Xe,{class:"text-h6 font-weight-medium"},{default:t(()=>[e(le,{icon:"mdi-cash-register",size:"large",class:"mr-2"}),H[4]||(H[4]=S(" Process Payment "))]),_:1}),e(Ne),e(Q,{icon:"",onClick:me},{default:t(()=>[e(le,null,{default:t(()=>H[5]||(H[5]=[S("mdi-close")])),_:1})]),_:1})]),_:1}),l("div",ni,[g.value?($(),re(at,{key:0,type:"error",variant:"tonal",closable:"",class:"error-alert","onClick:close":H[0]||(H[0]=P=>g.value=null)},{default:t(()=>[S(A(g.value),1)]),_:1})):ve("",!0),u.value?($(),ee("div",ii,[e(lt,{indeterminate:"",color:"primary",size:"64"}),H[6]||(H[6]=l("div",{class:"text-h6 mt-4"},"Processing Payment...",-1))])):n.value?($(),ee("div",di,A(p()),1)):($(),re(at,{key:2,type:"warning",variant:"tonal",class:"mb-4"},{default:t(()=>H[7]||(H[7]=[S(" Please add items to cart before proceeding with payment. ")])),_:1}))])]),_:1})]),_:1},8,["modelValue"]),e(la,{modelValue:V.value,"onUpdate:modelValue":H[2]||(H[2]=P=>V.value=P),invoice:_.value,onPaymentComplete:R},null,8,["modelValue","invoice"]),e(jt,{modelValue:T.value,"onUpdate:modelValue":H[3]||(H[3]=P=>T.value=P),pdfUrl:h.value,onClosed:N},null,8,["modelValue","pdfUrl"])]))}},ci=Te(ui,[["__scopeId","data-v-b43044ef"]]);const mi={class:"footer-content"},pi={class:"order-types"},fi={class:"order-actions"},vi={__name:"PosFooter",emits:["print-order","submit-order"],setup(a){const o=He(),r=rt();gt();const{isProcessingPayment:i}=qt(),d=D(!1);D(null);const b=D(!1),{items:f,holdInvoiceId:m}=Pt(o),{isConfigured:I}=Pt(r),c=te(()=>f.value.length===0),u=te(()=>c.value||!I.value),g=te(()=>{const V=!c.value&&I.value;return s.debug("Can pay computed:",{isEmpty:c.value,isConfigured:I.value,canPay:V}),V}),_=async V=>{var y;s.info("Payment completion handler called with result:",V),V&&(await o.$reset(),(y=window.toastr)==null||y.success("Payment processed successfully")),d.value=!1};return wt(()=>{s.debug("PosFooter mounted:",{isEmpty:c.value,isConfigured:I.value,holdInvoiceId:m.value,canPay:g.value,items:f.value.length})}),(V,y)=>($(),re(Wa,{app:"",class:"pos-footer"},{default:t(()=>[l("div",mi,[l("div",pi,[e(Al,{modelValue:b.value,"onUpdate:modelValue":y[0]||(y[0]=n=>b.value=n),disabled:!1},null,8,["modelValue"]),e(Gl,{disabled:u.value},null,8,["disabled"]),e(Bl,{disabled:u.value},null,8,["disabled"]),e(si,{disabled:u.value},null,8,["disabled"]),e(li,{disabled:u.value},null,8,["disabled"])]),l("div",fi,[e(Q,{color:"success","prepend-icon":"mdi-cash-register",onClick:y[1]||(y[1]=n=>d.value=!0),disabled:!g.value,loading:F(i),class:"text-none action-btn",elevation:"2",size:"large"},{default:t(()=>[S(" PAY "+A(F(se).format(F(o).total)),1)]),_:1},8,["disabled","loading"])])]),e(ci,{modelValue:d.value,"onUpdate:modelValue":y[2]||(y[2]=n=>d.value=n),onPaymentComplete:_},null,8,["modelValue"])]),_:1}))}},yi=Te(vi,[["__scopeId","data-v-aecde775"]]),gi={__name:"ReferenceDialog",props:{modelValue:Boolean},emits:["update:modelValue","confirm"],setup(a,{emit:o}){const r=a,i=o,d=D(""),b=te({get:()=>r.modelValue,set:I=>i("update:modelValue",I)}),f=()=>{b.value=!1,d.value=""},m=()=>{d.value&&(i("confirm",d.value),f())};return(I,c)=>($(),re(ze,{modelValue:b.value,"onUpdate:modelValue":c[1]||(c[1]=u=>b.value=u),"max-width":"400"},{default:t(()=>[e(Pe,null,{default:t(()=>[e(ft,null,{default:t(()=>c[2]||(c[2]=[S("Enter Reference Number")])),_:1}),e(ke,null,{default:t(()=>[e(Se,{modelValue:d.value,"onUpdate:modelValue":c[0]||(c[0]=u=>d.value=u),label:"Reference Number",rules:[u=>!!u||"Reference number is required"],required:"",density:"compact"},null,8,["modelValue","rules"])]),_:1}),e(st,null,{default:t(()=>[e(Ne),e(Q,{color:"grey",variant:"text",onClick:f},{default:t(()=>c[3]||(c[3]=[S(" Cancel ")])),_:1}),e(Q,{color:"primary",disabled:!d.value,onClick:m},{default:t(()=>c[4]||(c[4]=[S(" Hold Order ")])),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}};function _i(){const a=He(),o=rt(),r=D(!1),i=D(null);return{showReferenceDialog:r,error:i,confirmHoldOrder:async m=>{if(m)try{const I=a.prepareHoldInvoiceData(o.selectedStore,o.selectedCashier,m);await Ft.createHoldInvoice(I),a.clearCart()}catch(I){throw i.value=I.message,s.error("Failed to create hold invoice:",I),I}},printOrder:async(m=null)=>{try{if(m)await Ft.printOrder(m);else{const I={items:a.items,total:a.total,subtotal:a.subtotal,tax:a.taxAmount},c=await Ft.submitOrder(I);await Ft.printOrder(c.invoice.id)}}catch(I){throw i.value=I.message,s.error("Failed to print order:",I),I}},submitOrder:()=>{r.value=!0}}}function bi(){const a=D(null),o=D(!1),r=(d,b="")=>{const f=d.message||"An unexpected error occurred";return a.value=f,s.error(`Error in ${b}:`,d),f},i=()=>{a.value=null};return we(o,d=>{d&&i()}),{error:a,loading:o,handleError:r,clearError:i}}const hi={class:"cart-container"},wi={class:"products-container"},Ii={__name:"PosView",setup(a){const o=rt(),r=Ja(),i=Xa();D(!1),te(()=>i.path==="/customer-display");const{showReferenceDialog:d,confirmHoldOrder:b,printOrder:f,submitOrder:m}=_i(),{error:I,loading:c,clearError:u}=bi();async function g(){try{if(s.startGroup("POS View: Initializing"),s.info("Starting POS initialization"),!o.isConfigured){r.push("/select-cashier");return}s.info("POS initialization complete:",{isConfigured:o.isConfigured,selectedCustomer:o.selectedCustomer,selectedStore:o.selectedStore,selectedCashier:o.selectedCashier})}catch(_){s.error("Failed to initialize POS view:",_),I.value="Failed to initialize POS. Please try refreshing the page."}finally{s.endGroup()}}return wt(async()=>{await g();try{await no.openCustomerDisplay()||s.warn("Failed to open customer display on secondary screen")}catch(_){s.error("Error opening customer display:",_)}}),(_,V)=>($(),re(Za,{class:je(["pos-layout fill-height",{"mobile-layout":_.$vuetify.display.smAndDown}])},{default:t(()=>[F(I)?($(),re(at,{key:0,type:"error",closable:"",class:"ma-4","onClick:close":F(u)},{default:t(()=>[S(A(F(I)),1)]),_:1},8,["onClick:close"])):ve("",!0),F(o).isConfigured?($(),ee(xe,{key:1},[e(eo,{class:"pos-main pa-0"},{default:t(()=>[e(ot,{fluid:"",class:"fill-height pos-container"},{default:t(()=>[e(de,{"no-gutters":"",class:"fill-height",style:{width:"100%",margin:"0"}},{default:t(()=>[e(ae,{cols:"12",sm:"12",md:"5",lg:"4",xl:"3",class:je(["pos-cart border-r",{"pos-cart-mobile":_.$vuetify.display.smAndDown}])},{default:t(()=>[l("div",hi,[e(ss)])]),_:1},8,["class"]),e(ae,{cols:"12",sm:"12",md:"7",lg:"8",xl:"9",class:je(["pos-products",{"pos-products-mobile":_.$vuetify.display.smAndDown}])},{default:t(()=>[l("div",wi,[e(Fs)])]),_:1},8,["class"])]),_:1})]),_:1})]),_:1}),e(yi,{onPrintOrder:F(f),onSubmitOrder:F(m)},null,8,["onPrintOrder","onSubmitOrder"])],64)):ve("",!0),e(gi,{modelValue:F(d),"onUpdate:modelValue":V[0]||(V[0]=y=>Et(d)?d.value=y:null),onConfirm:F(b)},null,8,["modelValue","onConfirm"]),e(wa,{"model-value":F(c),class:"align-center justify-center"},{default:t(()=>[e(lt,{size:"64",color:"primary",indeterminate:""})]),_:1},8,["model-value"])]),_:1},8,["class"]))}},Di=Te(Ii,[["__scopeId","data-v-62a73d74"]]);export{Di as default};
//# sourceMappingURL=PosView-c6e4f4ec.js.map
