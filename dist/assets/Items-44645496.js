import{u as se}from"./pos-store-88069aeb.js";import{o as ce,n as d,e as A,l as q,y as W,z as ne,m as w,h as ue,i as pe,c as oe,d as S,j as R,p as fe,A as ve,x as X,B as de,g as ge,v as ye,w as me,_ as Ve,C as _e,D as be,E as Ie,F as ie,G as we,H as ke}from"./index-9f2fee20.js";import{r as y,d as Ce,j as H,w as xe,c3 as he,L as f,bg as $,F as l,N as a,u as c,M as x,be as m,bl as B,bh as I,bi as De,bj as P,X as Y,H as Fe,bk as Se}from"./vuetify-7130618d.js";import"./cart-store-98b500d5.js";const Ue={class:"d-flex align-center mb-2"},Ne={class:"d-flex justify-end pa-2"},Pe={class:"text-center"},je={__name:"ItemManagementModal",props:{modelValue:{type:Boolean,default:!1},editItem:{type:Object,default:null}},emits:["update:modelValue","item-saved","error"],async setup(Z,{emit:u}){var o,i;let U,V;const p=y(null),v=ce(),z=Z,D=u,b=se(),h=y(null),T=y(null),j=y(!1),g=y(null),k={required:n=>!!n||"This field is required",numeric:n=>!isNaN(parseFloat(n))&&isFinite(n)||"Must be a number"},t=Ce({name:"",sku:"",description:"",price:"",category_id:null,stock_level:0,reorder_level:0,image:null}),N=H({get:()=>z.modelValue,set:n=>D("update:modelValue",n)}),C=H(()=>z.editItem),J=H(()=>b.categoriesForDisplay);xe(()=>z.editItem,n=>{n&&(Object.keys(t).forEach(e=>{e==="price"?t[e]=(n[e]/100).toFixed(2):t[e]=n[e]||t[e]}),n.media&&n.media.length>0&&(t.image=n.media[0].original_url))},{immediate:!0});function G(){T.value.click()}async function K(n){const e=n.target.files[0];if(!e){d.error("No file selected");return}try{if(d.debug("File selected:",{name:e.name,type:e.type,size:e.size}),!e.type.startsWith("image/"))throw new Error("Please select an image file");fileObject.value=e;const s=new FileReader;s.onload=M=>{const E=M.target.result;d.debug("Image loaded:",{resultLength:E.length,hasData:!!E}),g.value=E},s.onerror=M=>{throw d.error("FileReader error:",M),new Error("Failed to read image file")},s.readAsDataURL(e)}catch(s){d.error("Failed to handle image upload:",s),p.value=s.message||"Failed to handle image upload"}}if(fileObject.value&&g.value)try{d.debug("Preparing image upload:",{fileName:fileObject.value.name,itemId:itemResponse.item.id,hasPreviewImage:!!g.value});const n=g.value.split(",")[1],e={picture:JSON.stringify({name:fileObject.value.name,data:n,item_id:itemResponse.item.id})};d.debug("Picture data prepared:",{hasName:!!e.picture.name,hasData:!!e.picture.data,itemId:e.picture.item_id});const s=([U,V]=he(()=>b.uploadItemPicture(e)),U=await U,V(),U);if(s.success)(o=window.toastr)==null||o.success("Image uploaded successfully"),d.info("Image upload successful for item:",itemResponse.item.id);else throw d.error("Image upload response indicated failure:",s),new Error("Image upload failed")}catch(n){d.error("Image upload error:",{error:n,itemId:itemResponse.item.id,fileName:fileObject.value.name}),(i=window.toastr)==null||i.error("Failed to upload image: "+(n.message||"Unknown error"))}function Q(){t.image=null,g.value=null,T.value.value=""}async function L(){var e,s,M,E,ee,le,ae,te,re;if(!h.value)return;const{valid:n}=await h.value.validate();if(n){if(!v.selectedStore){p.value="No store selected. Please select a store first.";return}j.value=!0;try{const O={name:t.name,description:t.description||"",price:Math.round(parseFloat(t.price)*100),unit_id:(e=t.unit)==null?void 0:e.id,item_category_id:t.category_id,unit:t.unit,sku:t.sku,allow_pos:!0,avalara_bool:!1,avalara_discount_type:{name:"None",value:"0"},avalara_sale_type:{name:"Retail",value:"Retail"},avalara_service_type:null,avalara_service_type_name:"",avalara_service_types:[],avalara_type:null,no_taxable:!1,retentions:null,retentions_bool:!1,tax_inclusion:!1,taxes:[],item_categories:[{id:t.category_id,name:((s=b.categories.find(F=>F.item_category_id===t.category_id))==null?void 0:s.name)||"",is_group:1,is_item:1}],item_groups:[],item_section:[],item_store:[{id:v.selectedStore,name:((M=v.storesForDisplay.find(F=>F.value===v.selectedStore))==null?void 0:M.title)||"",company_name:((E=v.currentCustomer)==null?void 0:E.name)||"xyz",description:""}]};let _;if(C.value?_=await b.updateItem(C.value.id,O):_=await b.createItem(O),!((ee=_==null?void 0:_.item)!=null&&ee.id))throw new Error("Failed to get item ID from response");if(fileObject.value&&g.value)try{const F={picture:JSON.stringify({name:fileObject.value.name,data:g.value,item_id:_.item.id})};if(d.debug("Attempting to upload picture:",{itemId:_.item.id,fileName:fileObject.value.name,hasData:!!g.value}),(await b.uploadItemPicture(F)).success)(le=window.toastr)==null||le.success("Image uploaded successfully"),d.info("Image upload successful for item:",_.item.id);else throw new Error("Image upload failed")}catch(F){(ae=window.toastr)==null||ae.error("Failed to upload image: "+(F.message||"Unknown error")),d.error("Image upload failed:",{error:F,itemId:_.item.id,fileName:fileObject.value.name})}(te=window.toastr)==null||te.success(C.value?"Item updated successfully":"Item created successfully"),d.info(`Item ${C.value?"updated":"created"} successfully:`,{itemId:_.item.id,name:_.item.name}),D("item-saved",_),r()}catch(O){(re=window.toastr)==null||re.error(O.message||"Failed to save item"),d.error("Failed to save item:",{error:O,formData:t,isEdit:!!C.value}),p.value=O.message||"Failed to save item"}finally{j.value=!1}}}function r(){var n;N.value=!1,(n=h.value)==null||n.reset(),g.value=null,p.value=null,Object.keys(t).forEach(e=>{t[e]=e==="stock_level"||e==="reorder_level"?0:""}),D("update:modelValue",!1)}return(n,e)=>(f(),$(Y,null,[l(W,{modelValue:N.value,"onUpdate:modelValue":e[0]||(e[0]=s=>N.value=s),"max-width":"800",persistent:"","onClick:outside":r},{default:a(()=>[l(A,null,{default:a(()=>[c(v).selectedStore?B("",!0):(f(),x(q,{key:0,type:"warning",variant:"tonal",class:"ma-4"},{default:a(()=>e[10]||(e[10]=[m(" Please select a store before creating new items. ")])),_:1}))]),_:1})]),_:1},8,["modelValue"]),p.value?(f(),x(q,{key:0,type:"error",variant:"tonal",closable:"",class:"mb-4","onClick:close":e[1]||(e[1]=s=>p.value=null)},{default:a(()=>[m(I(p.value),1)]),_:1})):B("",!0),l(W,{modelValue:N.value,"onUpdate:modelValue":e[9]||(e[9]=s=>N.value=s),"max-width":"800",persistent:"","onClick:outside":r},{default:a(()=>[l(A,null,{default:a(()=>[l(ne,{class:"d-flex justify-space-between align-center"},{default:a(()=>[m(I(C.value?"Edit Item":"New Item")+" ",1),l(w,{icon:"mdi-close",variant:"text",onClick:r})]),_:1}),l(ue,null,{default:a(()=>[l(pe,{ref_key:"form",ref:h,onSubmit:De(L,["prevent"])},{default:a(()=>[l(oe,null,{default:a(()=>[l(S,{cols:"12",md:"6"},{default:a(()=>[l(R,{modelValue:t.name,"onUpdate:modelValue":e[2]||(e[2]=s=>t.name=s),label:"Item Name",rules:[k.required],density:"comfortable",variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(S,{cols:"12",md:"6"},{default:a(()=>[l(R,{modelValue:t.sku,"onUpdate:modelValue":e[3]||(e[3]=s=>t.sku=s),label:"SKU",rules:[k.required],density:"comfortable",variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(S,{cols:"12",md:"6"},{default:a(()=>[l(R,{modelValue:t.price,"onUpdate:modelValue":e[4]||(e[4]=s=>t.price=s),label:"Price",type:"number",prefix:"$",rules:[k.required,k.numeric],density:"comfortable",variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(S,{cols:"12",md:"6"},{default:a(()=>[l(fe,{modelValue:t.category_id,"onUpdate:modelValue":e[5]||(e[5]=s=>t.category_id=s),items:J.value,"item-title":"name","item-value":"id",label:"Category",rules:[k.required],density:"comfortable",variant:"outlined"},null,8,["modelValue","items","rules"])]),_:1}),l(S,{cols:"12",md:"6"},{default:a(()=>[l(R,{modelValue:t.stock_level,"onUpdate:modelValue":e[6]||(e[6]=s=>t.stock_level=s),label:"Stock Level",type:"number",rules:[k.required,k.numeric],density:"comfortable",variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(S,{cols:"12",md:"6"},{default:a(()=>[l(R,{modelValue:t.reorder_level,"onUpdate:modelValue":e[7]||(e[7]=s=>t.reorder_level=s),label:"Reorder Level",type:"number",rules:[k.numeric],density:"comfortable",variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(S,{cols:"12"},{default:a(()=>[l(ve,{modelValue:t.description,"onUpdate:modelValue":e[8]||(e[8]=s=>t.description=s),label:"Description",rows:"3",density:"comfortable",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),l(oe,null,{default:a(()=>[l(S,{cols:"12"},{default:a(()=>[P("div",Ue,[e[12]||(e[12]=P("h3",{class:"text-subtitle-1"},"Item Image",-1)),l(X),l(w,{color:"primary","prepend-icon":"mdi-camera",variant:"text",onClick:G},{default:a(()=>e[11]||(e[11]=[m(" Upload Image ")])),_:1})]),P("input",{ref_key:"fileInput",ref:T,type:"file",accept:"image/*",class:"d-none",onChange:K},null,544),t.image||g.value?(f(),x(A,{key:0,variant:"outlined",class:"pa-2"},{default:a(()=>[l(de,{src:g.value||t.image,height:"200",cover:"",class:"bg-grey-lighten-2"},null,8,["src"]),P("div",Ne,[l(w,{color:"error",variant:"text",size:"small",onClick:Q},{default:a(()=>e[13]||(e[13]=[m(" Remove ")])),_:1})])]),_:1})):(f(),x(A,{key:1,variant:"outlined",class:"d-flex align-center justify-center",height:"200",style:{cursor:"pointer"},onClick:G},{default:a(()=>[P("div",Pe,[l(ge,{size:"48",color:"grey"},{default:a(()=>e[14]||(e[14]=[m("mdi-image-plus")])),_:1}),e[15]||(e[15]=P("div",{class:"text-grey mt-2"},"Click to add image",-1))])]),_:1}))]),_:1})]),_:1})]),_:1},512)]),_:1}),l(ye),l(me,null,{default:a(()=>[l(X),l(w,{color:"error",variant:"text",disabled:j.value,onClick:r},{default:a(()=>e[16]||(e[16]=[m(" Cancel ")])),_:1},8,["disabled"]),l(w,{color:"primary",loading:j.value,onClick:L},{default:a(()=>[m(I(C.value?"Update":"Create")+" Item ",1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}};const Me={class:"items-management pa-4"},Ee={class:"d-flex gap-2 mb-4"},Oe={key:1,class:"d-flex justify-center ma-4"},Re={key:4,class:"d-flex justify-center mt-4"},$e={__name:"Items",setup(Z){const u=se(),U=y(u.selectedCategory),V=y(null),p=y([]),v=y(!1),z=y(!1),D=y(!1),b=y(null),h=y(null),T=[{title:"Image",key:"image",sortable:!1},{title:"Name",key:"name",sortable:!0},{title:"SKU",key:"sku",sortable:!0},{title:"Price",key:"price",sortable:!0},{title:"Stock",key:"stock",sortable:!0},{title:"Actions",key:"actions",sortable:!1,align:"end"}],j=H(()=>p.value.length>0&&!b.value),g=r=>r?(Number(r)/100).toFixed(2):"0.00",k=r=>r.media&&r.media.length>0&&r.media[0].original_url?r.media[0].original_url:r.picture?r.picture:"/api/placeholder/400/320";Fe(async()=>{d.startGroup("Items Management: Mount");try{await u.initialize()}catch(r){d.error("Error during initialization",r),V.value=r.message||"Failed to initialize"}finally{d.endGroup()}});const t=async()=>{d.startGroup("Items Management: Search");try{await u.fetchProducts()}catch(r){d.error("Search failed",r),V.value=r.message||"Search failed"}finally{d.endGroup()}},N=async r=>{d.startGroup("Items Management: Category Change");try{await u.setCategory(r)}catch(o){d.error("Category change failed",o),V.value=o.message||"Failed to change category"}finally{d.endGroup()}},C=(r=null)=>{b.value=r,D.value=!0,V.value=null},J=async r=>{d.info("Item saved:",r),D.value=!1,b.value=null,await u.fetchProducts()},G=r=>{V.value=r},K=r=>{h.value=r,v.value=!0},Q=()=>{h.value=null,v.value=!0},L=async()=>{try{j.value?(await u.deleteMultipleItems(p.value),p.value=[]):await u.deleteItem(h.value.id),v.value=!1,h.value=null}catch(r){d.error("Delete operation failed:",r),V.value=r.message||"Failed to delete item(s)"}};return(r,o)=>(f(),$("div",Me,[c(u).systemReady?(f(),$(Y,{key:1},[V.value?(f(),x(q,{key:0,type:"error",class:"mb-4",closable:"","onClick:close":o[0]||(o[0]=i=>V.value=null)},{default:a(()=>[m(I(V.value),1)]),_:1})):B("",!0),P("div",Ee,[l(R,{modelValue:c(u).searchQuery,"onUpdate:modelValue":[o[1]||(o[1]=i=>c(u).searchQuery=i),t],"prepend-inner-icon":"mdi-magnify",label:"Search items",density:"compact","hide-details":"",class:"flex-grow-1"},null,8,["modelValue"]),l(w,{color:"success","prepend-icon":"mdi-plus",onClick:o[2]||(o[2]=i=>C())},{default:a(()=>o[9]||(o[9]=[m(" New Item ")])),_:1}),p.value.length>0?(f(),x(w,{key:0,color:"error","prepend-icon":"mdi-delete",onClick:Q},{default:a(()=>[m(" Delete ("+I(p.value.length)+") ",1)]),_:1})):B("",!0)]),l(_e,{modelValue:U.value,"onUpdate:modelValue":[o[3]||(o[3]=i=>U.value=i),N],density:"compact",class:"mb-4","show-arrows":""},{default:a(()=>[l(ie,{value:"all"},{default:a(()=>o[10]||(o[10]=[m("All Items")])),_:1}),(f(!0),$(Y,null,Se(c(u).categoriesForDisplay,i=>(f(),x(ie,{key:i.id,value:i.id},{default:a(()=>[m(I(i.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),c(u).loading.products?(f(),$("div",Oe,[l(we,{indeterminate:"",color:"primary"})])):c(u).error?(f(),x(q,{key:2,type:"error",class:"ma-4"},{default:a(()=>[m(I(c(u).error),1)]),_:1})):(f(),x(be,{key:3,modelValue:p.value,"onUpdate:modelValue":o[4]||(o[4]=i=>p.value=i),headers:T,items:c(u).products,loading:c(u).loading.products,"show-select":""},{"item.image":a(({item:i})=>[l(de,{src:k(i),width:"50",height:"50",cover:"",class:"bg-grey-lighten-2"},null,8,["src"])]),"item.price":a(({item:i})=>[m(" $"+I(g(i.price)),1)]),"item.stock":a(({item:i})=>[l(ke,{color:i.stock>0?"success":"error",size:"small"},{default:a(()=>[m(I(i.stock),1)]),_:2},1032,["color"])]),"item.actions":a(({item:i})=>[l(w,{icon:"mdi-pencil",size:"small",color:"primary",variant:"text",onClick:n=>C(i)},null,8,["onClick"]),l(w,{icon:"mdi-delete",size:"small",color:"error",variant:"text",onClick:n=>K(i)},null,8,["onClick"])]),_:1},8,["modelValue","items","loading"])),c(u).products.length>0?(f(),$("div",Re,[l(Ie,{modelValue:c(u).currentPage,"onUpdate:modelValue":[o[5]||(o[5]=i=>c(u).currentPage=i),c(u).setPage],length:Math.ceil(c(u).totalItems/c(u).itemsPerPage)},null,8,["modelValue","length","onUpdate:modelValue"])])):B("",!0)],64)):(f(),x(q,{key:0,type:"warning",class:"mb-4"},{default:a(()=>[m(I(c(u).setupMessage),1)]),_:1})),l(je,{modelValue:D.value,"onUpdate:modelValue":o[6]||(o[6]=i=>D.value=i),"edit-item":b.value,onItemSaved:J,onError:G},null,8,["modelValue","edit-item"]),l(W,{modelValue:v.value,"onUpdate:modelValue":o[8]||(o[8]=i=>v.value=i),"max-width":"400"},{default:a(()=>[l(A,null,{default:a(()=>[l(ne,null,{default:a(()=>o[11]||(o[11]=[m("Confirm Delete")])),_:1}),l(ue,null,{default:a(()=>[m(" Are you sure you want to delete "+I(z.value?`${p.value.length} items`:"this item")+"? This action cannot be undone. ",1)]),_:1}),l(me,null,{default:a(()=>[l(X),l(w,{color:"grey",variant:"text",onClick:o[7]||(o[7]=i=>v.value=!1)},{default:a(()=>o[12]||(o[12]=[m(" Cancel ")])),_:1}),l(w,{color:"error",loading:c(u).loading.itemOperation,onClick:L},{default:a(()=>o[13]||(o[13]=[m(" Delete ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},Ge=Ve($e,[["__scopeId","data-v-cdc3dfba"]]);export{Ge as default};
//# sourceMappingURL=Items-44645496.js.map
